{% extends "base.html" %}

{% block title %}Support TGFX Trade Lab - Donations{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="text-center">
            <h1 class="text-gradient-primary mb-3">
                <span class="material-symbols-outlined me-2" style="font-size: 2.5rem;">volunteer_activism</span>
                Support Our Mission
            </h1>
            <p class="text-muted mb-0 lead">Help us create better trading education for everyone</p>
        </div>
    </div>
</div>

<!-- Impact Section -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <h3 class="text-gradient-primary mb-4">Your Support Makes a Difference</h3>
                <div class="row">
                    <div class="col-md-3 mb-4">
                        <span class="material-symbols-outlined text-success mb-3" style="font-size: 3rem;">school</span>
                        <h4 class="text-white">Free Education</h4>
                        <p class="text-muted">Keep quality trading education accessible to everyone</p>
                    </div>
                    <div class="col-md-3 mb-4">
                        <span class="material-symbols-outlined text-success mb-3" style="font-size: 3rem;">video_library</span>
                        <h4 class="text-white">More Content</h4>
                        <p class="text-muted">Fund new video production and advanced course materials</p>
                    </div>
                    <div class="col-md-3 mb-4">
                        <span class="material-symbols-outlined text-success mb-3" style="font-size: 3rem;">groups</span>
                        <h4 class="text-white">Community Growth</h4>
                        <p class="text-muted">Support community features and interactive learning tools</p>
                    </div>
                    <div class="col-md-3 mb-4">
                        <span class="material-symbols-outlined text-success mb-3" style="font-size: 3rem;">trending_up</span>
                        <h4 class="text-white">Platform Improvement</h4>
                        <p class="text-muted">Enhance user experience and add new features</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Donation Options -->
<div class="row justify-content-center mb-5">
    <!-- Quick Donation Amounts -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header text-center">
                <h3 class="text-gradient-primary mb-2">
                    <span class="material-symbols-outlined me-2">favorite</span>
                    Make a Donation
                </h3>
                <p class="text-muted mb-0">Choose an amount or enter a custom value</p>
            </div>
            <div class="card-body">
                <!-- Preset Amounts -->
                <div class="row mb-4">
                    <div class="col-6 col-md-3 mb-3">
                        <button class="btn btn-outline-primary w-100 donation-btn h-100" data-amount="5">
                            <div class="py-2">
                                <div class="h4 mb-1">$5</div>
                                <small class="text-muted">Coffee Fund</small>
                            </div>
                        </button>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <button class="btn btn-outline-primary w-100 donation-btn h-100" data-amount="15">
                            <div class="py-2">
                                <div class="h4 mb-1">$15</div>
                                <small class="text-muted">Lunch Support</small>
                            </div>
                        </button>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <button class="btn btn-outline-primary w-100 donation-btn h-100" data-amount="50">
                            <div class="py-2">
                                <div class="h4 mb-1">$50</div>
                                <small class="text-muted">Video Production</small>
                            </div>
                        </button>
                    </div>
                    <div class="col-6 col-md-3 mb-3">
                        <button class="btn btn-outline-primary w-100 donation-btn h-100" data-amount="100">
                            <div class="py-2">
                                <div class="h4 mb-1">$100</div>
                                <small class="text-muted">Super Supporter</small>
                            </div>
                        </button>
                    </div>
                </div>
                
                <!-- Custom Amount -->
                <div class="row mb-4">
                    <div class="col-md-6 mx-auto">
                        <label class="form-label">Custom Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="customAmount" 
                                   placeholder="Enter amount" min="1" max="10000">
                        </div>
                        <div class="form-text">Minimum $1, Maximum $10,000</div>
                    </div>
                </div>
                
                <!-- Donation Frequency -->
                <div class="row mb-4">
                    <div class="col-md-6 mx-auto">
                        <label class="form-label">Donation Type</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="frequency" id="oneTime" value="one-time" checked>
                            <label class="btn btn-outline-secondary" for="oneTime">One-Time</label>
                            
                            <input type="radio" class="btn-check" name="frequency" id="monthly" value="monthly">
                            <label class="btn btn-outline-secondary" for="monthly">Monthly</label>
                        </div>
                    </div>
                </div>
                
                <!-- Donor Information (Optional) -->
                <div class="row mb-4">
                    <div class="col-md-8 mx-auto">
                        <div class="card bg-transparent border-secondary">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <span class="material-symbols-outlined me-2">person</span>
                                    Donor Information (Optional)
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="donorName" 
                                               placeholder="Your name" value="{{ current_user.username if current_user.is_authenticated }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" class="form-control" id="donorEmail" 
                                               placeholder="your@email.com" value="{{ current_user.email if current_user.is_authenticated }}">
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Message (Optional)</label>
                                    <textarea class="form-control" id="donorMessage" rows="3" 
                                              placeholder="Leave a message of support..."></textarea>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="publicDonor">
                                    <label class="form-check-label" for="publicDonor">
                                        Display my name on the supporters list
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Donate Button -->
                <div class="text-center">
                    <button class="btn btn-primary btn-lg" id="donateBtn" onclick="processDonation()">
                        <span class="material-symbols-outlined me-2">volunteer_activism</span>
                        Donate Now
                    </button>
                    <p class="text-muted small mt-2 mb-0">
                        <span class="material-symbols-outlined me-1" style="font-size: 16px;">security</span>
                        Secure payment processing by Stripe
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Supporters -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="text-gradient-primary mb-0">
                    <span class="material-symbols-outlined me-2">emoji_people</span>
                    Recent Supporters
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Sample supporters (in real app, this would come from database) -->
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="d-flex align-items-center p-3 border border-secondary rounded">
                            <div class="user-avatar me-3" style="width: 50px; height: 50px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                A
                            </div>
                            <div>
                                <h6 class="text-white mb-1">Anonymous Donor</h6>
                                <p class="text-muted small mb-1">Donated $25</p>
                                <p class="text-muted small mb-0">"Keep up the great work!"</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="d-flex align-items-center p-3 border border-secondary rounded">
                            <div class="user-avatar me-3" style="width: 50px; height: 50px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                J
                            </div>
                            <div>
                                <h6 class="text-white mb-1">John T.</h6>
                                <p class="text-muted small mb-1">Donated $50</p>
                                <p class="text-muted small mb-0">"Excellent educational content!"</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="d-flex align-items-center p-3 border border-secondary rounded">
                            <div class="user-avatar me-3" style="width: 50px; height: 50px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                S
                            </div>
                            <div>
                                <h6 class="text-white mb-1">Sarah M.</h6>
                                <p class="text-muted small mb-1">Monthly Supporter - $15</p>
                                <p class="text-muted small mb-0">"Love the community!"</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="d-flex align-items-center p-3 border border-secondary rounded">
                            <div class="user-avatar me-3" style="width: 50px; height: 50px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                M
                            </div>
                            <div>
                                <h6 class="text-white mb-1">Mike R.</h6>
                                <p class="text-muted small mb-1">Donated $100</p>
                                <p class="text-muted small mb-0">"Happy to support the mission!"</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="d-flex align-items-center p-3 border border-secondary rounded">
                            <div class="user-avatar me-3" style="width: 50px; height: 50px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                L
                            </div>
                            <div>
                                <h6 class="text-white mb-1">Lisa K.</h6>
                                <p class="text-muted small mb-1">Donated $30</p>
                                <p class="text-muted small mb-0">"Great learning platform!"</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="d-flex align-items-center p-3 border border-secondary rounded">
                            <div class="user-avatar me-3" style="width: 50px; height: 50px; background: var(--gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                +
                            </div>
                            <div>
                                <h6 class="text-white mb-1">Your Name Here</h6>
                                <p class="text-muted small mb-1">Be our next supporter!</p>
                                <p class="text-muted small mb-0">"Your message here..."</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <p class="text-muted">
                        <strong class="text-success">$1,247</strong> raised from <strong class="text-success">23</strong> supporters this month
                    </p>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar" style="width: 42%"></div>
                    </div>
                    <p class="text-muted small mt-2">Goal: $3,000/month</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Other Ways to Support -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="text-gradient-primary mb-0">
                    <span class="material-symbols-outlined me-2">handshake</span>
                    Other Ways to Support
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="text-center">
                            <span class="material-symbols-outlined text-primary mb-3" style="font-size: 3rem;">share</span>
                            <h5 class="text-white">Share & Recommend</h5>
                            <p class="text-muted">Tell your friends about TGFX Trade Lab and help us grow the community</p>
                            <div class="d-flex gap-2 justify-content-center">
                                <button class="btn btn-outline-primary btn-sm">
                                    <span class="material-symbols-outlined me-1" style="font-size: 16px;">share</span>
                                    Share
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-4">
                        <div class="text-center">
                            <span class="material-symbols-outlined text-primary mb-3" style="font-size: 3rem;">rate_review</span>
                            <h5 class="text-white">Leave a Review</h5>
                            <p class="text-muted">Write a review on social media or trading forums to help others discover us</p>
                            <div class="d-flex gap-2 justify-content-center">
                                <button class="btn btn-outline-primary btn-sm">
                                    <span class="material-symbols-outlined me-1" style="font-size: 16px;">star</span>
                                    Review
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-4">
                        <div class="text-center">
                            <span class="material-symbols-outlined text-primary mb-3" style="font-size: 3rem;">workspace_premium</span>
                            <h5 class="text-white">Upgrade to Premium</h5>
                            <p class="text-muted">Subscribe to premium to support us while getting exclusive content</p>
                            <div class="d-flex gap-2 justify-content-center">
                                <a href="{{ url_for('subscription') }}" class="btn btn-primary btn-sm">
                                    <span class="material-symbols-outlined me-1" style="font-size: 16px;">upgrade</span>
                                    Upgrade
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stripe Payment Modal -->
<div class="modal fade" id="donationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-primary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-gradient-primary">
                    <span class="material-symbols-outlined me-2">volunteer_activism</span>
                    Complete Your Donation
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <h3 class="text-gradient-primary" id="donationAmount">$0</h3>
                    <p class="text-muted" id="donationFrequency">One-time donation</p>
                </div>
                
                <div id="payment-element">
                    <!-- Stripe Elements will be inserted here -->
                </div>
                
                <div class="text-center mt-3">
                    <p class="text-muted small mb-0">
                        <span class="material-symbols-outlined me-1" style="font-size: 16px;">lock</span>
                        Your payment information is secure and encrypted
                    </p>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submit-donation">
                    <span class="material-symbols-outlined me-2">volunteer_activism</span>
                    Complete Donation
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe('{{ stripe_key }}');
let elements;
let selectedAmount = 0;
let selectedFrequency = 'one-time';

// Handle preset amount selection
document.querySelectorAll('.donation-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // Remove active class from all buttons
        document.querySelectorAll('.donation-btn').forEach(b => {
            b.classList.remove('btn-primary');
            b.classList.add('btn-outline-primary');
        });
        
        // Add active class to clicked button
        this.classList.remove('btn-outline-primary');
        this.classList.add('btn-primary');
        
        // Clear custom amount
        document.getElementById('customAmount').value = '';
        
        // Set selected amount
        selectedAmount = parseInt(this.dataset.amount);
    });
});

// Handle custom amount input
document.getElementById('customAmount').addEventListener('input', function() {
    // Remove active class from preset buttons
    document.querySelectorAll('.donation-btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    
    selectedAmount = parseFloat(this.value) || 0;
});

// Handle frequency change
document.querySelectorAll('[name="frequency"]').forEach(radio => {
    radio.addEventListener('change', function() {
        selectedFrequency = this.value;
    });
});

function processDonation() {
    // Validate amount
    if (selectedAmount <= 0) {
        showToast('Please select or enter a donation amount', 'warning');
        return;
    }
    
    if (selectedAmount > 10000) {
        showToast('Maximum donation amount is $10,000', 'warning');
        return;
    }
    
    // Update modal display
    document.getElementById('donationAmount').textContent = '$' + selectedAmount.toFixed(2);
    document.getElementById('donationFrequency').textContent = 
        selectedFrequency === 'monthly' ? 'Monthly donation' : 'One-time donation';
    
    // Show payment modal
    const modal = new bootstrap.Modal(document.getElementById('donationModal'));
    modal.show();
    
    // Initialize Stripe Elements
    initializeStripeElements();
}

async function initializeStripeElements() {
    try {
        // Create elements instance
        elements = stripe.elements({
            appearance: {
                theme: 'night',
                variables: {
                    colorPrimary: '#10B981',
                    colorBackground: '#1a1a1a',
                    colorText: '#ffffff',
                    colorDanger: '#EF4444',
                    fontFamily: 'Inter, sans-serif',
                    borderRadius: '12px'
                }
            }
        });

        // Create and mount the payment element
        const paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');
        
    } catch (error) {
        console.error('Error initializing Stripe:', error);
        showToast('Error loading payment form', 'error');
    }
}

document.getElementById('submit-donation').addEventListener('click', async function() {
    if (!elements) {
        showToast('Payment form not loaded', 'error');
        return;
    }
    
    // Show loading state
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
    
    try {
        // Get donor information
        const donorName = document.getElementById('donorName').value;
        const donorEmail = document.getElementById('donorEmail').value;
        const donorMessage = document.getElementById('donorMessage').value;
        const isPublic = document.getElementById('publicDonor').checked;
        
        // In a real implementation, you would:
        // 1. Create a payment intent on your server
        // 2. Confirm the payment with Stripe
        // 3. Save the donation record
        // 4. Send thank you email
        
        // For demo purposes, we'll simulate success
        setTimeout(() => {
            showToast('Thank you for your generous donation!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('donationModal')).hide();
            
            // Reset form
            resetDonationForm();
            
            // Show thank you message
            showThankYouMessage();
        }, 2000);
        
    } catch (error) {
        console.error('Donation error:', error);
        showToast('Donation failed. Please try again.', 'error');
        
        // Reset button
        this.disabled = false;
        this.innerHTML = '<span class="material-symbols-outlined me-2">volunteer_activism</span>Complete Donation';
    }
});

function resetDonationForm() {
    selectedAmount = 0;
    selectedFrequency = 'one-time';
    
    // Reset preset buttons
    document.querySelectorAll('.donation-btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    
    // Clear inputs
    document.getElementById('customAmount').value = '';
    document.getElementById('oneTime').checked = true;
    document.getElementById('donorMessage').value = '';
    document.getElementById('publicDonor').checked = false;
}

function showThankYouMessage() {
    // Create a temporary thank you alert
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px; border-radius: 12px;';
    alert.innerHTML = `
        <div class="d-flex align-items-center">
            <span class="material-symbols-outlined me-2">favorite</span>
            <div>
                <strong>Thank you!</strong><br>
                Your donation helps keep quality trading education accessible to everyone.
            </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alert);
    
    // Auto remove after 8 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 8000);
}

// Add smooth animations
document.addEventListener('DOMContentLoaded', function() {
    // Animate cards
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Add hover effects to donation buttons
    document.querySelectorAll('.donation-btn').forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            if (!this.classList.contains('btn-primary')) {
                this.style.transform = 'translateY(-2px)';
                this.style.boxShadow = '0 8px 25px rgba(16, 185, 129, 0.2)';
            }
        });
        
        btn.addEventListener('mouseleave', function() {
            if (!this.classList.contains('btn-primary')) {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = 'none';
            }
        });
    });
});

// Add input validation
document.getElementById('customAmount').addEventListener('input', function() {
    const value = parseFloat(this.value);
    if (value > 10000) {
        this.value = 10000;
        showToast('Maximum donation amount is $10,000', 'warning');
    } else if (value < 0) {
        this.value = '';
    }
});

// Social sharing functions
function shareOnSocial(platform) {
    const url = encodeURIComponent(window.location.origin);
    const text = encodeURIComponent('Check out TGFX Trade Lab - Great trading education platform!');
    
    let shareUrl = '';
    switch(platform) {
        case 'twitter':
            shareUrl = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
            break;
        case 'facebook':
            shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
            break;
        case 'linkedin':
            shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
            break;
    }
    
    if (shareUrl) {
        window.open(shareUrl, '_blank', 'width=600,height=400');
    }
}
</script>
{% endblock %}