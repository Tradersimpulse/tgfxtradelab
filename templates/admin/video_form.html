{% extends "base.html" %}

{% block title %}{{ title }} - Admin - TGFX Trade Lab{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="text-gradient-primary mb-2">
                    <span class="material-symbols-outlined me-2" style="font-size: 2rem;">
                        {% if video %}edit{% else %}add{% endif %}
                    </span>
                    {{ title }}
                </h1>
                <p class="text-muted mb-0">
                    {% if video %}Update video information and settings{% else %}Add a new video to your course library{% endif %}
                </p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('admin_videos') }}" class="btn btn-outline-secondary">
                    <span class="material-symbols-outlined me-2">arrow_back</span>
                    Back to Videos
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Main Form -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2">info</span>
                    Video Information
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="videoForm">
                    {{ form.hidden_tag() }}
                    
                    <!-- Title -->
                    <div class="mb-4">
                        {{ form.title.label(class="form-label") }}
                        {{ form.title(class="form-control", placeholder="Enter video title") }}
                        {% if form.title.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.title.errors %}{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                        <div class="form-text">Choose a clear, descriptive title for your video</div>
                    </div>
                    
                    <!-- Category (moved under title) -->
                    <div class="mb-4">
                        {{ form.category_id.label(class="form-label") }}
                        {{ form.category_id(class="form-select") }}
                        {% if form.category_id.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.category_id.errors %}{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                        <div class="form-text">Select the category for this video</div>
                        
                        <!-- Auto-fill notification -->
                        <div id="autoFillNotification" class="alert alert-info mt-2" style="display: none;">
                            <span class="material-symbols-outlined me-2">auto_fix_high</span>
                            <strong>Auto-fill activated!</strong> Title has been automatically filled for Live Trading Session.
                            <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="clearAutoFill()">
                                Clear & Use Custom Title
                            </button>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-4">
                        {{ form.description.label(class="form-label") }}
                        {{ form.description(class="form-control", rows="4", placeholder="Describe what students will learn in this video...") }}
                        {% if form.description.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.description.errors %}{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                        <div class="form-text">Provide a detailed description of the video content</div>
                    </div>
                    
                    <!-- Tags -->
                    <div class="mb-4">
                        {{ form.tags.label(class="form-label") }}
                        {{ form.tags(class="form-control", placeholder="market structure, support resistance, price action") }}
                        {% if form.tags.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.tags.errors %}{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                        <div class="form-text">Enter tags separated by commas to help organize and filter your content</div>
                        
                        <!-- Suggested Tags -->
                        <div class="mt-2">
                            <label class="form-label small">Quick Tags:</label>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Market Structure">Market Structure</button>
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Support & Resistance">Support & Resistance</button>
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Price Action">Price Action</button>
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Risk Management">Risk Management</button>
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Psychology">Psychology</button>
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Technical Analysis">Technical Analysis</button>
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Chart Patterns">Chart Patterns</button>
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Trading Strategies">Trading Strategies</button>
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Live Session">Live Session</button>
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Live Trading">Live Trading</button>
                            </div>
                        </div>
                        
                        <!-- Current Tags Preview -->
                        <div class="mt-2" id="tagsPreview"></div>
                    </div>
                    
                    <!-- S3 URL -->
                    <div class="mb-4">
                        {{ form.s3_url.label(class="form-label") }}
                        {{ form.s3_url(class="form-control", placeholder="https://your-bucket.s3.region.amazonaws.com/video.mp4") }}
                        {% if form.s3_url.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.s3_url.errors %}{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                        <div class="form-text">Direct link to the video file stored in AWS S3</div>
                    </div>
                    
                    <!-- Thumbnail URL (now auto-generated info) -->
                    <div class="mb-4">
                        <label class="form-label">Thumbnail Generation</label>
                        <div class="alert alert-info">
                            <span class="material-symbols-outlined me-2">auto_awesome</span>
                            <strong>Automatic Thumbnail:</strong> 
                            Thumbnails will be automatically generated using the category background image with overlaid text.
                            No manual thumbnail URL needed!
                        </div>
                        
                        <!-- Hidden field for thumbnail URL -->
                        {{ form.thumbnail_url(type="hidden") }}
                        
                        <!-- Manual thumbnail override (optional) -->
                        <div class="collapse" id="manualThumbnailCollapse">
                            <label class="form-label">Manual Thumbnail Override (Optional)</label>
                            <input type="url" class="form-control" id="manualThumbnailUrl" 
                                   placeholder="https://your-bucket.s3.region.amazonaws.com/custom-thumbnail.jpg">
                            <div class="form-text">Only use this if you want to override the auto-generated thumbnail</div>
                        </div>
                        
                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2" 
                                data-bs-toggle="collapse" data-bs-target="#manualThumbnailCollapse">
                            <span class="material-symbols-outlined me-1" style="font-size: 16px;">settings</span>
                            Manual Thumbnail Override
                        </button>
                    </div>
                    
                    <!-- Settings Row -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            {{ form.order_index.label(class="form-label") }}
                            {{ form.order_index(class="form-control", placeholder="0") }}
                            {% if form.order_index.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.order_index.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">Lower numbers appear first</div>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <div class="form-check">
                                {{ form.is_free(class="form-check-input") }}
                                {{ form.is_free.label(class="form-check-label") }}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Buttons -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <span class="material-symbols-outlined me-2">save</span>
                            {% if video %}Update Video{% else %}Add Video{% endif %}
                        </button>
                        <a href="{{ url_for('admin_videos') }}" class="btn btn-outline-secondary">
                            Cancel
                        </a>
                        {% if video %}
                        <a href="{{ url_for('watch_video', video_id=video.id) }}" class="btn btn-outline-primary ms-auto">
                            <span class="material-symbols-outlined me-2">play_arrow</span>
                            Preview Video
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Video Preview -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <span class="material-symbols-outlined me-2">visibility</span>
                    Video Preview
                </h6>
            </div>
            <div class="card-body">
                <div class="video-preview">
                    <div class="thumbnail-preview mb-3" id="thumbnailPreview">
                        {% if video and video.thumbnail_url %}
                        <img src="{{ video.thumbnail_url }}" alt="Thumbnail" class="img-fluid rounded">
                        {% else %}
                        <div class="placeholder-thumbnail">
                            <span class="material-symbols-outlined">auto_awesome</span>
                            <p class="small mt-2">Auto-Generated Thumbnail</p>
                            <p class="small text-muted">Will be created with category background + overlaid text</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <h6 class="text-white mb-2" id="titlePreview">
                        {{ video.title if video else 'Video Title' }}
                    </h6>
                    
                    <p class="text-muted small mb-3" id="descriptionPreview">
                        {{ video.description if video and video.description else 'Video description will appear here...' }}
                    </p>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge" id="typePreview">
                            {% if video %}
                                {% if video.is_free %}Free{% else %}Premium{% endif %}
                            {% else %}
                                Free
                            {% endif %}
                        </span>
                        <small class="text-muted" id="categoryPreview">
                            {% if video %}{{ video.category.name }}{% else %}Category{% endif %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Live Trading Session Helper -->
        <div class="card mb-4" id="liveSessionHelper" style="display: none;">
            <div class="card-header">
                <h6 class="mb-0">
                    <span class="material-symbols-outlined me-2">live_tv</span>
                    Live Trading Session Helper
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label small">Trader:</label>
                    <div class="d-flex gap-2 mb-2">
                        <button type="button" class="btn btn-sm btn-outline-success trader-btn" data-trader="Ray" data-pair="EURUSD">
                            Ray (EURUSD)
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary trader-btn" data-trader="Jordan" data-pair="XAUUSD">
                            Jordan (XAUUSD)
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label small">Date:</label>
                    <input type="date" class="form-control form-control-sm" id="sessionDate" 
                           value="{{ datetime.now().strftime('%Y-%m-%d') }}">
                </div>
                
                <div class="mb-3">
                    <label class="form-label small">Trading Pair:</label>
                    <input type="text" class="form-control form-control-sm" id="tradingPair" placeholder="EURUSD">
                </div>
                
                <button type="button" class="btn btn-sm btn-primary w-100" onclick="generateLiveSessionTitle()">
                    <span class="material-symbols-outlined me-1" style="font-size: 16px;">auto_fix_high</span>
                    Generate Title
                </button>
            </div>
        </div>
        
        <!-- Video Guidelines -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <span class="material-symbols-outlined me-2">tips_and_updates</span>
                    Video Guidelines
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <span class="material-symbols-outlined me-2 text-success" style="font-size: 16px;">check_circle</span>
                        <small>Upload videos to S3 before adding them here</small>
                    </li>
                    <li class="mb-2">
                        <span class="material-symbols-outlined me-2 text-success" style="font-size: 16px;">check_circle</span>
                        <small>Thumbnails are auto-generated from category backgrounds</small>
                    </li>
                    <li class="mb-2">
                        <span class="material-symbols-outlined me-2 text-success" style="font-size: 16px;">check_circle</span>
                        <small>Live Trading Sessions have auto-fill titles</small>
                    </li>
                    <li class="mb-2">
                        <span class="material-symbols-outlined me-2 text-success" style="font-size: 16px;">check_circle</span>
                        <small>Add relevant tags to improve discoverability</small>
                    </li>
                    <li class="mb-0">
                        <span class="material-symbols-outlined me-2 text-success" style="font-size: 16px;">check_circle</span>
                        <small>Set proper order within categories</small>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Category Background Preview -->
        <div class="card" id="categoryBackgroundCard" style="display: none;">
            <div class="card-header">
                <h6 class="mb-0">
                    <span class="material-symbols-outlined me-2">image</span>
                    Category Background
                </h6>
            </div>
            <div class="card-body">
                <div id="categoryBackgroundPreview" class="text-center">
                    <div class="placeholder-thumbnail">
                        <span class="material-symbols-outlined">image</span>
                        <p class="small mt-2">Category Background</p>
                    </div>
                </div>
                <p class="text-muted small mt-2 mb-0">
                    This background will be used to generate the video thumbnail with overlaid text.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
let isAutoFilled = false;
let originalTitle = '';

// Auto-fill functionality for Live Trading Sessions
document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.querySelector('[name="category_id"]');
    const titleInput = document.querySelector('[name="title"]');
    
    // Store original title
    originalTitle = titleInput.value;
    
    // Check if Live Trading Sessions is initially selected
    checkForLiveSession();
    
    // Listen for category changes
    categorySelect.addEventListener('change', function() {
        checkForLiveSession();
        updateCategoryBackgroundPreview();
    });
    
    // Initialize preview
    updateTagsPreview();
    updateCategoryBackgroundPreview();
    
    // Auto-suggest order index
    const orderInput = document.querySelector('[name="order_index"]');
    if (orderInput && !orderInput.value) {
        orderInput.value = 0;
    }
});

function checkForLiveSession() {
    const categorySelect = document.querySelector('[name="category_id"]');
    const selectedOption = categorySelect.options[categorySelect.selectedIndex];
    const categoryName = selectedOption.text;
    const titleInput = document.querySelector('[name="title"]');
    const notification = document.getElementById('autoFillNotification');
    const helper = document.getElementById('liveSessionHelper');
    
    if (categoryName.includes('Live Trading Sessions') || categoryName.includes('Live Session')) {
        // Show helper
        helper.style.display = 'block';
        
        // Auto-fill title if not already auto-filled and field is empty or default
        if (!isAutoFilled && (titleInput.value === '' || titleInput.value === originalTitle)) {
            generateAutoFillTitle();
        }
    } else {
        // Hide helper
        helper.style.display = 'none';
        
        // If was auto-filled, clear it
        if (isAutoFilled) {
            clearAutoFill();
        }
    }
}

async function generateAutoFillTitle() {
    try {
        const response = await fetch('/api/admin/auto-fill-title', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        });
        
        if (response.ok) {
            const data = await response.json();
            const titleInput = document.querySelector('[name="title"]');
            titleInput.value = data.title;
            isAutoFilled = true;
            
            // Show notification
            const notification = document.getElementById('autoFillNotification');
            notification.style.display = 'block';
            
            // Update preview
            updateTitlePreview();
            
            // Auto-add tags
            const tagsInput = document.querySelector('[name="tags"]');
            const currentTags = tagsInput.value;
            const newTags = 'Live Session, Live Trading';
            
            if (!currentTags.includes('Live Session')) {
                if (currentTags.trim()) {
                    tagsInput.value = currentTags + ', ' + newTags;
                } else {
                    tagsInput.value = newTags;
                }
                updateTagsPreview();
            }
        }
    } catch (error) {
        console.error('Error generating auto-fill title:', error);
    }
}

function generateLiveSessionTitle() {
    const trader = document.querySelector('.trader-btn.active')?.dataset.trader || 'Trader';
    const date = document.getElementById('sessionDate').value;
    const pair = document.getElementById('tradingPair').value || 'EURUSD';
    
    if (date) {
        const dateObj = new Date(date);
        const formattedDate = String(dateObj.getMonth() + 1).padStart(2, '0') + '-' + 
                             String(dateObj.getDate()).padStart(2, '0') + '-' + 
                             String(dateObj.getFullYear()).slice(-2);
        
        const title = `${trader} - ${formattedDate} ${pair}`;
        document.querySelector('[name="title"]').value = title;
        isAutoFilled = true;
        
        // Show notification
        document.getElementById('autoFillNotification').style.display = 'block';
        updateTitlePreview();
    }
}

function clearAutoFill() {
    const titleInput = document.querySelector('[name="title"]');
    titleInput.value = '';
    isAutoFilled = false;
    
    // Hide notification
    const notification = document.getElementById('autoFillNotification');
    notification.style.display = 'none';
    
    updateTitlePreview();
}

function updateCategoryBackgroundPreview() {
    const categorySelect = document.querySelector('[name="category_id"]');
    const selectedCategoryId = categorySelect.value;
    const card = document.getElementById('categoryBackgroundCard');
    
    if (selectedCategoryId) {
        // You would fetch category background info here
        // For now, just show the card
        card.style.display = 'block';
    } else {
        card.style.display = 'none';
    }
}

// Trader selection for live sessions
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('trader-btn')) {
        // Remove active from all
        document.querySelectorAll('.trader-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Add active to clicked
        e.target.classList.add('active');
        
        // Update trading pair
        document.getElementById('tradingPair').value = e.target.dataset.pair;
    }
});

// Form submission with thumbnail generation
document.getElementById('videoForm').addEventListener('submit', function(e) {
    // Set manual thumbnail if provided
    const manualThumbnail = document.getElementById('manualThumbnailUrl');
    const hiddenThumbnail = document.querySelector('[name="thumbnail_url"]');
    
    if (manualThumbnail && manualThumbnail.value) {
        hiddenThumbnail.value = manualThumbnail.value;
    }
    
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving & Generating Thumbnail...';
});

// Live preview updates
const titleInput = document.querySelector('[name="title"]');
const descriptionInput = document.querySelector('[name="description"]');
const categorySelect = document.querySelector('[name="category_id"]');
const freeCheckbox = document.querySelector('[name="is_free"]');
const tagsInput = document.querySelector('[name="tags"]');

titleInput.addEventListener('input', updateTitlePreview);
descriptionInput.addEventListener('input', updateDescriptionPreview);
categorySelect.addEventListener('change', updateCategoryPreview);
freeCheckbox.addEventListener('change', updateTypePreview);
tagsInput.addEventListener('input', updateTagsPreview);

function updateTitlePreview() {
    document.getElementById('titlePreview').textContent = titleInput.value || 'Video Title';
}

function updateDescriptionPreview() {
    const preview = document.getElementById('descriptionPreview');
    const text = descriptionInput.value || 'Video description will appear here...';
    preview.textContent = text.length > 100 ? text.substring(0, 100) + '...' : text;
}

function updateCategoryPreview() {
    const selectedOption = categorySelect.options[categorySelect.selectedIndex];
    document.getElementById('categoryPreview').textContent = selectedOption.text || 'Category';
}

function updateTypePreview() {
    const preview = document.getElementById('typePreview');
    if (freeCheckbox.checked) {
        preview.textContent = 'Free';
        preview.className = 'badge bg-success';
    } else {
        preview.textContent = 'Premium';
        preview.className = 'badge bg-warning';
    }
}

function updateTagsPreview() {
    const tagsPreview = document.getElementById('tagsPreview');
    const tagsValue = tagsInput.value;
    
    if (!tagsValue.trim()) {
        tagsPreview.innerHTML = '';
        return;
    }
    
    const tags = tagsValue.split(',').map(tag => tag.trim()).filter(tag => tag);
    const previewHtml = tags.map(tag => 
        `<span class="badge bg-primary me-1 mb-1">${tag}</span>`
    ).join('');
    
    tagsPreview.innerHTML = `<div class="mt-2"><small class="text-muted">Preview:</small><br>${previewHtml}</div>`;
}

// Tag suggestion buttons
document.querySelectorAll('.tag-suggestion').forEach(button => {
    button.addEventListener('click', function() {
        const tag = this.dataset.tag;
        const currentTags = tagsInput.value;
        
        // Check if tag already exists
        const tagsList = currentTags.split(',').map(t => t.trim());
        if (!tagsList.includes(tag)) {
            if (currentTags.trim()) {
                tagsInput.value = currentTags + ', ' + tag;
            } else {
                tagsInput.value = tag;
            }
            updateTagsPreview();
        }
        
        // Visual feedback
        this.classList.add('btn-success');
        this.classList.remove('btn-outline-primary');
        setTimeout(() => {
            this.classList.remove('btn-success');
            this.classList.add('btn-outline-primary');
        }, 1000);
    });
});

// Character counters
titleInput.addEventListener('input', function() {
    const maxLength = 200;
    const currentLength = this.value.length;
    const formText = this.parentElement.querySelector('.form-text');
    
    if (currentLength > maxLength - 20) {
        formText.textContent = `${currentLength}/${maxLength} characters`;
        formText.className = currentLength > maxLength ? 'form-text text-danger' : 'form-text text-warning';
    } else {
        formText.textContent = 'Choose a clear, descriptive title for your video';
        formText.className = 'form-text';
    }
});
</script>

<style>
.video-preview {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.video-preview:hover {
    border-color: rgba(16, 185, 129, 0.3);
    background: rgba(255, 255, 255, 0.05);
}

.placeholder-thumbnail {
    background: var(--bg-secondary);
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    color: var(--text-muted);
}

.placeholder-thumbnail .material-symbols-outlined {
    font-size: 2rem;
    opacity: 0.5;
}

.form-control:focus,
.form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.15);
}

.tag-suggestion:hover {
    transform: translateY(-1px);
}

.trader-btn.active {
    background: var(--gradient-primary);
    color: white;
    border-color: var(--primary-color);
}

.alert-info {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.2);
    color: var(--primary-color);
}

#liveSessionHelper {
    border-left: 4px solid var(--primary-color);
}

#autoFillNotification {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.card:hover {
    border-color: rgba(16, 185, 129, 0.2);
}

.btn:hover {
    transform: translateY(-1px);
}
</style>
{% endblock %}
