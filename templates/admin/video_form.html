{% extends "base.html" %}

{% block title %}{{ title }} - Admin - TGFX Trade Lab{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="text-gradient-primary mb-2">
                    <span class="material-symbols-outlined me-2" style="font-size: 2rem;">
                        {% if video %}edit{% else %}add{% endif %}
                    </span>
                    {{ title }}
                </h1>
                <p class="text-muted mb-0">
                    {% if video %}Update video information and settings{% else %}Add a new video to your course library{% endif %}
                </p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('admin_videos') }}" class="btn btn-outline-secondary">
                    <span class="material-symbols-outlined me-2">arrow_back</span>
                    Back to Videos
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Main Form -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2">info</span>
                    Video Information
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="videoForm">
                    {{ form.hidden_tag() }}
                    
                    <!-- Title -->
                    <div class="mb-4">
                        {{ form.title.label(class="form-label") }}
                        {{ form.title(class="form-control", placeholder="Enter video title") }}
                        {% if form.title.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.title.errors %}{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                        <div class="form-text">Choose a clear, descriptive title for your video</div>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-4">
                        {{ form.description.label(class="form-label") }}
                        {{ form.description(class="form-control", rows="4", placeholder="Describe what students will learn in this video...") }}
                        {% if form.description.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.description.errors %}{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                        <div class="form-text">Provide a detailed description of the video content</div>
                    </div>
                    
                    <!-- Tags -->
                    <div class="mb-4">
                        {{ form.tags.label(class="form-label") }}
                        {{ form.tags(class="form-control", placeholder="market structure, support resistance, price action") }}
                        {% if form.tags.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.tags.errors %}{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                        <div class="form-text">Enter tags separated by commas to help organize and filter your content</div>
                        
                        <!-- Suggested Tags -->
                        <div class="mt-2">
                            <label class="form-label small">Quick Tags:</label>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Market Structure">Market Structure</button>
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Support & Resistance">Support & Resistance</button>
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Price Action">Price Action</button>
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Risk Management">Risk Management</button>
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Psychology">Psychology</button>
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Technical Analysis">Technical Analysis</button>
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Chart Patterns">Chart Patterns</button>
                                <button type="button" class="btn btn-sm btn-outline-primary tag-suggestion" data-tag="Trading Strategies">Trading Strategies</button>
                            </div>
                        </div>
                        
                        <!-- Current Tags Preview -->
                        <div class="mt-2" id="tagsPreview"></div>
                    </div>
                    
                    <!-- S3 URL -->
                    <div class="mb-4">
                        {{ form.s3_url.label(class="form-label") }}
                        {{ form.s3_url(class="form-control", placeholder="https://your-bucket.s3.region.amazonaws.com/video.mp4") }}
                        {% if form.s3_url.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.s3_url.errors %}{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                        <div class="form-text">Direct link to the video file stored in AWS S3</div>
                    </div>
                    
                    <!-- Thumbnail URL -->
                    <div class="mb-4">
                        {{ form.thumbnail_url.label(class="form-label") }}
                        {{ form.thumbnail_url(class="form-control", placeholder="https://your-bucket.s3.region.amazonaws.com/thumbnail.jpg") }}
                        {% if form.thumbnail_url.errors %}
                        <div class="text-danger small mt-1">
                            {% for error in form.thumbnail_url.errors %}{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                        <div class="form-text">Optional: Thumbnail image for the video</div>
                    </div>
                    
                    <!-- Category and Settings -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            {{ form.category_id.label(class="form-label") }}
                            {{ form.category_id(class="form-select") }}
                            {% if form.category_id.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.category_id.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {{ form.order_index.label(class="form-label") }}
                            {{ form.order_index(class="form-control", placeholder="0") }}
                            {% if form.order_index.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in form.order_index.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">Lower numbers appear first</div>
                        </div>
                    </div>
                    
                    <!-- Free Video Checkbox -->
                    <div class="mb-4">
                        <div class="form-check">
                            {{ form.is_free(class="form-check-input") }}
                            {{ form.is_free.label(class="form-check-label") }}
                        </div>
                        <div class="form-text">Check this box if the video should be available to all users</div>
                    </div>
                    
                    <!-- Submit Buttons -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <span class="material-symbols-outlined me-2">save</span>
                            {% if video %}Update Video{% else %}Add Video{% endif %}
                        </button>
                        <a href="{{ url_for('admin_videos') }}" class="btn btn-outline-secondary">
                            Cancel
                        </a>
                        {% if video %}
                        <a href="{{ url_for('watch_video', video_id=video.id) }}" class="btn btn-outline-primary ms-auto">
                            <span class="material-symbols-outlined me-2">play_arrow</span>
                            Preview Video
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Video Preview -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <span class="material-symbols-outlined me-2">visibility</span>
                    Video Preview
                </h6>
            </div>
            <div class="card-body">
                <div class="video-preview">
                    <div class="thumbnail-preview mb-3" id="thumbnailPreview">
                        {% if video and video.thumbnail_url %}
                        <img src="{{ video.thumbnail_url }}" alt="Thumbnail" class="img-fluid rounded">
                        {% else %}
                        <div class="placeholder-thumbnail">
                            <span class="material-symbols-outlined">image</span>
                            <p class="small mt-2">Thumbnail Preview</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <h6 class="text-white mb-2" id="titlePreview">
                        {{ video.title if video else 'Video Title' }}
                    </h6>
                    
                    <p class="text-muted small mb-3" id="descriptionPreview">
                        {{ video.description if video and video.description else 'Video description will appear here...' }}
                    </p>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge" id="typePreview">
                            {% if video %}
                                {% if video.is_free %}Free{% else %}Premium{% endif %}
                            {% else %}
                                Free
                            {% endif %}
                        </span>
                        <small class="text-muted" id="categoryPreview">
                            {% if video %}{{ video.category.name }}{% else %}Category{% endif %}
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Video Guidelines -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <span class="material-symbols-outlined me-2">tips_and_updates</span>
                    Video Guidelines
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <span class="material-symbols-outlined me-2 text-success" style="font-size: 16px;">check_circle</span>
                        <small>Upload videos to S3 before adding them here</small>
                    </li>
                    <li class="mb-2">
                        <span class="material-symbols-outlined me-2 text-success" style="font-size: 16px;">check_circle</span>
                        <small>Use descriptive titles and detailed descriptions</small>
                    </li>
                    <li class="mb-2">
                        <span class="material-symbols-outlined me-2 text-success" style="font-size: 16px;">check_circle</span>
                        <small>Add relevant tags to improve discoverability</small>
                    </li>
                    <li class="mb-2">
                        <span class="material-symbols-outlined me-2 text-success" style="font-size: 16px;">check_circle</span>
                        <small>Set proper order within categories</small>
                    </li>
                    <li class="mb-0">
                        <span class="material-symbols-outlined me-2 text-success" style="font-size: 16px;">check_circle</span>
                        <small>Include high-quality thumbnails when possible</small>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Existing Tags -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <span class="material-symbols-outlined me-2">label</span>
                    Popular Tags
                </h6>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <!-- This would be populated with existing tags from the database -->
                    <span class="badge bg-primary">Market Structure</span>
                    <span class="badge bg-success">Support & Resistance</span>
                    <span class="badge bg-warning">Price Action</span>
                    <span class="badge bg-info">Risk Management</span>
                    <span class="badge bg-secondary">Psychology</span>
                </div>
                <p class="text-muted small mt-2 mb-0">
                    Click any tag above to add it to your video.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Form submission with loading state and URL cleaning
document.getElementById('videoForm').addEventListener('submit', function(e) {
    // Clean the thumbnail URL before submission
    const thumbnailInput = document.querySelector('[name="thumbnail_url"]');
    if (thumbnailInput.value) {
        thumbnailInput.value = cleanThumbnailUrl(thumbnailInput.value);
    }
    
    const submitBtn = this.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
});

// Live preview updates
const titleInput = document.querySelector('[name="title"]');
const descriptionInput = document.querySelector('[name="description"]');
const thumbnailInput = document.querySelector('[name="thumbnail_url"]');
const categorySelect = document.querySelector('[name="category_id"]');
const freeCheckbox = document.querySelector('[name="is_free"]');
const tagsInput = document.querySelector('[name="tags"]');

titleInput.addEventListener('input', function() {
    document.getElementById('titlePreview').textContent = this.value || 'Video Title';
});

descriptionInput.addEventListener('input', function() {
    const preview = document.getElementById('descriptionPreview');
    const text = this.value || 'Video description will appear here...';
    preview.textContent = text.length > 100 ? text.substring(0, 100) + '...' : text;
});

// Helper function to clean and validate URLs
function cleanThumbnailUrl(url) {
    if (!url) return '';
    
    // Remove any leading/trailing whitespace
    url = url.trim();
    
    // Replace + with %20 for proper URL encoding
    url = url.replace(/\+/g, '%20');
    
    // Basic URL validation
    try {
        new URL(url);
        return url;
    } catch (e) {
        return '';
    }
}

thumbnailInput.addEventListener('input', function() {
    const preview = document.getElementById('thumbnailPreview');
    const cleanUrl = cleanThumbnailUrl(this.value);
    
    if (cleanUrl) {
        // Create a new image element to test if the URL is valid
        const testImg = new Image();
        testImg.onload = function() {
            preview.innerHTML = `<img src="${cleanUrl}" alt="Thumbnail" class="img-fluid rounded">`;
        };
        testImg.onerror = function() {
            preview.innerHTML = '<div class="placeholder-thumbnail"><span class="material-symbols-outlined">broken_image</span><p class="small mt-2">Invalid Image URL</p></div>';
        };
        testImg.src = cleanUrl;
    } else {
        preview.innerHTML = '<div class="placeholder-thumbnail"><span class="material-symbols-outlined">image</span><p class="small mt-2">Thumbnail Preview</p></div>';
    }
});

categorySelect.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    document.getElementById('categoryPreview').textContent = selectedOption.text || 'Category';
});

freeCheckbox.addEventListener('change', function() {
    const preview = document.getElementById('typePreview');
    if (this.checked) {
        preview.textContent = 'Free';
        preview.className = 'badge bg-success';
    } else {
        preview.textContent = 'Premium';
        preview.className = 'badge bg-warning';
    }
});

// Tags functionality
tagsInput.addEventListener('input', function() {
    updateTagsPreview();
});

function updateTagsPreview() {
    const tagsPreview = document.getElementById('tagsPreview');
    const tagsValue = tagsInput.value;
    
    if (!tagsValue.trim()) {
        tagsPreview.innerHTML = '';
        return;
    }
    
    const tags = tagsValue.split(',').map(tag => tag.trim()).filter(tag => tag);
    const previewHtml = tags.map(tag => 
        `<span class="badge bg-primary me-1 mb-1">${tag}</span>`
    ).join('');
    
    tagsPreview.innerHTML = `<div class="mt-2"><small class="text-muted">Preview:</small><br>${previewHtml}</div>`;
}

// Tag suggestion buttons
document.querySelectorAll('.tag-suggestion').forEach(button => {
    button.addEventListener('click', function() {
        const tag = this.dataset.tag;
        const currentTags = tagsInput.value;
        
        // Check if tag already exists
        const tagsList = currentTags.split(',').map(t => t.trim());
        if (!tagsList.includes(tag)) {
            if (currentTags.trim()) {
                tagsInput.value = currentTags + ', ' + tag;
            } else {
                tagsInput.value = tag;
            }
            updateTagsPreview();
        }
        
        // Visual feedback
        this.classList.add('btn-success');
        this.classList.remove('btn-outline-primary');
        setTimeout(() => {
            this.classList.remove('btn-success');
            this.classList.add('btn-outline-primary');
        }, 1000);
    });
});

// Popular tags click handler
document.querySelectorAll('.badge').forEach(badge => {
    badge.addEventListener('click', function() {
        const tag = this.textContent;
        const currentTags = tagsInput.value;
        
        const tagsList = currentTags.split(',').map(t => t.trim());
        if (!tagsList.includes(tag)) {
            if (currentTags.trim()) {
                tagsInput.value = currentTags + ', ' + tag;
            } else {
                tagsInput.value = tag;
            }
            updateTagsPreview();
        }
    });
});

// Initialize preview
document.addEventListener('DOMContentLoaded', function() {
    updateTagsPreview();
    
    // Auto-suggest order index
    const orderInput = document.querySelector('[name="order_index"]');
    if (orderInput && !orderInput.value) {
        // You could fetch the next order index via AJAX here
        orderInput.value = 0;
    }
});

// Character counters
titleInput.addEventListener('input', function() {
    const maxLength = 200;
    const currentLength = this.value.length;
    const formText = this.parentElement.querySelector('.form-text');
    
    if (currentLength > maxLength - 20) {
        formText.textContent = `${currentLength}/${maxLength} characters`;
        formText.className = currentLength > maxLength ? 'form-text text-danger' : 'form-text text-warning';
    } else {
        formText.textContent = 'Choose a clear, descriptive title for your video';
        formText.className = 'form-text';
    }
});

descriptionInput.addEventListener('input', function() {
    const maxLength = 1000;
    const currentLength = this.value.length;
    const formText = this.parentElement.querySelector('.form-text');
    
    if (currentLength > maxLength - 100) {
        formText.textContent = `${currentLength}/${maxLength} characters`;
        formText.className = currentLength > maxLength ? 'form-text text-danger' : 'form-text text-warning';
    } else {
        formText.textContent = 'Provide a detailed description of the video content';
        formText.className = 'form-text';
    }
});
</script>

<style>
.video-preview {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.video-preview:hover {
    border-color: rgba(16, 185, 129, 0.3);
    background: rgba(255, 255, 255, 0.05);
}

.placeholder-thumbnail {
    background: var(--bg-secondary);
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    color: var(--text-muted);
}

.placeholder-thumbnail .material-symbols-outlined {
    font-size: 2rem;
    opacity: 0.5;
}

.form-control:focus,
.form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.15);
}

.tag-suggestion:hover {
    transform: translateY(-1px);
}

.badge {
    cursor: pointer;
    transition: all 0.2s ease;
}

.badge:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

.card:hover {
    border-color: rgba(16, 185, 129, 0.2);
}

.btn:hover {
    transform: translateY(-1px);
}

/* Form validation styling */
.form-control.is-invalid,
.form-select.is-invalid {
    border-color: #dc3545;
}

.form-control.is-valid,
.form-select.is-valid {
    border-color: #28a745;
}

/* Tags preview styling */
#tagsPreview .badge {
    font-size: 0.75rem;
    margin-right: 0.25rem;
    margin-bottom: 0.25rem;
}
</style>
{% endblock %}
