{% extends "base.html" %}

{% block title %}Manage Recommendations - Admin - TGFX Trade Lab{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="text-gradient-primary mb-2">
                    <span class="material-symbols-outlined me-2" style="font-size: 2rem;">recommend</span>
                    Manage Recommendations
                </h1>
                <p class="text-muted mb-0">Manage affiliate links and recommended resources</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRecommendationModal">
                    <span class="material-symbols-outlined me-2">add</span>
                    Add Recommendation
                </button>
                <button class="btn btn-outline-secondary" onclick="exportRecommendations()">
                    <span class="material-symbols-outlined me-2">download</span>
                    Export
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <div class="mb-3">
                    <span class="material-symbols-outlined text-primary" style="font-size: 2.5rem;">recommend</span>
                </div>
                <h3 class="text-gradient-primary mb-2">{{ total_recommendations }}</h3>
                <p class="text-muted mb-0">Total Recommendations</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <div class="mb-3">
                    <span class="material-symbols-outlined text-success" style="font-size: 2.5rem;">visibility</span>
                </div>
                <h3 class="text-gradient-primary mb-2">{{ total_clicks }}</h3>
                <p class="text-muted mb-0">Total Clicks</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <div class="mb-3">
                    <span class="material-symbols-outlined text-warning" style="font-size: 2.5rem;">star</span>
                </div>
                <h3 class="text-gradient-primary mb-2">{{ featured_count }}</h3>
                <p class="text-muted mb-0">Featured Items</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-3">
        <div class="card">
            <div class="card-body text-center">
                <div class="mb-3">
                    <span class="material-symbols-outlined text-info" style="font-size: 2.5rem;">category</span>
                </div>
                <h3 class="text-gradient-primary mb-2">{{ category_count }}</h3>
                <p class="text-muted mb-0">Categories</p>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <label class="form-label">Filter by Category:</label>
                        <select class="form-select" id="categoryFilter" onchange="filterRecommendations()">
                            <option value="">All Categories</option>
                            <option value="broker">Brokers</option>
                            <option value="software">Software</option>
                            <option value="education">Education</option>
                            <option value="tools">Tools</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Filter by Status:</label>
                        <select class="form-select" id="statusFilter" onchange="filterRecommendations()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="featured">Featured</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Search:</label>
                        <input type="text" class="form-control" id="searchInput" placeholder="Search recommendations..." onkeyup="filterRecommendations()">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recommendations Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2">list</span>
                    All Recommendations
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover" id="recommendationsTable">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Clicks</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for recommendation in recommendations %}
                            <tr data-category="{{ recommendation.category }}" data-status="{% if recommendation.is_active %}active{% else %}inactive{% endif %}{% if recommendation.is_featured %} featured{% endif %}">
                                <td>
                                    {% if recommendation.image_url %}
                                    <img src="{{ recommendation.image_url }}" alt="{{ recommendation.title }}" 
                                         style="width: 50px; height: 30px; object-fit: cover; border-radius: 6px;">
                                    {% else %}
                                    <div class="bg-gradient-primary d-flex align-items-center justify-content-center" 
                                         style="width: 50px; height: 30px; border-radius: 6px;">
                                        <span class="material-symbols-outlined text-white" style="font-size: 16px;">recommend</span>
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <div>
                                        <strong>{{ recommendation.title }}</strong>
                                        {% if recommendation.is_featured %}
                                        <span class="badge bg-warning text-dark ms-2">Featured</span>
                                        {% endif %}
                                        <br>
                                        <small class="text-muted">{{ recommendation.description[:50] }}...</small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ recommendation.category|title }}</span>
                                </td>
                                <td>
                                    <span class="text-success">{{ recommendation.click_count or 0 }}</span>
                                </td>
                                <td>
                                    {% if recommendation.is_active %}
                                    <span class="badge bg-success">Active</span>
                                    {% else %}
                                    <span class="badge bg-danger">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">{{ recommendation.created_at.strftime('%m/%d/%Y') }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="viewRecommendation({{ recommendation.id }})" title="View">
                                            <span class="material-symbols-outlined" style="font-size: 16px;">visibility</span>
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="editRecommendation({{ recommendation.id }})" title="Edit">
                                            <span class="material-symbols-outlined" style="font-size: 16px;">edit</span>
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="toggleFeatured({{ recommendation.id }}, {{ recommendation.is_featured|lower }})" title="Toggle Featured">
                                            <span class="material-symbols-outlined" style="font-size: 16px;">{% if recommendation.is_featured %}star{% else %}star_border{% endif %}</span>
                                        </button>
                                        <button class="btn btn-outline-danger" onclick="deleteRecommendation({{ recommendation.id }})" title="Delete">
                                            <span class="material-symbols-outlined" style="font-size: 16px;">delete</span>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% if not recommendations %}
                <div class="text-center py-5">
                    <span class="material-symbols-outlined text-muted mb-3" style="font-size: 4rem;">recommend</span>
                    <h4 class="text-muted mb-3">No Recommendations Yet</h4>
                    <p class="text-muted mb-4">Add your first recommendation to get started</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRecommendationModal">
                        <span class="material-symbols-outlined me-2">add</span>
                        Add Recommendation
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Recommendation Modal -->
<div class="modal fade" id="addRecommendationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-primary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-gradient-primary">
                    <span class="material-symbols-outlined me-2">add</span>
                    Add Recommendation
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="recommendationForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Title *</label>
                                <input type="text" class="form-control" name="title" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category *</label>
                                <select class="form-select" name="category" required>
                                    <option value="">Select Category</option>
                                    <option value="broker">Broker</option>
                                    <option value="software">Software</option>
                                    <option value="education">Education</option>
                                    <option value="tools">Tools</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description *</label>
                        <textarea class="form-control" name="description" rows="3" required></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Affiliate URL *</label>
                                <input type="url" class="form-control" name="affiliate_url" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Image URL</label>
                                <input type="url" class="form-control" name="image_url">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Demo URL</label>
                                <input type="url" class="form-control" name="demo_url">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Price Information</label>
                                <input type="text" class="form-control" name="price_info" placeholder="e.g., From $29/month">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Coupon Code</label>
                                <input type="text" class="form-control" name="coupon_code" placeholder="e.g., TGFX20">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Discount Percentage</label>
                                <input type="number" class="form-control" name="discount_percentage" min="0" max="100" placeholder="20">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Key Features</label>
                        <textarea class="form-control" name="features" rows="2" placeholder="Feature 1, Feature 2, Feature 3"></textarea>
                        <small class="text-muted">Separate features with commas</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Order</label>
                                <input type="number" class="form-control" name="order_index" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" name="is_featured" id="isFeatured">
                                    <label class="form-check-label" for="isFeatured">
                                        Featured Recommendation
                                    </label>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" name="is_active" id="isActive" checked>
                                    <label class="form-check-label" for="isActive">
                                        Active
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-symbols-outlined me-2">save</span>
                        Save Recommendation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Recommendation Modal -->
<div class="modal fade" id="viewRecommendationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-primary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-gradient-primary">
                    <span class="material-symbols-outlined me-2">visibility</span>
                    Recommendation Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="viewRecommendationContent">
                <!-- Dynamic content will be loaded here -->
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editCurrentRecommendation()">
                    <span class="material-symbols-outlined me-2">edit</span>
                    Edit
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentRecommendationId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Form submission
    document.getElementById('recommendationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        saveRecommendation();
    });
    
    // Animate cards
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});

function filterRecommendations() {
    const categoryFilter = document.getElementById('categoryFilter').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const table = document.getElementById('recommendationsTable');
    const rows = table.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const category = row.dataset.category.toLowerCase();
        const status = row.dataset.status.toLowerCase();
        const title = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
        
        let showRow = true;
        
        if (categoryFilter && !category.includes(categoryFilter)) {
            showRow = false;
        }
        
        if (statusFilter && !status.includes(statusFilter)) {
            showRow = false;
        }
        
        if (searchTerm && !title.includes(searchTerm)) {
            showRow = false;
        }
        
        row.style.display = showRow ? '' : 'none';
    });
}

function saveRecommendation() {
    const form = document.getElementById('recommendationForm');
    const formData = new FormData(form);
    
    // Convert FormData to JSON
    const data = {};
    for (let [key, value] of formData.entries()) {
        if (key === 'is_featured' || key === 'is_active') {
            data[key] = value === 'on';
        } else {
            data[key] = value;
        }
    }
    
    const url = currentRecommendationId ? 
        `/api/admin/recommendations/${currentRecommendationId}` : 
        '/api/admin/recommendations';
    
    const method = currentRecommendationId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Recommendation saved successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addRecommendationModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error saving recommendation: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error saving recommendation', 'error');
    });
}

function viewRecommendation(id) {
    fetch(`/api/admin/recommendations/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const rec = data.recommendation;
                document.getElementById('viewRecommendationContent').innerHTML = `
                    <div class="row">
                        <div class="col-md-4">
                            ${rec.image_url ? 
                                `<img src="${rec.image_url}" class="img-fluid rounded" alt="${rec.title}">` :
                                '<div class="bg-gradient-primary rounded d-flex align-items-center justify-content-center" style="height: 200px;"><span class="material-symbols-outlined text-white" style="font-size: 3rem;">recommend</span></div>'
                            }
                        </div>
                        <div class="col-md-8">
                            <h4 class="text-gradient-primary">${rec.title}</h4>
                            <p class="text-muted">${rec.description}</p>
                            
                            <div class="row mb-3">
                                <div class="col-6">
                                    <strong>Category:</strong> ${rec.category}
                                </div>
                                <div class="col-6">
                                    <strong>Status:</strong> ${rec.is_active ? 'Active' : 'Inactive'}
                                </div>
                            </div>
                            
                            ${rec.price_info ? `<p><strong>Price:</strong> ${rec.price_info}</p>` : ''}
                            ${rec.coupon_code ? `<p><strong>Coupon:</strong> ${rec.coupon_code} ${rec.discount_percentage ? `(${rec.discount_percentage}% off)` : ''}</p>` : ''}
                            ${rec.features ? `<p><strong>Features:</strong> ${rec.features}</p>` : ''}
                            
                            <p><strong>Clicks:</strong> ${rec.click_count || 0}</p>
                            <p><strong>Created:</strong> ${new Date(rec.created_at).toLocaleDateString()}</p>
                            
                            <div class="mt-3">
                                <a href="${rec.affiliate_url}" target="_blank" class="btn btn-outline-primary">
                                    <span class="material-symbols-outlined me-2">open_in_new</span>
                                    View Link
                                </a>
                                ${rec.demo_url ? `<a href="${rec.demo_url}" target="_blank" class="btn btn-outline-secondary ms-2">View Demo</a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                currentRecommendationId = id;
                new bootstrap.Modal(document.getElementById('viewRecommendationModal')).show();
            }
        });
}

function editRecommendation(id) {
    fetch(`/api/admin/recommendations/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const rec = data.recommendation;
                currentRecommendationId = id;
                
                // Populate form
                const form = document.getElementById('recommendationForm');
                form.title.value = rec.title;
                form.category.value = rec.category;
                form.description.value = rec.description;
                form.affiliate_url.value = rec.affiliate_url;
                form.image_url.value = rec.image_url || '';
                form.demo_url.value = rec.demo_url || '';
                form.price_info.value = rec.price_info || '';
                form.coupon_code.value = rec.coupon_code || '';
                form.discount_percentage.value = rec.discount_percentage || '';
                form.features.value = rec.features || '';
                form.order_index.value = rec.order_index || 0;
                form.is_featured.checked = rec.is_featured;
                form.is_active.checked = rec.is_active;
                
                // Update modal title
                document.querySelector('#addRecommendationModal .modal-title').innerHTML = 
                    '<span class="material-symbols-outlined me-2">edit</span>Edit Recommendation';
                
                new bootstrap.Modal(document.getElementById('addRecommendationModal')).show();
            }
        });
}

function editCurrentRecommendation() {
    if (currentRecommendationId) {
        bootstrap.Modal.getInstance(document.getElementById('viewRecommendationModal')).hide();
        setTimeout(() => editRecommendation(currentRecommendationId), 300);
    }
}

function toggleFeatured(id, currentStatus) {
    fetch(`/api/admin/recommendations/${id}/toggle-featured`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Recommendation ${data.is_featured ? 'featured' : 'unfeatured'}!`, 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error updating recommendation', 'error');
        }
    });
}

function deleteRecommendation(id) {
    if (confirm('Are you sure you want to delete this recommendation? This action cannot be undone.')) {
        fetch(`/api/admin/recommendations/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Recommendation deleted successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Error deleting recommendation', 'error');
            }
        });
    }
}

function exportRecommendations() {
    window.open('/api/admin/recommendations/export', '_blank');
}

// Reset form when modal is hidden
document.getElementById('addRecommendationModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('recommendationForm').reset();
    currentRecommendationId = null;
    document.querySelector('#addRecommendationModal .modal-title').innerHTML = 
        '<span class="material-symbols-outlined me-2">add</span>Add Recommendation';
});
</script>
{% endblock %}
