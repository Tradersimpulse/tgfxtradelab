<!-- templates/admin/trading_signal_form.html -->
{% extends "base.html" %}

{% block title %}{{ title }} - Admin{% endblock %}

{% block head %}
<style>
    .form-section {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .form-section h5 {
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--border-color);
    }
    
    .auto-calculate {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 12px;
        padding: 1rem;
        margin: 1rem 0;
    }
    
    .price-input {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 1rem;
        text-align: center;
        font-weight: 600;
    }
    
    .rr-display {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
    }
    
    .rr-value {
        font-size: 2rem;
        font-weight: 800;
        color: #10B981;
        margin-bottom: 0.5rem;
    }
    
    .auto-fill-section {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
        border: 2px dashed rgba(16, 185, 129, 0.3);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .trader-default-info {
        background: var(--bg-tertiary);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .video-link-section {
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
    }
    
    .calculation-help {
        background: var(--bg-secondary);
        border-left: 4px solid #10B981;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .pip-calculator {
        background: var(--bg-tertiary);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
    }
    
    .preview-trade {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .trade-preview-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border-light);
    }
    
    .trade-preview-item:last-child {
        border-bottom: none;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .smart-suggestions {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-radius: 12px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .suggestion-item {
        display: flex;
        justify-content: between;
        align-items: center;
        padding: 0.5rem;
        margin: 0.25rem 0;
        background: var(--bg-tertiary);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .suggestion-item:hover {
        background: rgba(245, 158, 11, 0.2);
        transform: translateX(4px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1 text-gradient-primary">{{ title }}</h1>
            <p class="text-muted mb-0">Add or edit trading signal with smart auto-calculations</p>
        </div>
        <div>
            <a href="{{ url_for('admin_trading_signals') }}" class="btn btn-outline-secondary">
                <span class="material-symbols-outlined me-2">arrow_back</span>
                Back to Signals
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <form method="POST" id="tradingSignalForm">
                {{ form.hidden_tag() }}
                
                <!-- Auto-fill Section -->
                <div class="auto-fill-section">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="mb-2">
                                <span class="material-symbols-outlined me-2">auto_fix_high</span>
                                Smart Auto-fill
                            </h5>
                            <p class="mb-0 text-muted">Load default settings based on the current user and trading preferences</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button type="button" class="btn btn-success" onclick="loadTraderDefaults()">
                                <span class="material-symbols-outlined me-2">flash_on</span>
                                Load Defaults
                            </button>
                        </div>
                    </div>
                    
                    <div class="trader-default-info mt-3" id="defaultInfo" style="display: none;">
                        <h6>Current Defaults:</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Trader:</strong> <span id="defaultTrader">-</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Default Pair:</strong> <span id="defaultPair">-</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Default R/R:</strong> <span id="defaultRR">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Basic Information -->
                <div class="form-section">
                    <h5>
                        <span class="material-symbols-outlined me-2">info</span>
                        Basic Trade Information
                    </h5>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Trader</label>
                            {{ form.trader_name(class="form-control") }}
                            {% if form.trader_name.errors %}
                                <div class="text-danger small mt-1">{{ form.trader_name.errors[0] }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Trading Pair</label>
                            {{ form.pair_name(class="form-control", onchange="updatePairSpecifics()") }}
                            {% if form.pair_name.errors %}
                                <div class="text-danger small mt-1">{{ form.pair_name.errors[0] }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Trade Type</label>
                            {{ form.trade_type(class="form-control") }}
                            {% if form.trade_type.errors %}
                                <div class="text-danger small mt-1">{{ form.trade_type.errors[0] }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Risk/Reward Ratio</label>
                            {{ form.risk_reward_ratio(class="form-control", onchange="calculateRRRatio()", step="0.1") }}
                            {% if form.risk_reward_ratio.errors %}
                                <div class="text-danger small mt-1">{{ form.risk_reward_ratio.errors[0] }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Price Levels -->
                <div class="form-section">
                    <h5>
                        <span class="material-symbols-outlined me-2">currency_exchange</span>
                        Price Levels
                    </h5>
                    
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Entry Price</label>
                            {{ form.entry_price(class="form-control price-input", onchange="calculatePips()", step="0.00001") }}
                            {% if form.entry_price.errors %}
                                <div class="text-danger small mt-1">{{ form.entry_price.errors[0] }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">Stop Loss Price</label>
                            {{ form.stop_loss_price(class="form-control price-input", onchange="calculatePips()", step="0.00001") }}
                            {% if form.stop_loss_price.errors %}
                                <div class="text-danger small mt-1">{{ form.stop_loss_price.errors[0] }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">Target Price</label>
                            {{ form.target_price(class="form-control price-input", onchange="calculatePips()", step="0.00001") }}
                            {% if form.target_price.errors %}
                                <div class="text-danger small mt-1">{{ form.target_price.errors[0] }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="auto-calculate">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="pip-calculator">
                                    <div class="fw-bold text-primary" id="pipsRisk">0</div>
                                    <small class="text-muted">Pips Risk</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="pip-calculator">
                                    <div class="fw-bold text-success" id="pipsReward">0</div>
                                    <small class="text-muted">Pips Reward</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="rr-display">
                                    <div class="rr-value" id="calculatedRR">0:1</div>
                                    <small class="text-muted">Calculated R/R</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="smart-suggestions" id="smartSuggestions" style="display: none;">
                        <h6>
                            <span class="material-symbols-outlined me-2">lightbulb</span>
                            Smart Suggestions
                        </h6>
                        <div id="suggestionsList"></div>
                    </div>
                </div>

                <!-- Trade Outcome -->
                <div class="form-section">
                    <h5>
                        <span class="material-symbols-outlined me-2">flag</span>
                        Trade Outcome & Performance
                    </h5>
                    
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Outcome</label>
                            {{ form.outcome(class="form-control", onchange="updateTradeOutcome()") }}
                            {% if form.outcome.errors %}
                                <div class="text-danger small mt-1">{{ form.outcome.errors[0] }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">Actual R Outcome</label>
                            {{ form.actual_rr(class="form-control", step="0.1") }}
                            <small class="text-muted">Final trade result (positive for wins, negative for losses)</small>
                            {% if form.actual_rr.errors %}
                                <div class="text-danger small mt-1">{{ form.actual_rr.errors[0] }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <label class="form-label">Achieved R (Max Favorable)</label>
                            {{ form.achieved_rr(class="form-control", step="0.1") }}
                            <small class="text-muted">How far price went in your favor before reversal (optional)</small>
                            {% if form.achieved_rr.errors %}
                                <div class="text-danger small mt-1">{{ form.achieved_rr.errors[0] }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="calculation-help">
                        <h6>
                            <span class="material-symbols-outlined me-2">help</span>
                            How to Calculate Trade Outcomes
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">Actual R Outcome (Final Result):</h6>
                                <ul class="mb-0">
                                    <li><strong>Win:</strong> Enter positive R value (e.g., 3.0 for full target, 1.5 for partial profit)</li>
                                    <li><strong>Loss:</strong> Enter -1.0 for full loss, or partial loss value (e.g., -0.5)</li>
                                    <li><strong>Breakeven:</strong> Enter 0.0</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">Achieved R (Maximum Favorable):</h6>
                                <ul class="mb-0">
                                    <li><strong>Winning Trade:</strong> Same as Actual R (e.g., 3.0)</li>
                                    <li><strong>Losing Trade:</strong> How far it went before reversal (e.g., 1.5R before hitting SL)</li>
                                    <li><strong>Never Moved:</strong> Enter 0 if price never went in your favor</li>
                                    <li><strong>Use Case:</strong> Helps analyze optimal exit strategies</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <strong>Example:</strong> You target 3R but price reaches 1.5R, then reverses and hits your stop loss (-1R). 
                            Enter <code>-1.0</code> for <strong>Actual R</strong> and <code>1.5</code> for <strong>Achieved R</strong>.
                        </div>
                    </div>
                </div>
                <!-- Video Link -->
                <div class="form-section">
                    <div class="video-link-section">
                        <h5>
                            <span class="material-symbols-outlined me-2">video_library</span>
                            Link to Trading Video (Optional)
                        </h5>
                        
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Live Trading Session Video</label>
                                {{ form.linked_video_id(class="form-control") }}
                                <small class="text-muted">
                                    Link this trading signal to a live trading session video so users can watch the actual trade execution.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="form-section">
                    <h5>
                        <span class="material-symbols-outlined me-2">note</span>
                        Additional Notes
                    </h5>
                    
                    <div class="row">
                        <div class="col-12">
                            <label class="form-label">Trading Notes</label>
                            {{ form.notes(class="form-control", rows="4", placeholder="Optional notes about this trade (market conditions, reasoning, lessons learned, etc.)") }}
                            {% if form.notes.errors %}
                                <div class="text-danger small mt-1">{{ form.notes.errors[0] }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="d-flex justify-content-between">
                    <a href="{{ url_for('admin_trading_signals') }}" class="btn btn-outline-secondary">
                        <span class="material-symbols-outlined me-2">cancel</span>
                        Cancel
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <span class="material-symbols-outlined me-2">save</span>
                        {% if signal %}Update Signal{% else %}Add Signal{% endif %}
                    </button>
                </div>
            </form>
        </div>

        <!-- Live Preview -->
        <div class="col-lg-4">
            <div class="position-sticky" style="top: 2rem;">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <span class="material-symbols-outlined me-2">preview</span>
                            Live Preview
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="preview-trade" id="livePreview">
                            <div class="trade-preview-item">
                                <span>Trader:</span>
                                <strong id="previewTrader">-</strong>
                            </div>
                            <div class="trade-preview-item">
                                <span>Pair:</span>
                                <strong id="previewPair">-</strong>
                            </div>
                            <div class="trade-preview-item">
                                <span>Type:</span>
                                <strong id="previewType">-</strong>
                            </div>
                            <div class="trade-preview-item">
                                <span>Entry:</span>
                                <strong id="previewEntry">-</strong>
                            </div>
                            <div class="trade-preview-item">
                                <span>Stop Loss:</span>
                                <strong id="previewSL">-</strong>
                            </div>
                            <div class="trade-preview-item">
                                <span>Target:</span>
                                <strong id="previewTarget">-</strong>
                            </div>
                            <div class="trade-preview-item">
                                <span>Risk/Reward:</span>
                                <strong id="previewRR" style="color: #10B981;">-</strong>
                            </div>
                            <div class="trade-preview-item">
                                <span>Outcome:</span>
                                <strong id="previewOutcome">-</strong>
                            </div>
                            <div class="trade-preview-item">
                                <span>Achieved R:</span>
                                <strong id="previewAchieved" style="color: #10B981;">-</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let pairSpecs = {
    'EURUSD': { decimals: 5, pipValue: 0.0001 },
    'GBPUSD': { decimals: 5, pipValue: 0.0001 },
    'AUDUSD': { decimals: 5, pipValue: 0.0001 },
    'NZDUSD': { decimals: 5, pipValue: 0.0001 },
    'USDJPY': { decimals: 3, pipValue: 0.01 },
    'EURJPY': { decimals: 3, pipValue: 0.01 },
    'GBPJPY': { decimals: 3, pipValue: 0.01 },
    'XAUUSD': { decimals: 2, pipValue: 0.1 },
    'NQ': { decimals: 0, pipValue: 1.0 },
    'ES': { decimals: 0, pipValue: 1.0 },
    'YM': { decimals: 0, pipValue: 1.0 }
};

document.addEventListener('DOMContentLoaded', function() {
    // Update preview on page load
    updateLivePreview();
    
    // Add event listeners for live preview
    document.querySelectorAll('select, input').forEach(element => {
        element.addEventListener('change', updateLivePreview);
        element.addEventListener('input', updateLivePreview);
    });
    
    // Add validation for achieved R field
    const achievedRField = document.getElementById('achieved_rr');
    if (achievedRField) {
        achievedRField.addEventListener('blur', validateAchievedR);
        achievedRField.addEventListener('input', function() {
            // Clear validation errors on input
            const existingError = this.parentNode.querySelector('.validation-error');
            if (existingError) {
                existingError.remove();
            }
        });
    }
    
    // Update preview when R fields change
    document.querySelectorAll('#actual_rr, #achieved_rr').forEach(field => {
        field.addEventListener('input', updateLivePreview);
        field.addEventListener('change', updateLivePreview);
    });
    
    // Calculate pips and RR on load if values exist
    calculatePips();
});

async function loadTraderDefaults() {
    try {
        const response = await fetch('/api/trading-stats/trader-defaults');
        const data = await response.json();
        
        if (data.success) {
            // Update form fields
            document.getElementById('trader_name').value = data.trader_name;
            document.getElementById('pair_name').value = data.default_pair;
            document.getElementById('risk_reward_ratio').value = data.default_risk_reward;
            
            // Show default info
            document.getElementById('defaultTrader').textContent = data.trader_name;
            document.getElementById('defaultPair').textContent = data.default_pair;
            document.getElementById('defaultRR').textContent = data.default_risk_reward + ':1';
            document.getElementById('defaultInfo').style.display = 'block';
            
            // Update live preview
            updateLivePreview();
            updatePairSpecifics();
            
            showToast(`Loaded defaults for ${data.trader_name}`, 'success');
        }
    } catch (error) {
        console.error('Error loading trader defaults:', error);
        showToast('Error loading trader defaults', 'error');
    }
}

function updatePairSpecifics() {
    const pair = document.getElementById('pair_name').value;
    const spec = pairSpecs[pair];
    
    if (spec) {
        // Update input step values based on pair
        const priceInputs = document.querySelectorAll('.price-input');
        priceInputs.forEach(input => {
            input.step = spec.pipValue.toString();
        });
        
        calculatePips();
    }
}

function calculatePips() {
    const pair = document.getElementById('pair_name').value;
    const tradeType = document.getElementById('trade_type').value;
    const entry = parseFloat(document.getElementById('entry_price').value);
    const stopLoss = parseFloat(document.getElementById('stop_loss_price').value);
    const target = parseFloat(document.getElementById('target_price').value);
    
    if (!pair || !tradeType || !entry || !stopLoss || !target) {
        return;
    }
    
    const spec = pairSpecs[pair];
    if (!spec) return;
    
    let pipsRisk, pipsReward;
    
    if (tradeType === 'Buy') {
        pipsRisk = Math.abs((entry - stopLoss) / spec.pipValue);
        pipsReward = Math.abs((target - entry) / spec.pipValue);
    } else {
        pipsRisk = Math.abs((stopLoss - entry) / spec.pipValue);
        pipsReward = Math.abs((entry - target) / spec.pipValue);
    }
    
    const rrRatio = pipsReward / pipsRisk;
    
    // Update display
    document.getElementById('pipsRisk').textContent = pipsRisk.toFixed(1);
    document.getElementById('pipsReward').textContent = pipsReward.toFixed(1);
    document.getElementById('calculatedRR').textContent = rrRatio.toFixed(1) + ':1';
    
    // Update RR ratio field if it's empty or different
    const rrField = document.getElementById('risk_reward_ratio');
    if (!rrField.value || Math.abs(parseFloat(rrField.value) - rrRatio) > 0.1) {
        rrField.value = rrRatio.toFixed(1);
    }
    
    // Show smart suggestions
    showSmartSuggestions(rrRatio, pipsRisk, pipsReward);
}

// UPDATED: Enhanced trade outcome function with actual_rr and achieved_rr
function updateTradeOutcome() {
    const outcome = document.getElementById('outcome').value;
    const rrRatio = parseFloat(document.getElementById('risk_reward_ratio').value) || 0;
    const actualRrField = document.getElementById('actual_rr');
    const achievedRrField = document.getElementById('achieved_rr');
    
    // Auto-fill Actual R based on outcome
    if (outcome === 'Win' && !actualRrField.value) {
        actualRrField.value = rrRatio.toFixed(1);
        // For wins, achieved R is typically the same as actual R
        if (!achievedRrField.value) {
            achievedRrField.value = rrRatio.toFixed(1);
        }
    } else if (outcome === 'Loss' && !actualRrField.value) {
        actualRrField.value = '-1.0';
        // Leave achieved R empty for manual entry (how far it went before reversing)
    } else if (outcome === 'Breakeven' && !actualRrField.value) {
        actualRrField.value = '0.0';
        // For breakeven, achieved R might be how far it went before coming back
    }
    
    updateLivePreview();
}

// UPDATED: Enhanced live preview with actual_rr and achieved_rr
function updateLivePreview() {
    // Update all preview fields including new ones
    document.getElementById('previewTrader').textContent = 
        document.getElementById('trader_name').value || '-';
    document.getElementById('previewPair').textContent = 
        document.getElementById('pair_name').value || '-';
    document.getElementById('previewType').textContent = 
        document.getElementById('trade_type').value || '-';
    document.getElementById('previewEntry').textContent = 
        document.getElementById('entry_price').value || '-';
    document.getElementById('previewSL').textContent = 
        document.getElementById('stop_loss_price').value || '-';
    document.getElementById('previewTarget').textContent = 
        document.getElementById('target_price').value || '-';
    document.getElementById('previewRR').textContent = 
        (document.getElementById('risk_reward_ratio').value || '-') + ':1';
    document.getElementById('previewOutcome').textContent = 
        document.getElementById('outcome').value || '-';
    
    // UPDATED: Show both actual and achieved R
    const actualR = document.getElementById('actual_rr').value || '-';
    const achievedR = document.getElementById('achieved_rr').value || '-';
    
    document.getElementById('previewActual').textContent = actualR + 'R';
    document.getElementById('previewAchieved').textContent = achievedR + 'R';
}

// UPDATED: Enhanced suggestions with achieved R tracking
function showSmartSuggestions(currentRR, pipsRisk, pipsReward) {
    const suggestionsContainer = document.getElementById('smartSuggestions');
    const suggestionsList = document.getElementById('suggestionsList');
    
    let suggestions = [];
    
    const trader = document.getElementById('trader_name').value;
    const targetRR = trader === 'Jordan' ? 1.0 : 3.0;
    
    if (currentRR < targetRR * 0.8) {
        suggestions.push({
            text: `Consider increasing target for ${targetRR}:1 RR (${trader}'s preferred ratio)`,
            type: 'warning'
        });
    }
    
    if (pipsRisk > 50) {
        suggestions.push({
            text: 'Risk is quite high (>50 pips). Consider tighter stop loss.',
            type: 'warning'
        });
    }
    
    if (currentRR > 5) {
        suggestions.push({
            text: 'Excellent risk/reward ratio! This is a great setup.',
            type: 'success'
        });
    }
    
    // NEW: Suggestion for achieved R tracking
    const outcome = document.getElementById('outcome').value;
    const achievedR = parseFloat(document.getElementById('achieved_rr').value || 0);
    const actualR = parseFloat(document.getElementById('actual_rr').value || 0);
    
    if (outcome === 'Loss' && actualR < 0 && achievedR > 0) {
        suggestions.push({
            text: `Trade went ${achievedR}R in your favor before reversing. Consider partial profit taking at ${achievedR}R level.`,
            type: 'info'
        });
    }
    
    if (outcome === 'Loss' && achievedR > targetRR * 0.5) {
        suggestions.push({
            text: `Price reached ${achievedR}R (${((achievedR/targetRR)*100).toFixed(0)}% of target). Consider trailing stops.`,
            type: 'info'
        });
    }
    
    if (suggestions.length > 0) {
        suggestionsList.innerHTML = suggestions.map(s => 
            `<div class="suggestion-item">
                <span class="material-symbols-outlined me-2" style="color: ${getColorForType(s.type)};">
                    ${getIconForType(s.type)}
                </span>
                ${s.text}
            </div>`
        ).join('');
        suggestionsContainer.style.display = 'block';
    } else {
        suggestionsContainer.style.display = 'none';
    }
}

// NEW: Helper functions for suggestions
function getColorForType(type) {
    const colors = {
        'success': '#10B981',
        'warning': '#F59E0B',
        'info': '#3B82F6',
        'error': '#EF4444'
    };
    return colors[type] || '#6B7280';
}

function getIconForType(type) {
    const icons = {
        'success': 'check_circle',
        'warning': 'warning',
        'info': 'info',
        'error': 'error'
    };
    return icons[type] || 'help';
}

// NEW: Validation for achieved R field
function validateAchievedR() {
    const outcome = document.getElementById('outcome').value;
    const actualR = parseFloat(document.getElementById('actual_rr').value || 0);
    const achievedR = parseFloat(document.getElementById('achieved_rr').value || 0);
    const targetR = parseFloat(document.getElementById('risk_reward_ratio').value || 0);
    
    let isValid = true;
    let message = '';
    
    // For winning trades, achieved R should not be less than actual R
    if (outcome === 'Win' && achievedR > 0 && achievedR < actualR) {
        isValid = false;
        message = 'Achieved R cannot be less than Actual R for winning trades';
    }
    
    // Achieved R should not exceed target significantly (with some buffer for slippage)
    if (achievedR > targetR * 1.2) {
        message = 'Achieved R seems unusually high compared to target. Please verify.';
    }
    
    // Show validation message
    const achievedRField = document.getElementById('achieved_rr');
    const existingError = achievedRField.parentNode.querySelector('.validation-error');
    
    if (existingError) {
        existingError.remove();
    }
    
    if (!isValid) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'text-danger small mt-1 validation-error';
        errorDiv.textContent = message;
        achievedRField.parentNode.appendChild(errorDiv);
    } else if (message) {
        const warningDiv = document.createElement('div');
        warningDiv.className = 'text-warning small mt-1 validation-error';
        warningDiv.textContent = message;
        achievedRField.parentNode.appendChild(warningDiv);
    }
    
    return isValid;
}

function calculateRRRatio() {
    // Trigger pip calculation when RR ratio is manually changed
    setTimeout(calculatePips, 100);
}
</script>
{% endblock %}
