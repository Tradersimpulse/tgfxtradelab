{% extends "base.html" %}

{% block title %}Payment Issues - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="text-gradient-primary">⚠️ Payment Issues</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('admin') }}" class="text-decoration-none">Admin</a>
                        </li>
                        <li class="breadcrumb-item active">Payment Issues</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <!-- Alert Summary -->
    <div class="row mb-4">
        <div class="col-12">
            {% if users_with_issues %}
            <div class="alert alert-warning">
                <div class="d-flex align-items-center">
                    <span class="material-symbols-outlined me-2">warning</span>
                    <div>
                        <strong>{{ users_with_issues|length }} users need attention</strong><br>
                        These users have payment issues that may require immediate action.
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-success">
                <div class="d-flex align-items-center">
                    <span class="material-symbols-outlined me-2">check_circle</span>
                    <div>
                        <strong>No payment issues found</strong><br>
                        All subscribers have healthy payment status.
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Payment Issues Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <span class="material-symbols-outlined me-2">error</span>
                            Users with Payment Issues
                        </h5>
                        <div class="d-flex gap-2">
                            <button class="btn btn-warning btn-sm" onclick="sendPaymentReminders()">
                                <span class="material-symbols-outlined me-1" style="font-size: 16px;">mail</span>
                                Send Reminders
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="refreshPaymentStatus()">
                                <span class="material-symbols-outlined me-1" style="font-size: 16px;">refresh</span>
                                Refresh Status
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if users_with_issues %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Issue Type</th>
                                    <th>Plan</th>
                                    <th>Last Payment</th>
                                    <th>Amount Due</th>
                                    <th>Days Overdue</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users_with_issues %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="bg-warning rounded-circle d-flex align-items-center justify-content-center me-2" 
                                                 style="width: 32px; height: 32px;">
                                                <span class="text-white small fw-bold">{{ user.username[0].upper() }}</span>
                                            </div>
                                            <div>
                                                <div class="fw-medium">{{ user.username }}</div>
                                                <small class="text-muted">{{ user.email }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if user.subscription_status == 'past_due' %}
                                        <span class="badge bg-warning">
                                            <span class="material-symbols-outlined me-1" style="font-size: 12px;">schedule</span>
                                            Past Due
                                        </span>
                                        {% elif user.subscription_status == 'unpaid' %}
                                        <span class="badge bg-danger">
                                            <span class="material-symbols-outlined me-1" style="font-size: 12px;">error</span>
                                            Unpaid
                                        </span>
                                        {% elif user.subscription_status == 'incomplete' %}
                                        <span class="badge bg-secondary">
                                            <span class="material-symbols-outlined me-1" style="font-size: 12px;">pending</span>
                                            Incomplete
                                        </span>
                                        {% else %}
                                        <span class="badge bg-dark">{{ user.subscription_status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.subscription_plan %}
                                        <span class="badge bg-info">{{ user.subscription_plan.title() }}</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.last_payment_date %}
                                        <small>{{ user.last_payment_date.strftime('%m/%d/%Y') }}</small>
                                        {% else %}
                                        <small class="text-muted">Never</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.subscription_plan == 'monthly' %}
                                        <span class="text-danger fw-medium">$29.00</span>
                                        {% elif user.subscription_plan == 'annual' %}
                                        <span class="text-danger fw-medium">$299.00</span>
                                        {% else %}
                                        <span class="text-muted">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user.subscription_current_period_end %}
                                        {% set days_overdue = (moment.utcnow() - user.subscription_current_period_end).days %}
                                        {% if days_overdue > 0 %}
                                        <span class="badge bg-danger">{{ days_overdue }} days</span>
                                        {% else %}
                                        <span class="badge bg-warning">Due soon</span>
                                        {% endif %}
                                        {% else %}
                                        <span class="text-muted">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" 
                                                    onclick="sendIndividualReminder({{ user.id }})"
                                                    title="Send Reminder">
                                                <span class="material-symbols-outlined" style="font-size: 14px;">mail</span>
                                            </button>
                                            <button class="btn btn-outline-warning" 
                                                    onclick="retryPayment({{ user.id }})"
                                                    title="Retry Payment">
                                                <span class="material-symbols-outlined" style="font-size: 14px;">refresh</span>
                                            </button>
                                            <button class="btn btn-outline-secondary" 
                                                    onclick="viewStripeCustomer('{{ user.stripe_customer_id }}')"
                                                    title="View in Stripe">
                                                <span class="material-symbols-outlined" style="font-size: 14px;">open_in_new</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <span class="material-symbols-outlined text-success mb-3" style="font-size: 4rem;">check_circle</span>
                        <h4 class="text-success">No Payment Issues!</h4>
                        <p class="text-muted">All subscribers have healthy payment status.</p>
                        <a href="{{ url_for('admin_subscriptions') }}" class="btn btn-primary">
                            <span class="material-symbols-outlined me-2">subscriptions</span>
                            View All Subscriptions
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if users_with_issues %}
    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <span class="material-symbols-outlined me-2">quick_reference</span>
                        Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-warning" onclick="sendPaymentReminders()">
                            <span class="material-symbols-outlined me-2">mail</span>
                            Send All Payment Reminders
                        </button>
                        <button class="btn btn-outline-primary" onclick="downloadPaymentReport()">
                            <span class="material-symbols-outlined me-2">download</span>
                            Download Payment Report
                        </button>
                        <button class="btn btn-outline-secondary" onclick="viewStripeMetrics()">
                            <span class="material-symbols-outlined me-2">analytics</span>
                            View Stripe Metrics
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <span class="material-symbols-outlined me-2">info</span>
                        Resolution Tips
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small">
                        <li class="mb-2">
                            <span class="material-symbols-outlined me-2 text-warning" style="font-size: 16px;">lightbulb</span>
                            Send payment reminders for past due accounts
                        </li>
                        <li class="mb-2">
                            <span class="material-symbols-outlined me-2 text-info" style="font-size: 16px;">credit_card</span>
                            Help users update expired payment methods
                        </li>
                        <li class="mb-2">
                            <span class="material-symbols-outlined me-2 text-success" style="font-size: 16px;">support</span>
                            Reach out personally for high-value customers
                        </li>
                        <li>
                            <span class="material-symbols-outlined me-2 text-primary" style="font-size: 16px;">schedule</span>
                            Monitor payment retry schedules in Stripe
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function sendPaymentReminders() {
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Sending...';
    button.disabled = true;

    fetch('/api/admin/send-payment-reminders', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Sent ${data.sent} payment reminders`, 'success');
        } else {
            showToast('Error sending reminders: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error sending payment reminders', 'error');
    })
    .finally(() => {
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}

function sendIndividualReminder(userId) {
    fetch(`/api/admin/send-payment-reminder/${userId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Payment reminder sent', 'success');
        } else {
            showToast('Error sending reminder: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error sending reminder', 'error');
    });
}

function retryPayment(userId) {
    fetch(`/api/admin/retry-payment/${userId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Payment retry initiated', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('Error retrying payment: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error retrying payment', 'error');
    });
}

function refreshPaymentStatus() {
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Refreshing...';
    button.disabled = true;

    fetch('/api/admin/refresh-payment-status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Payment status refreshed', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error refreshing status: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error refreshing status', 'error');
    })
    .finally(() => {
        button.innerHTML = originalContent;
        button.disabled = false;
    });
}

function viewStripeCustomer(customerId) {
    if (customerId) {
        window.open(`https://dashboard.stripe.com/customers/${customerId}`, '_blank');
    } else {
        showToast('No Stripe customer ID found', 'warning');
    }
}

function downloadPaymentReport() {
    window.location.href = '/api/admin/download-payment-report';
}

function viewStripeMetrics() {
    window.open('https://dashboard.stripe.com/revenue', '_blank');
}
</script>
{% endblock %}
