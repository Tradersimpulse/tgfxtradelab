{% extends "base.html" %}

{% block title %}Dual Stream Control - TGFX Trade Lab Admin{% endblock %}

{% block head %}
<!-- Socket.IO for real-time communication -->
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="text-gradient-primary mb-2">
                    <span class="material-symbols-outlined me-2" style="font-size: 2rem;">live_tv</span>
                    Dual Stream Control
                </h1>
                <p class="text-muted mb-0">Manage Ray and Jordan's concurrent live streams</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('livestream') }}" class="btn btn-outline-primary" target="_blank">
                    <span class="material-symbols-outlined me-2">visibility</span>
                    View as User
                </a>
                <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary">
                    <span class="material-symbols-outlined me-2">arrow_back</span>
                    Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Stream Status Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2">analytics</span>
                    Stream Overview
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary" id="activeStreamCount">{{ active_streams|length }}</h4>
                        <small class="text-muted">Active Streams</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary" id="totalViewersCount">
                            {{ active_streams|map(attribute='viewer_count')|sum }}
                        </h4>
                        <small class="text-muted">Total Viewers</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary" id="recordingStreamsCount">
                            {{ active_streams|selectattr('is_recording')|list|length }}
                        </h4>
                        <small class="text-muted">Recording Now</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary">{{ 2 - active_streams|length }}</h4>
                        <small class="text-muted">Available Slots</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Your Stream Control -->
    <div class="col-lg-6 mb-4">
        <div class="card" style="border-left: 4px solid {{ current_user.stream_color }};">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1">{{ current_user.display_name or current_user.username }}'s Stream</h5>
                    <small class="text-muted">Your streaming controls</small>
                </div>
                {% if user_active_stream %}
                <span class="badge bg-success">
                    <span class="material-symbols-outlined me-1" style="font-size: 12px;">radio_button_checked</span>
                    LIVE
                </span>
                {% else %}
                <span class="badge bg-secondary">Offline</span>
                {% endif %}
            </div>
            
            <div class="card-body">
                {% if user_active_stream %}
                <!-- Your Active Stream Controls -->
                <div class="alert alert-success d-flex align-items-center mb-3">
                    <span class="material-symbols-outlined me-2">radio_button_checked</span>
                    <div class="flex-grow-1">
                        <strong>{{ user_active_stream.title }}</strong>
                        <small class="d-block text-muted">
                            Started {{ user_active_stream.started_at.strftime('%I:%M %p') if user_active_stream.started_at }} • 
                            {{ user_active_stream.viewer_count }} viewers
                        </small>
                    </div>
                </div>

                <!-- Stream Status Display -->
                <div class="mb-3 p-3 border rounded" style="background: #1a1a1a;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-white mb-0">Current Status</h6>
                        <div class="d-flex gap-2">
                            <span class="badge bg-info" id="screenShareStatus">Screen: Off</span>
                            <span class="badge bg-info" id="audioStatus">Audio: Off</span>
                        </div>
                    </div>
                    
                    <!-- Live Audio Indicator -->
                    <div class="d-flex align-items-center mb-2">
                        <span class="material-symbols-outlined me-2" id="micIcon" style="color: #6b7280;">mic_off</span>
                        <div class="audio-bars" id="audioBars">
                            <div class="audio-bar"></div>
                            <div class="audio-bar"></div>
                            <div class="audio-bar"></div>
                            <div class="audio-bar"></div>
                            <div class="audio-bar"></div>
                        </div>
                        <small class="text-muted ms-2" id="audioLevelText">Microphone Off</small>
                    </div>
                    
                    <small class="text-white-50">Viewers will see your screen share and hear your audio when enabled</small>
                </div>

                <!-- Stream Actions -->
                <div class="row">
                    <div class="col-4">
                        <button class="btn btn-primary btn-sm w-100" id="toggleMicBtn" onclick="toggleMicrophone()">
                            <span class="material-symbols-outlined me-1" style="font-size: 16px;">mic</span>
                            Start Audio
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-warning btn-sm w-100" id="toggleScreenBtn" onclick="toggleScreenShare()">
                            <span class="material-symbols-outlined me-1" style="font-size: 16px;">screen_share</span>
                            Share Screen
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-danger btn-sm w-100" onclick="stopUserStream()">
                            <span class="material-symbols-outlined me-1" style="font-size: 16px;">stop</span>
                            End Stream
                        </button>
                    </div>
                </div>
                
                <div class="row mt-2">
                    <div class="col-12">
                        <button class="btn btn-outline-secondary btn-sm w-100" id="toggleRecordingBtn" onclick="toggleRecording()">
                            <span class="material-symbols-outlined me-1" id="recordingIcon" style="font-size: 16px;">fiber_manual_record</span>
                            <span id="recordingText">Start Recording</span>
                        </button>
                    </div>
                </div>

                {% else %}
                <!-- Start Your Stream -->
                {% if can_start_stream %}
                <form id="startUserStreamForm">
                    <div class="mb-3">
                        <label class="form-label">Stream Title</label>
                        <input type="text" class="form-control form-control-sm" id="userStreamTitle" 
                               placeholder="Your stream title..." value="{{ current_user.display_name or current_user.username }}'s Live Session" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Stream Type</label>
                        <select class="form-select form-select-sm" id="userStreamType">
                            <option value="trading">Live Trading</option>
                            <option value="analysis">Market Analysis</option>
                            <option value="education">Educational Content</option>
                            <option value="general">General Discussion</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <textarea class="form-control form-control-sm" id="userStreamDescription" rows="2" 
                                  placeholder="What will you be covering?"></textarea>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <span class="material-symbols-outlined me-2">play_arrow</span>
                            Start Your Stream
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="text-center py-3">
                    <span class="material-symbols-outlined text-muted mb-2" style="font-size: 2rem;">block</span>
                    <p class="text-muted mb-0">
                        {% if active_streams|length >= 2 %}
                        Maximum streams reached (2/2)
                        {% else %}
                        You don't have streaming permissions
                        {% endif %}
                    </p>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Other Active Streams -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2">groups</span>
                    Other Active Streams
                </h5>
            </div>
            <div class="card-body">
                {% set other_streams = active_streams|rejectattr('created_by', 'equalto', current_user.id)|list %}
                {% if other_streams %}
                {% for stream in other_streams %}
                <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded" 
                     style="border-left: 4px solid {{ stream.creator.stream_color }} !important;">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <h6 class="mb-0 me-2">{{ stream.title }}</h6>
                            <span class="badge" style="background-color: {{ stream.creator.stream_color }};">
                                {{ stream.streamer_name }}
                            </span>
                        </div>
                        <small class="text-muted">
                            {{ stream.viewer_count }} viewers • 
                            Started {{ stream.started_at.strftime('%I:%M %p') if stream.started_at }}
                            {% if stream.is_recording %}• Recording{% endif %}
                        </small>
                    </div>
                    <div class="d-flex gap-1">
                        <a href="{{ url_for('livestream') }}" class="btn btn-outline-primary btn-sm" target="_blank">
                            <span class="material-symbols-outlined" style="font-size: 16px;">visibility</span>
                        </a>
                        <button class="btn btn-outline-secondary btn-sm" onclick="shareStream({{ stream.id }})">
                            <span class="material-symbols-outlined" style="font-size: 16px;">share</span>
                        </button>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-3">
                    <span class="material-symbols-outlined text-muted mb-2" style="font-size: 2rem;">live_tv</span>
                    <p class="text-muted mb-0">No other streams active</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Streams History -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2">history</span>
                    Recent Streams
                </h5>
            </div>
            <div class="card-body">
                {% if recent_streams %}
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Streamer</th>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Duration</th>
                                <th>Viewers</th>
                                <th>Started</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stream in recent_streams[:10] %}
                            <tr>
                                <td>
                                    <span class="badge" style="background-color: {{ stream.creator.stream_color }};">
                                        {{ stream.streamer_name or stream.creator.username }}
                                    </span>
                                </td>
                                <td>{{ stream.title[:30] }}{% if stream.title|length > 30 %}...{% endif %}</td>
                                <td>{{ stream.stream_type|title }}</td>
                                <td>
                                    {% if stream.started_at and stream.ended_at %}
                                    {{ ((stream.ended_at - stream.started_at).total_seconds() / 60)|round(0)|int }}m
                                    {% elif stream.started_at and stream.is_active %}
                                    <span class="text-success">Live</span>
                                    {% else %}
                                    --
                                    {% endif %}
                                </td>
                                <td>{{ stream.viewer_count }}</td>
                                <td>{{ stream.started_at.strftime('%m/%d %I:%M %p') if stream.started_at else '--' }}</td>
                                <td>
                                    {% if stream.is_active %}
                                    <span class="badge bg-success">Live</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Ended</span>
                                    {% endif %}
                                    {% if stream.recording_url %}
                                    <span class="badge bg-info ms-1">Recorded</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <span class="material-symbols-outlined text-muted mb-2" style="font-size: 2rem;">history</span>
                    <p class="text-muted mb-0">No recent streams</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global state
window.streamState = {
    isAudioActive: false,
    isScreenSharing: false,
    isRecording: false,
    audioContext: null,
    mediaStream: null,
    screenStream: null,
    audioChunks: [],
    mediaRecorder: null
};

// Enhanced WebSocket Manager with better debugging and error handling
window.WebSocketManager = {
    socket: null,
    isConnected: false,
    reconnectAttempts: 0,
    maxReconnectAttempts: 5,
    currentStreamId: null,
    isAdmin: false,
    canBroadcast: false,
    
    init: function() {
        console.log('🔌 Initializing enhanced WebSocket connection...');
        
        try {
            this.socket = io({
                transports: ['websocket', 'polling'],
                timeout: 10000,
                forceNew: true
            });
            
            this.setupEventHandlers();
            
        } catch (error) {
            console.error('❌ Failed to initialize WebSocket:', error);
            this.fallbackToLocalStorage();
        }
    },
    
    setupEventHandlers: function() {
        this.socket.on('connect', () => {
            console.log('✅ WebSocket connected');
            this.isConnected = true;
            this.reconnectAttempts = 0;
            this.showConnectionStatus('connected');
            
            // Request debug info to verify our status
            this.socket.emit('debug_info', {});
            
            // Join stream room if we have an active stream
            if (this.currentStreamId) {
                this.joinStreamAsAdmin(this.currentStreamId);
            }
        });
        
        this.socket.on('disconnect', (reason) => {
            console.log('❌ WebSocket disconnected:', reason);
            this.isConnected = false;
            this.canBroadcast = false;
            this.showConnectionStatus('disconnected');
        });
        
        this.socket.on('connect_error', (error) => {
            console.error('❌ WebSocket connection error:', error);
            this.handleConnectionError();
        });
        
        // Enhanced connection status handler
        this.socket.on('connection_status', (data) => {
            console.log('📊 Connection status:', data);
            if (data.user_info) {
                this.isAdmin = data.user_info.is_admin;
                console.log(`👤 User admin status: ${this.isAdmin}`);
            }
        });
        
        // Admin/viewer status handlers
        this.socket.on('admin_status', (data) => {
            console.log('🎬 Admin status received:', data);
            this.canBroadcast = data.can_broadcast;
            this.isAdmin = data.is_admin;
            showToast('✅ Connected as stream admin', 'success');
        });
        
        this.socket.on('viewer_status', (data) => {
            console.log('👥 Viewer status received:', data);
            this.canBroadcast = false;
            this.isAdmin = false;
        });
        
        // Debug response handler
        this.socket.on('debug_response', (data) => {
            console.log('🔍 Debug response:', data);
            this.isAdmin = data.user_info.is_admin || false;
            this.canBroadcast = this.isAdmin && data.user_info.can_stream;
            
            if (this.canBroadcast) {
                console.log('✅ Broadcasting permissions verified');
            } else {
                console.log('❌ No broadcasting permissions');
                console.log('  - Admin:', data.user_info.is_admin);
                console.log('  - Can Stream:', data.user_info.can_stream);
                console.log('  - Authenticated:', data.current_user_authenticated);
            }
        });
        
        this.socket.on('stream_update', (data) => {
            console.log('📡 Stream update received:', data);
            this.handleStreamUpdate(data);
        });
        
        this.socket.on('screen_frame', (data) => {
            this.handleScreenFrame(data);
        });
        
        this.socket.on('audio_chunk', (data) => {
            this.handleAudioChunk(data);
        });
        
        this.socket.on('status_update', (data) => {
            this.handleStatusUpdate(data);
        });
        
        this.socket.on('viewer_joined', (data) => {
            console.log('👥 Another viewer joined:', data);
            this.updateViewerCounts();
        });
        
        this.socket.on('viewer_left', (data) => {
            console.log('👋 Viewer left:', data);
            this.updateViewerCounts();
        });
        
        this.socket.on('admin_joined', (data) => {
            console.log('🎬 Admin joined stream:', data);
            showToast('🎬 Stream admin is online!', 'success');
        });
        
        this.socket.on('admin_left', (data) => {
            console.log('👋 Admin left stream:', data);
            showToast('👋 Stream admin went offline', 'info');
        });
        
        this.socket.on('error', (data) => {
            console.error('❌ WebSocket error:', data.message);
            
            // Enhanced error handling
            if (data.message.includes('Not authorized')) {
                console.log('🔐 Authorization error - requesting debug info...');
                this.socket.emit('debug_info', {});
                
                // Show more helpful error message
                if (data.message.includes('broadcast audio')) {
                    showToast('❌ Audio broadcast failed - checking permissions...', 'error');
                    this.debugBroadcastPermissions();
                } else if (data.message.includes('broadcast screen')) {
                    showToast('❌ Screen broadcast failed - checking permissions...', 'error');
                    this.debugBroadcastPermissions();
                } else {
                    showToast('❌ ' + data.message, 'error');
                }
            } else {
                showToast('❌ ' + data.message, 'error');
            }
        });
    },
    
    debugBroadcastPermissions: function() {
        console.log('🔍 Debugging broadcast permissions:');
        console.log('  - Connected:', this.isConnected);
        console.log('  - Is Admin:', this.isAdmin);
        console.log('  - Can Broadcast:', this.canBroadcast);
        console.log('  - Current Stream ID:', this.currentStreamId);
        
        // Request fresh debug info
        if (this.isConnected) {
            this.socket.emit('debug_info', {});
        }
    },
    
    joinStreamAsAdmin: function(streamId) {
        this.currentStreamId = streamId;
        if (this.isConnected) {
            console.log(`🎬 Attempting to join stream ${streamId} as admin...`);
            this.socket.emit('join_stream', { stream_id: streamId });
        }
    },
    
    sendStreamControl: function(streamId, controlType, data) {
        if (!this.isConnected) {
            console.log('⚠️ Not connected - using localStorage fallback');
            this.localStorageFallback('control', { type: controlType, data: data });
            return;
        }
        
        console.log(`🎛️ Sending stream control: ${controlType} for stream ${streamId}`);
        this.socket.emit('stream_control', {
            stream_id: streamId,
            type: controlType,
            data: data
        });
    },
    
    sendScreenFrame: function(streamId, frameData) {
        if (!this.isConnected) {
            this.localStorageFallback('screen_frame', { imageData: frameData });
            return;
        }
        
        if (!this.canBroadcast) {
            console.log('❌ Cannot broadcast - no permissions');
            this.debugBroadcastPermissions();
            return;
        }
        
        // Limit frame size before sending
        if (frameData.length > 2000000) {
            console.warn('⚠️ Frame too large, skipping:', frameData.length);
            return;
        }
        
        this.socket.emit('screen_frame', {
            stream_id: streamId,
            frame_data: frameData
        });
    },
    
    sendAudioChunk: function(streamId, audioData) {
        if (!this.isConnected) {
            this.localStorageFallback('audio_chunk', { audioData: audioData });
            return;
        }
        
        if (!this.canBroadcast) {
            console.log('❌ Cannot broadcast audio - no permissions');
            this.debugBroadcastPermissions();
            showToast('❌ Audio broadcast permission denied', 'error');
            return;
        }
        
        // Limit audio chunk size
        if (audioData.length > 1000000) {
            console.warn('⚠️ Audio chunk too large, skipping:', audioData.length);
            return;
        }
        
        console.log('🎵 Sending audio chunk:', audioData.substring(0, 50) + '...');
        this.socket.emit('audio_chunk', {
            stream_id: streamId,
            audio_data: audioData
        });
    },
    
    sendStatusUpdate: function(streamId, status) {
        if (!this.isConnected) {
            this.localStorageFallback('status_update', status);
            return;
        }
        
        if (!this.canBroadcast) {
            console.log('❌ Cannot update status - no permissions');
            return;
        }
        
        this.socket.emit('status_update', {
            stream_id: streamId,
            status: status
        });
    },
    
    handleConnectionError: function() {
        this.reconnectAttempts++;
        
        if (this.reconnectAttempts <= this.maxReconnectAttempts) {
            console.log(`🔄 Reconnection attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts}`);
            setTimeout(() => {
                this.socket.connect();
            }, 2000 * this.reconnectAttempts);
        } else {
            console.log('❌ Max reconnection attempts reached, using localStorage fallback');
            this.fallbackToLocalStorage();
        }
    },
    
    fallbackToLocalStorage: function() {
        console.log('📡 Using localStorage fallback communication');
        this.initLocalStorageFallback();
    },
    
    initLocalStorageFallback: function() {
        setInterval(() => {
            this.updateStatus();
        }, 100);
    },
    
    updateStatus: function() {
        const status = {
            audio: window.streamState.isAudioActive,
            screen: window.streamState.isScreenSharing,
            timestamp: Date.now()
        };
        
        localStorage.setItem('admin_stream_status', JSON.stringify(status));
    },
    
    localStorageFallback: function(type, data) {
        const key = `admin_${type}`;
        const payload = {
            ...data,
            timestamp: Date.now()
        };
        
        try {
            localStorage.setItem(key, JSON.stringify(payload));
        } catch (e) {
            console.warn('⚠️ localStorage fallback failed:', e);
        }
    },
    
    handleStreamUpdate: function(data) {
        // Handle stream control updates from other admins
        console.log('📡 Stream update received:', data);
        // Implementation for handling stream updates
    },
    
    handleScreenFrame: function(data) {
        // Handle incoming screen frames (for viewer mode)
        console.log('🖥️ Screen frame received');
    },
    
    handleAudioChunk: function(data) {
        // Handle incoming audio chunks (for viewer mode)
        console.log('🎵 Audio chunk received');
    },
    
    handleStatusUpdate: function(data) {
        // Handle status updates
        console.log('📊 Status update received:', data);
    },
    
    updateViewerCounts: function() {
        // Update viewer count displays
        document.querySelectorAll('.stream-viewer-count').forEach(el => {
            const currentCount = parseInt(el.textContent) || 0;
            el.textContent = currentCount === 1 ? '1 viewer' : currentCount + ' viewers';
        });
    },
    
    showConnectionStatus: function(status) {
        let indicator = document.querySelector('.connection-indicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.className = 'connection-indicator';
            indicator.style.cssText = 'position:fixed;top:10px;left:10px;background:rgba(0,0,0,0.8);color:white;padding:4px 8px;border-radius:4px;font-size:12px;z-index:1001;';
            document.body.appendChild(indicator);
        }
        
        if (status === 'connected') {
            indicator.textContent = '🟢 Connected' + (this.canBroadcast ? ' (Can Broadcast)' : ' (View Only)');
            indicator.style.background = 'rgba(16, 185, 129, 0.8)';
            setTimeout(() => indicator.style.display = 'none', 5000);
        } else {
            indicator.textContent = '🔴 Disconnected';
            indicator.style.background = 'rgba(239, 68, 68, 0.8)';
            indicator.style.display = 'block';
        }
    }
};

// Enhanced audio functions with better permission checking
window.startAudio = async function() {
    try {
        console.log('🎤 Starting enhanced audio capture...');
        
        // Check broadcast permissions first
        if (!window.WebSocketManager.canBroadcast) {
            console.log('❌ No broadcast permissions - requesting debug info');
            window.WebSocketManager.debugBroadcastPermissions();
            showToast('❌ No audio broadcast permissions', 'error');
            return;
        }
        
        window.streamState.mediaStream = await navigator.mediaDevices.getUserMedia({
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true,
                sampleRate: 44100,
                channelCount: 1
            }
        });
        
        window.streamState.audioContext = new (window.AudioContext || window.webkitAudioContext)({
            sampleRate: 44100
        });
        
        if (window.streamState.audioContext.state === 'suspended') {
            await window.streamState.audioContext.resume();
        }
        
        const source = window.streamState.audioContext.createMediaStreamSource(window.streamState.mediaStream);
        const analyser = window.streamState.audioContext.createAnalyser();
        analyser.fftSize = 256;
        
        source.connect(analyser);
        
        // Start real audio recording for streaming
        startAudioRecording();
        
        // Start visualization
        startAudioVisualization(analyser);
        
        window.streamState.isAudioActive = true;
        updateAudioUI(true);
        
        // Notify WebSocket with permission check
        const streamId = getCurrentStreamId();
        if (streamId && window.WebSocketManager.canBroadcast) {
            window.WebSocketManager.sendStreamControl(streamId, 'audio_start', {});
            window.WebSocketManager.sendStatusUpdate(streamId, {
                audio: true,
                screen: window.streamState.isScreenSharing
            });
            
            showToast('🎤 Audio started - broadcasting live!', 'success');
        } else {
            showToast('⚠️ Audio started but cannot broadcast', 'warning');
        }
        
    } catch (error) {
        console.error('❌ Failed to start audio:', error);
        if (error.name === 'NotAllowedError') {
            showToast('⚠️ Microphone access denied. Please allow microphone permissions.', 'warning');
        } else {
            showToast('❌ Failed to start microphone: ' + error.message, 'error');
        }
    }
};

// Enhanced debug function
window.debugStreamConnection = function(streamId) {
    console.log('=== 🔍 ENHANCED DEBUG STREAM CONNECTION ===');
    console.log('Stream ID:', streamId);
    console.log('WebSocket Connected:', window.WebSocketManager.isConnected);
    console.log('Is Admin:', window.WebSocketManager.isAdmin);
    console.log('Can Broadcast:', window.WebSocketManager.canBroadcast);
    console.log('Current Stream ID:', window.WebSocketManager.currentStreamId);
    console.log('Stream State:', window.streamState);
    
    // Request fresh debug info from server
    if (window.WebSocketManager.isConnected) {
        window.WebSocketManager.socket.emit('debug_info', {});
    }
    
    showToast('🔍 Enhanced debug info logged to console (F12)', 'info');
};
</script>

<style>
.audio-bars {
    display: flex;
    align-items: end;
    gap: 3px;
    width: 60px;
    height: 30px;
}

.audio-bar {
    width: 8px;
    min-height: 5px;
    height: 10%;
    background-color: #6b7280;
    border-radius: 2px;
    transition: height 0.1s ease, background-color 0.1s ease;
}

.btn-outline-secondary:hover {
    background-color: #6c757d;
    border-color: #6c757d;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

.table-dark {
    --bs-table-bg: transparent;
}

.card {
    transition: transform 0.3s ease;
}

.card:hover {
    transform: translateY(-1px);
}

.connection-indicator {
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 1001;
}

.connection-indicator.good { background: rgba(16, 185, 129, 0.8); }
.connection-indicator.poor { background: rgba(239, 68, 68, 0.8); }

@media (max-width: 768px) {
    .col-lg-6 {
        margin-bottom: 1rem;
    }
    
    .audio-bars {
        width: 50px;
        height: 25px;
    }
    
    .audio-bar {
        width: 6px;
    }
}
</style>
{% endblock %}
