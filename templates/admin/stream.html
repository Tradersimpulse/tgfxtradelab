{% extends "base.html" %}

{% block title %}Dual Stream Control - TGFX Trade Lab Admin{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="text-gradient-primary mb-2">
                    <span class="material-symbols-outlined me-2" style="font-size: 2rem;">live_tv</span>
                    Dual Stream Control
                </h1>
                <p class="text-muted mb-0">Manage Ray and Jordan's concurrent live streams</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('livestream') }}" class="btn btn-outline-primary" target="_blank">
                    <span class="material-symbols-outlined me-2">visibility</span>
                    View as User
                </a>
                <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary">
                    <span class="material-symbols-outlined me-2">arrow_back</span>
                    Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Stream Status Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2">analytics</span>
                    Stream Overview
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary" id="activeStreamCount">{{ active_streams|length }}</h4>
                        <small class="text-muted">Active Streams</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary" id="totalViewersCount">
                            {{ active_streams|map(attribute='viewer_count')|sum }}
                        </h4>
                        <small class="text-muted">Total Viewers</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary" id="recordingStreamsCount">
                            {{ active_streams|selectattr('is_recording')|list|length }}
                        </h4>
                        <small class="text-muted">Recording Now</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary">{{ 2 - active_streams|length }}</h4>
                        <small class="text-muted">Available Slots</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Your Stream Control -->
    <div class="col-lg-6 mb-4">
        <div class="card" style="border-left: 4px solid {{ current_user.stream_color }};">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1">{{ current_user.display_name or current_user.username }}'s Stream</h5>
                    <small class="text-muted">Your streaming controls</small>
                </div>
                {% if user_active_stream %}
                <span class="badge bg-success">
                    <span class="material-symbols-outlined me-1" style="font-size: 12px;">radio_button_checked</span>
                    LIVE
                </span>
                {% else %}
                <span class="badge bg-secondary">Offline</span>
                {% endif %}
            </div>
            
            <div class="card-body">
                {% if user_active_stream %}
                <!-- Your Active Stream Controls -->
                <div class="alert alert-success d-flex align-items-center mb-3">
                    <span class="material-symbols-outlined me-2">radio_button_checked</span>
                    <div class="flex-grow-1">
                        <strong>{{ user_active_stream.title }}</strong>
                        <small class="d-block text-muted">
                            Started {{ user_active_stream.started_at.strftime('%I:%M %p') if user_active_stream.started_at }} ‚Ä¢ 
                            {{ user_active_stream.viewer_count }} viewers
                        </small>
                    </div>
                </div>

                <!-- Stream Status Display -->
                <div class="mb-3 p-3 border rounded" style="background: #1a1a1a;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="text-white mb-0">Current Status</h6>
                        <div class="d-flex gap-2">
                            <span class="badge bg-info" id="screenShareStatus">Screen: Off</span>
                            <span class="badge bg-info" id="audioStatus">Audio: Off</span>
                        </div>
                    </div>
                    
                    <!-- Live Audio Indicator -->
                    <div class="d-flex align-items-center mb-2">
                        <span class="material-symbols-outlined me-2" id="micIcon" style="color: #6b7280;">mic_off</span>
                        <div class="audio-bars" id="audioBars">
                            <div class="audio-bar"></div>
                            <div class="audio-bar"></div>
                            <div class="audio-bar"></div>
                            <div class="audio-bar"></div>
                            <div class="audio-bar"></div>
                        </div>
                        <small class="text-muted ms-2" id="audioLevelText">Microphone Off</small>
                    </div>
                    
                    <small class="text-white-50">Viewers will see your screen share and hear your audio when enabled</small>
                </div>

                <!-- Stream Actions -->
                <div class="row">
                    <div class="col-4">
                        <button class="btn btn-primary btn-sm w-100" id="toggleMicBtn" onclick="toggleMicrophone()">
                            <span class="material-symbols-outlined me-1" style="font-size: 16px;">mic</span>
                            Start Audio
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-warning btn-sm w-100" id="toggleScreenBtn" onclick="toggleScreenShare()">
                            <span class="material-symbols-outlined me-1" style="font-size: 16px;">screen_share</span>
                            Share Screen
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-danger btn-sm w-100" onclick="stopUserStream()">
                            <span class="material-symbols-outlined me-1" style="font-size: 16px;">stop</span>
                            End Stream
                        </button>
                    </div>
                </div>
                
                <div class="row mt-2">
                    <div class="col-12">
                        <button class="btn btn-outline-secondary btn-sm w-100" id="toggleRecordingBtn" onclick="toggleRecording()">
                            <span class="material-symbols-outlined me-1" id="recordingIcon" style="font-size: 16px;">fiber_manual_record</span>
                            <span id="recordingText">Start Recording</span>
                        </button>
                    </div>
                </div>

                {% else %}
                <!-- Start Your Stream -->
                {% if can_start_stream %}
                <form id="startUserStreamForm">
                    <div class="mb-3">
                        <label class="form-label">Stream Title</label>
                        <input type="text" class="form-control form-control-sm" id="userStreamTitle" 
                               placeholder="Your stream title..." value="{{ current_user.display_name or current_user.username }}'s Live Session" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Stream Type</label>
                        <select class="form-select form-select-sm" id="userStreamType">
                            <option value="trading">Live Trading</option>
                            <option value="analysis">Market Analysis</option>
                            <option value="education">Educational Content</option>
                            <option value="general">General Discussion</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <textarea class="form-control form-control-sm" id="userStreamDescription" rows="2" 
                                  placeholder="What will you be covering?"></textarea>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <span class="material-symbols-outlined me-2">play_arrow</span>
                            Start Your Stream
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="text-center py-3">
                    <span class="material-symbols-outlined text-muted mb-2" style="font-size: 2rem;">block</span>
                    <p class="text-muted mb-0">
                        {% if active_streams|length >= 2 %}
                        Maximum streams reached (2/2)
                        {% else %}
                        You don't have streaming permissions
                        {% endif %}
                    </p>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Other Active Streams -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2">groups</span>
                    Other Active Streams
                </h5>
            </div>
            <div class="card-body">
                {% set other_streams = active_streams|rejectattr('created_by', 'equalto', current_user.id)|list %}
                {% if other_streams %}
                {% for stream in other_streams %}
                <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded" 
                     style="border-left: 4px solid {{ stream.creator.stream_color }} !important;">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <h6 class="mb-0 me-2">{{ stream.title }}</h6>
                            <span class="badge" style="background-color: {{ stream.creator.stream_color }};">
                                {{ stream.streamer_name }}
                            </span>
                        </div>
                        <small class="text-muted">
                            {{ stream.viewer_count }} viewers ‚Ä¢ 
                            Started {{ stream.started_at.strftime('%I:%M %p') if stream.started_at }}
                            {% if stream.is_recording %}‚Ä¢ Recording{% endif %}
                        </small>
                    </div>
                    <div class="d-flex gap-1">
                        <a href="{{ url_for('livestream') }}" class="btn btn-outline-primary btn-sm" target="_blank">
                            <span class="material-symbols-outlined" style="font-size: 16px;">visibility</span>
                        </a>
                        <button class="btn btn-outline-secondary btn-sm" onclick="shareStream({{ stream.id }})">
                            <span class="material-symbols-outlined" style="font-size: 16px;">share</span>
                        </button>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-3">
                    <span class="material-symbols-outlined text-muted mb-2" style="font-size: 2rem;">live_tv</span>
                    <p class="text-muted mb-0">No other streams active</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Streams History -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2">history</span>
                    Recent Streams
                </h5>
            </div>
            <div class="card-body">
                {% if recent_streams %}
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Streamer</th>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Duration</th>
                                <th>Viewers</th>
                                <th>Started</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stream in recent_streams[:10] %}
                            <tr>
                                <td>
                                    <span class="badge" style="background-color: {{ stream.creator.stream_color }};">
                                        {{ stream.streamer_name or stream.creator.username }}
                                    </span>
                                </td>
                                <td>{{ stream.title[:30] }}{% if stream.title|length > 30 %}...{% endif %}</td>
                                <td>{{ stream.stream_type|title }}</td>
                                <td>
                                    {% if stream.started_at and stream.ended_at %}
                                    {{ ((stream.ended_at - stream.started_at).total_seconds() / 60)|round(0)|int }}m
                                    {% elif stream.started_at and stream.is_active %}
                                    <span class="text-success">Live</span>
                                    {% else %}
                                    --
                                    {% endif %}
                                </td>
                                <td>{{ stream.viewer_count }}</td>
                                <td>{{ stream.started_at.strftime('%m/%d %I:%M %p') if stream.started_at else '--' }}</td>
                                <td>
                                    {% if stream.is_active %}
                                    <span class="badge bg-success">Live</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Ended</span>
                                    {% endif %}
                                    {% if stream.recording_url %}
                                    <span class="badge bg-info ms-1">Recorded</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <span class="material-symbols-outlined text-muted mb-2" style="font-size: 2rem;">history</span>
                    <p class="text-muted mb-0">No recent streams</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global state
window.streamState = {
    isAudioActive: false,
    isScreenSharing: false,
    isRecording: false,
    audioContext: null,
    mediaStream: null,
    screenStream: null
};

// Simple communication system using localStorage polling
window.streamingComm = {
    init: function() {
        console.log('üîÑ Initializing simplified streaming communication');
        
        // Poll every 500ms to update status
        setInterval(() => {
            this.updateStatus();
        }, 500);
    },
    
    updateStatus: function() {
        const status = {
            audio: window.streamState.isAudioActive,
            screen: window.streamState.isScreenSharing,
            timestamp: Date.now()
        };
        
        localStorage.setItem('admin_stream_status', JSON.stringify(status));
    },
    
    broadcastScreenFrame: function(imageData) {
        const frameData = {
            imageData: imageData,
            timestamp: Date.now()
        };
        
        localStorage.setItem('admin_screen_frame', JSON.stringify(frameData));
    }
};

// Audio streaming functions
window.toggleMicrophone = async function() {
    if (window.streamState.isAudioActive) {
        stopAudio();
    } else {
        await startAudio();
    }
};

async function startAudio() {
    try {
        console.log('üé§ Starting audio capture...');
        
        // Get microphone access
        window.streamState.mediaStream = await navigator.mediaDevices.getUserMedia({
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }
        });
        
        // Create audio context
        window.streamState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        if (window.streamState.audioContext.state === 'suspended') {
            await window.streamState.audioContext.resume();
        }
        
        // Set up audio analysis
        const source = window.streamState.audioContext.createMediaStreamSource(window.streamState.mediaStream);
        const analyser = window.streamState.audioContext.createAnalyser();
        analyser.fftSize = 256;
        
        source.connect(analyser);
        
        // Start audio visualization
        startAudioVisualization(analyser);
        
        // Update state
        window.streamState.isAudioActive = true;
        updateAudioUI(true);
        
        // Store audio data for viewers
        storeAudioData(analyser);
        
        showToast('üé§ Microphone started - Viewers can now hear you!', 'success');
        
    } catch (error) {
        console.error('‚ùå Failed to start audio:', error);
        
        if (error.name === 'NotAllowedError') {
            showToast('‚ö†Ô∏è Microphone access denied. Please allow microphone permissions and try again.', 'warning');
        } else {
            showToast('‚ùå Failed to start microphone: ' + error.message, 'error');
        }
    }
}

function stopAudio() {
    console.log('üîá Stopping audio...');
    
    if (window.streamState.mediaStream) {
        window.streamState.mediaStream.getTracks().forEach(track => track.stop());
        window.streamState.mediaStream = null;
    }
    
    if (window.streamState.audioContext && window.streamState.audioContext.state !== 'closed') {
        window.streamState.audioContext.close();
        window.streamState.audioContext = null;
    }
    
    window.streamState.isAudioActive = false;
    updateAudioUI(false);
    
    // Clear audio data
    localStorage.removeItem('admin_audio_data');
    
    showToast('üîá Microphone stopped', 'info');
}

function startAudioVisualization(analyser) {
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    
    function updateBars() {
        if (!window.streamState.isAudioActive) return;
        
        analyser.getByteFrequencyData(dataArray);
        
        // Update audio bars
        const bars = document.querySelectorAll('.audio-bar');
        const audioLevel = Array.from(dataArray).reduce((a, b) => a + b) / bufferLength;
        
        bars.forEach((bar, index) => {
            const value = dataArray[index * 8] || 0;
            const height = Math.max(10, (value / 255) * 100);
            
            bar.style.height = height + '%';
            
            if (value > 100) {
                bar.style.backgroundColor = '#10B981';
            } else if (value > 50) {
                bar.style.backgroundColor = '#fbbf24';
            } else {
                bar.style.backgroundColor = '#6b7280';
            }
        });
        
        // Update audio level text
        const audioLevelText = document.getElementById('audioLevelText');
        if (audioLevelText) {
            if (audioLevel > 10) {
                audioLevelText.textContent = 'Speaking...';
                audioLevelText.style.color = '#10B981';
            } else {
                audioLevelText.textContent = 'Microphone Active';
                audioLevelText.style.color = '#6b7280';
            }
        }
        
        requestAnimationFrame(updateBars);
    }
    
    updateBars();
}

function storeAudioData(analyser) {
    const bufferLength = analyser.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    
    function broadcastAudio() {
        if (!window.streamState.isAudioActive) return;
        
        analyser.getByteFrequencyData(dataArray);
        
        const audioLevel = Array.from(dataArray).reduce((a, b) => a + b) / bufferLength;
        
        if (audioLevel > 5) {
            const audioData = {
                level: audioLevel,
                frequency: Array.from(dataArray.slice(0, 32)),
                timestamp: Date.now()
            };
            
            localStorage.setItem('admin_audio_data', JSON.stringify(audioData));
        }
        
        setTimeout(broadcastAudio, 100); // 10 times per second
    }
    
    broadcastAudio();
}

function updateAudioUI(isActive) {
    const micBtn = document.getElementById('toggleMicBtn');
    const micIcon = document.getElementById('micIcon');
    const audioStatus = document.getElementById('audioStatus');
    const audioLevelText = document.getElementById('audioLevelText');
    
    if (isActive) {
        micBtn.className = 'btn btn-success btn-sm w-100';
        micBtn.innerHTML = '<span class="material-symbols-outlined me-1" style="font-size: 16px;">mic_off</span>Stop Audio';
        micIcon.style.color = '#10B981';
        micIcon.textContent = 'mic';
        audioStatus.textContent = 'Audio: Live';
        audioStatus.className = 'badge bg-success';
        audioLevelText.textContent = 'Microphone Active';
    } else {
        micBtn.className = 'btn btn-primary btn-sm w-100';
        micBtn.innerHTML = '<span class="material-symbols-outlined me-1" style="font-size: 16px;">mic</span>Start Audio';
        micIcon.style.color = '#6b7280';
        micIcon.textContent = 'mic_off';
        audioStatus.textContent = 'Audio: Off';
        audioStatus.className = 'badge bg-info';
        audioLevelText.textContent = 'Microphone Off';
        
        // Reset audio bars
        const bars = document.querySelectorAll('.audio-bar');
        bars.forEach(bar => {
            bar.style.height = '10%';
            bar.style.backgroundColor = '#6b7280';
        });
    }
}

// Screen sharing functions
window.toggleScreenShare = async function() {
    if (window.streamState.isScreenSharing) {
        stopScreenShare();
    } else {
        await startScreenShare();
    }
};

async function startScreenShare() {
    try {
        console.log('üñ•Ô∏è Starting screen share...');
        
        // Try to get real screen capture
        if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
            try {
                window.streamState.screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 15 }
                    },
                    audio: false
                });
                
                console.log('‚úÖ Real screen capture successful');
                
            } catch (error) {
                if (error.name === 'NotAllowedError') {
                    showToast('‚ö†Ô∏è Screen sharing was denied. Please allow screen access.', 'warning');
                    return;
                }
                
                console.log('‚ÑπÔ∏è Real screen capture failed, using demo');
                window.streamState.screenStream = createDemoStream();
            }
        } else {
            console.log('üé≠ Using demo screen share');
            window.streamState.screenStream = createDemoStream();
        }
        
        // Start broadcasting frames
        startScreenBroadcast();
        
        window.streamState.isScreenSharing = true;
        updateScreenShareUI(true);
        
        // Handle stream end
        if (window.streamState.screenStream.getVideoTracks) {
            window.streamState.screenStream.getVideoTracks().forEach(track => {
                track.onended = () => {
                    console.log('üõë Screen share ended by user');
                    stopScreenShare();
                };
            });
        }
        
        showToast('üñ•Ô∏è Screen sharing started - Viewers can now see your screen!', 'success');
        
    } catch (error) {
        console.error('‚ùå Screen share failed:', error);
        showToast('‚ùå Screen sharing failed: ' + error.message, 'error');
    }
}

function stopScreenShare() {
    console.log('üõë Stopping screen share...');
    
    if (window.streamState.screenStream) {
        if (window.streamState.screenStream.getTracks) {
            window.streamState.screenStream.getTracks().forEach(track => track.stop());
        }
        window.streamState.screenStream = null;
    }
    
    window.streamState.isScreenSharing = false;
    updateScreenShareUI(false);
    
    // Clear screen data
    localStorage.removeItem('admin_screen_frame');
    
    showToast('üõë Screen sharing stopped', 'info');
}

function startScreenBroadcast() {
    const video = document.createElement('video');
    video.autoplay = true;
    video.muted = true;
    video.srcObject = window.streamState.screenStream;
    
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    video.addEventListener('loadedmetadata', () => {
        canvas.width = 1280;
        canvas.height = 720;
        
        function captureFrame() {
            if (!window.streamState.isScreenSharing) return;
            
            if (video.readyState >= 2) {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                
                // Broadcast frame
                window.streamingComm.broadcastScreenFrame(imageData);
            }
            
            if (window.streamState.isScreenSharing) {
                setTimeout(captureFrame, 100); // 10 FPS
            }
        }
        
        video.play().then(() => {
            captureFrame();
        });
    });
}

function createDemoStream() {
    const canvas = document.createElement('canvas');
    canvas.width = 1280;
    canvas.height = 720;
    const ctx = canvas.getContext('2d');
    
    let frame = 0;
    function animate() {
        ctx.fillStyle = '#1a1a1a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = '#10B981';
        ctx.font = 'bold 48px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Admin Live Screen Share', 640, 150);
        
        ctx.fillStyle = '#ffffff';
        ctx.font = '24px Arial';
        ctx.fillText('Demo Mode - Real screen sharing available', 640, 200);
        
        // Animated chart
        ctx.strokeStyle = '#10B981';
        ctx.lineWidth = 3;
        ctx.beginPath();
        for (let i = 100; i < 1180; i += 10) {
            const y = 400 + Math.sin((i + frame * 2) * 0.01) * 100;
            if (i === 100) ctx.moveTo(i, y);
            else ctx.lineTo(i, y);
        }
        ctx.stroke();
        
        // Live indicator
        ctx.fillStyle = '#ff0000';
        ctx.beginPath();
        ctx.arc(100, 100, 12, 0, 2 * Math.PI);
        ctx.fill();
        
        ctx.fillStyle = '#ffffff';
        ctx.font = '20px Arial';
        ctx.textAlign = 'left';
        ctx.fillText('‚óè LIVE', 120, 110);
        
        frame++;
        if (window.streamState.isScreenSharing) {
            requestAnimationFrame(animate);
        }
    }
    animate();
    
    return canvas.captureStream(15);
}

function updateScreenShareUI(isActive) {
    const screenBtn = document.getElementById('toggleScreenBtn');
    const screenStatus = document.getElementById('screenShareStatus');
    
    if (isActive) {
        screenBtn.className = 'btn btn-success btn-sm w-100';
        screenBtn.innerHTML = '<span class="material-symbols-outlined me-1" style="font-size: 16px;">stop_screen_share</span>Stop Share';
        screenStatus.textContent = 'Screen: Live';
        screenStatus.className = 'badge bg-success';
    } else {
        screenBtn.className = 'btn btn-warning btn-sm w-100';
        screenBtn.innerHTML = '<span class="material-symbols-outlined me-1" style="font-size: 16px;">screen_share</span>Share Screen';
        screenStatus.textContent = 'Screen: Off';
        screenStatus.className = 'badge bg-info';
    }
}

// Recording functions
window.toggleRecording = async function() {
    const userActiveStream = {{ user_active_stream_dict|tojson if user_active_stream_dict else 'null' }};
    if (!userActiveStream) return;
    
    const recordingBtn = document.getElementById('toggleRecordingBtn');
    const recordingIcon = document.getElementById('recordingIcon');
    const recordingText = document.getElementById('recordingText');
    const isRecording = window.streamState.isRecording;
    
    try {
        const endpoint = isRecording ? '/api/stream/recording/stop' : '/api/stream/recording/start';
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                stream_id: userActiveStream.id
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            window.streamState.isRecording = !isRecording;
            
            if (window.streamState.isRecording) {
                recordingIcon.textContent = 'stop';
                recordingText.textContent = 'Stop Recording';
                recordingBtn.className = 'btn btn-danger btn-sm w-100';
                showToast('üî¥ Recording started', 'success');
            } else {
                recordingIcon.textContent = 'fiber_manual_record';
                recordingText.textContent = 'Start Recording';
                recordingBtn.className = 'btn btn-outline-secondary btn-sm w-100';
                showToast('‚èπÔ∏è Recording stopped', 'info');
            }
        } else {
            throw new Error(data.error || 'Failed to toggle recording');
        }
    } catch (error) {
        console.error('Error toggling recording:', error);
        showToast('‚ùå ' + error.message, 'error');
    }
};

// Stream management functions
window.handleStartUserStream = async function(e) {
    e.preventDefault();
    
    const submitBtn = document.querySelector('#startUserStreamForm button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Starting...';
    
    try {
        const title = document.getElementById('userStreamTitle').value;
        const description = document.getElementById('userStreamDescription').value;
        const streamType = document.getElementById('userStreamType').value;
        
        const response = await fetch('/api/stream/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: title,
                description: description,
                stream_type: streamType
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('‚úÖ Your stream started successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            throw new Error(data.error || 'Failed to start stream');
        }
    } catch (error) {
        console.error('Error starting stream:', error);
        showToast('‚ùå ' + error.message, 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
};

window.stopUserStream = async function() {
    if (!confirm('Are you sure you want to end your stream? This action cannot be undone.')) {
        return;
    }
    
    // Stop screen sharing and audio first
    if (window.streamState.isScreenSharing) {
        stopScreenShare();
    }
    
    if (window.streamState.isAudioActive) {
        stopAudio();
    }
    
    try {
        const userActiveStream = {{ user_active_stream_dict|tojson if user_active_stream_dict else 'null' }};
        
        const response = await fetch('/api/stream/stop', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                stream_id: userActiveStream ? userActiveStream.id : null
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('‚úÖ Your stream ended successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            throw new Error(data.error || 'Failed to stop stream');
        }
    } catch (error) {
        console.error('Error stopping stream:', error);
        showToast('‚ùå ' + error.message, 'error');
    }
};

window.shareStream = function(streamId) {
    const streamUrl = window.location.origin + '/livestream';
    
    if (navigator.share) {
        navigator.share({
            title: 'TGFX Trade Lab Live Streams',
            text: 'Join the live trading sessions!',
            url: streamUrl
        });
    } else {
        navigator.clipboard.writeText(streamUrl).then(function() {
            showToast('üìã Stream link copied to clipboard', 'success');
        });
    }
};

async function updateStreamStats() {
    try {
        const response = await fetch('/api/stream/status');
        const data = await response.json();
        
        if (data.active && data.streams) {
            const totalViewers = data.streams.reduce((sum, stream) => sum + (stream.viewer_count || 0), 0);
            const recordingCount = data.streams.filter(stream => stream.is_recording).length;
            
            const activeStreamCountEl = document.getElementById('activeStreamCount');
            const totalViewersCountEl = document.getElementById('totalViewersCount');
            const recordingStreamsCountEl = document.getElementById('recordingStreamsCount');
            
            if (activeStreamCountEl) activeStreamCountEl.textContent = data.count;
            if (totalViewersCountEl) totalViewersCountEl.textContent = totalViewers;
            if (recordingStreamsCountEl) recordingStreamsCountEl.textContent = recordingCount;
        }
    } catch (error) {
        console.error('Error updating stream stats:', error);
    }
}

function showToast(message, type) {
    const toast = document.createElement('div');
    const alertType = type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
    
    toast.className = 'alert alert-' + alertType + ' position-fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.style.minWidth = '320px';
    toast.style.fontSize = '14px';
    toast.innerHTML = '<div>' + message + '</div>';
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 4000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('üì± Admin control page loaded');
    
    // Initialize communication system
    window.streamingComm.init();
    
    // Set up form handlers
    const startStreamForm = document.getElementById('startUserStreamForm');
    if (startStreamForm) {
        startStreamForm.addEventListener('submit', handleStartUserStream);
    }
    
    // Poll for updates
    setInterval(updateStreamStats, 5000);
    updateStreamStats();
    
    console.log('‚úÖ Simplified admin stream control loaded');
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (window.streamState.isScreenSharing) {
        stopScreenShare();
    }
    if (window.streamState.isAudioActive) {
        stopAudio();
    }
});
</script>

<style>
.audio-bars {
    display: flex;
    align-items: end;
    gap: 3px;
    width: 60px;
    height: 30px;
}

.audio-bar {
    width: 8px;
    min-height: 5px;
    height: 10%;
    background-color: #6b7280;
    border-radius: 2px;
    transition: height 0.1s ease, background-color 0.1s ease;
}

.btn-outline-secondary:hover {
    background-color: #6c757d;
    border-color: #6c757d;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

.table-dark {
    --bs-table-bg: transparent;
}

.card {
    transition: transform 0.3s ease;
}

.card:hover {
    transform: translateY(-1px);
}

@media (max-width: 768px) {
    .col-lg-6 {
        margin-bottom: 1rem;
    }
    
    .audio-bars {
        width: 50px;
        height: 25px;
    }
    
    .audio-bar {
        width: 6px;
    }
}
</style>
{% endblock %}
