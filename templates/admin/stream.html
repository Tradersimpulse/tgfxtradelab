{% extends "base.html" %}

{% block title %}Dual Stream Control - TGFX Trade Lab Admin{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="text-gradient-primary mb-2">
                    <span class="material-symbols-outlined me-2" style="font-size: 2rem;">live_tv</span>
                    Dual Stream Control
                </h1>
                <p class="text-muted mb-0">Manage Ray and Jordan's concurrent live streams</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('livestream') }}" class="btn btn-outline-primary" target="_blank">
                    <span class="material-symbols-outlined me-2">visibility</span>
                    View as User
                </a>
                <a href="{{ url_for('admin') }}" class="btn btn-outline-secondary">
                    <span class="material-symbols-outlined me-2">arrow_back</span>
                    Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Stream Status Overview -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2">analytics</span>
                    Stream Overview
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary" id="activeStreamCount">{{ active_streams|length }}</h4>
                        <small class="text-muted">Active Streams</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary" id="totalViewersCount">
                            {{ active_streams|map(attribute='viewer_count')|sum }}
                        </h4>
                        <small class="text-muted">Total Viewers</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary" id="recordingStreamsCount">
                            {{ active_streams|selectattr('is_recording')|list|length }}
                        </h4>
                        <small class="text-muted">Recording Now</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary">{{ 2 - active_streams|length }}</h4>
                        <small class="text-muted">Available Slots</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Your Stream Control -->
    <div class="col-lg-6 mb-4">
        <div class="card" style="border-left: 4px solid {{ current_user.stream_color }};">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1">{{ current_user.display_name or current_user.username }}'s Stream</h5>
                    <small class="text-muted">Your streaming controls</small>
                </div>
                {% if user_active_stream %}
                <span class="badge bg-success">
                    <span class="material-symbols-outlined me-1" style="font-size: 12px;">radio_button_checked</span>
                    LIVE
                </span>
                {% else %}
                <span class="badge bg-secondary">Offline</span>
                {% endif %}
            </div>
            
            <div class="card-body">
                {% if user_active_stream %}
                <!-- Your Active Stream Controls -->
                <div class="alert alert-success d-flex align-items-center mb-3">
                    <span class="material-symbols-outlined me-2">radio_button_checked</span>
                    <div class="flex-grow-1">
                        <strong>{{ user_active_stream.title }}</strong>
                        <small class="d-block text-muted">
                            Started {{ user_active_stream.started_at.strftime('%I:%M %p') if user_active_stream.started_at }} â€¢ 
                            {{ user_active_stream.viewer_count }} viewers
                        </small>
                    </div>
                </div>

                <!-- Your Stream Preview -->
                <div id="userStreamContainer" class="mb-3" style="background: #000; min-height: 200px; border-radius: 12px; position: relative;">
                    <div id="userStreamSpinner" class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center text-white">
                            <div class="spinner-border mb-3" style="color: {{ current_user.stream_color }};" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Your stream preview</p>
                        </div>
                    </div>
                    
                    <div id="userVideoGrid" class="position-absolute top-0 start-0 w-100 h-100"></div>
                    
                    <!-- Admin Controls -->
                    <div class="position-absolute bottom-0 start-0 w-100 p-2" style="background: linear-gradient(transparent, rgba(0,0,0,0.8));">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <small class="text-white me-3">{{ current_user.display_name or current_user.username }} â€¢ Admin Control</small>
                                <!-- Audio Status Indicator -->
                                <div class="audio-indicator admin-audio-controls" id="adminAudioIndicator">
                                    <span class="material-symbols-outlined mic-indicator" id="adminMicIndicator" style="font-size: 16px;">mic_off</span>
                                    <div class="audio-visualizer">
                                        <div class="audio-bar"></div>
                                        <div class="audio-bar"></div>
                                        <div class="audio-bar"></div>
                                        <div class="audio-bar"></div>
                                        <div class="audio-bar"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex gap-1">
                                <button class="btn btn-outline-light btn-sm" id="userMuteBtn" onclick="toggleUserMute()" title="Toggle Microphone">
                                    <span class="material-symbols-outlined" id="userMuteIcon" style="font-size: 16px;">mic_off</span>
                                </button>
                                <button class="btn btn-outline-light btn-sm" id="userVideoBtn" onclick="toggleUserVideo()" title="Toggle Camera">
                                    <span class="material-symbols-outlined" id="userVideoIcon" style="font-size: 16px;">videocam_off</span>
                                </button>
                                <button class="btn btn-outline-light btn-sm" id="userScreenBtn" onclick="toggleUserScreenShare()" title="Share Screen">
                                    <span class="material-symbols-outlined" id="userScreenIcon" style="font-size: 16px;">screen_share</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stream Actions -->
                <div class="row">
                    <div class="col-6">
                        <div class="d-grid gap-2">
                            <button class="btn btn-danger btn-sm" onclick="stopUserStream()">
                                <span class="material-symbols-outlined me-2">stop</span>
                                End Stream
                            </button>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="d-grid gap-2">
                            <button class="btn btn-warning btn-sm" id="userRecordingBtn" onclick="toggleUserRecording()">
                                <span class="material-symbols-outlined me-2" id="userRecordingIcon">
                                    {% if user_active_stream.is_recording %}stop{% else %}fiber_manual_record{% endif %}
                                </span>
                                {% if user_active_stream.is_recording %}Stop Rec{% else %}Record{% endif %}
                            </button>
                        </div>
                    </div>
                </div>

                {% else %}
                <!-- Start Your Stream -->
                {% if can_start_stream %}
                <form id="startUserStreamForm">
                    <div class="mb-3">
                        <label class="form-label">Stream Title</label>
                        <input type="text" class="form-control form-control-sm" id="userStreamTitle" 
                               placeholder="Your stream title..." value="{{ current_user.display_name or current_user.username }}'s Live Session" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Stream Type</label>
                        <select class="form-select form-select-sm" id="userStreamType">
                            <option value="trading">Live Trading</option>
                            <option value="analysis">Market Analysis</option>
                            <option value="education">Educational Content</option>
                            <option value="general">General Discussion</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <textarea class="form-control form-control-sm" id="userStreamDescription" rows="2" 
                                  placeholder="What will you be covering?"></textarea>
                    </div>
                    
                    <div class="d-grid">
                        <button type="submit" class="btn btn-success">
                            <span class="material-symbols-outlined me-2">play_arrow</span>
                            Start Your Stream
                        </button>
                    </div>
                </form>
                {% else %}
                <div class="text-center py-3">
                    <span class="material-symbols-outlined text-muted mb-2" style="font-size: 2rem;">block</span>
                    <p class="text-muted mb-0">
                        {% if active_streams|length >= 2 %}
                        Maximum streams reached (2/2)
                        {% else %}
                        You don't have streaming permissions
                        {% endif %}
                    </p>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Other Active Streams -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2">groups</span>
                    Other Active Streams
                </h5>
            </div>
            <div class="card-body">
                {% set other_streams = active_streams|rejectattr('created_by', 'equalto', current_user.id)|list %}
                {% if other_streams %}
                {% for stream in other_streams %}
                <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded" 
                     style="border-left: 4px solid {{ stream.creator.stream_color }} !important;">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <h6 class="mb-0 me-2">{{ stream.title }}</h6>
                            <span class="badge" style="background-color: {{ stream.creator.stream_color }};">
                                {{ stream.streamer_name }}
                            </span>
                        </div>
                        <small class="text-muted">
                            {{ stream.viewer_count }} viewers â€¢ 
                            Started {{ stream.started_at.strftime('%I:%M %p') if stream.started_at }}
                            {% if stream.is_recording %}â€¢ Recording{% endif %}
                        </small>
                    </div>
                    <div class="d-flex gap-1">
                        <a href="{{ url_for('livestream') }}" class="btn btn-outline-primary btn-sm" target="_blank">
                            <span class="material-symbols-outlined" style="font-size: 16px;">visibility</span>
                        </a>
                        <button class="btn btn-outline-secondary btn-sm" onclick="shareStream({{ stream.id }})">
                            <span class="material-symbols-outlined" style="font-size: 16px;">share</span>
                        </button>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-3">
                    <span class="material-symbols-outlined text-muted mb-2" style="font-size: 2rem;">live_tv</span>
                    <p class="text-muted mb-0">No other streams active</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Streams History -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2">history</span>
                    Recent Streams
                </h5>
            </div>
            <div class="card-body">
                {% if recent_streams %}
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Streamer</th>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Duration</th>
                                <th>Viewers</th>
                                <th>Started</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stream in recent_streams[:10] %}
                            <tr>
                                <td>
                                    <span class="badge" style="background-color: {{ stream.creator.stream_color }};">
                                        {{ stream.streamer_name or stream.creator.username }}
                                    </span>
                                </td>
                                <td>{{ stream.title[:30] }}{% if stream.title|length > 30 %}...{% endif %}</td>
                                <td>{{ stream.stream_type|title }}</td>
                                <td>
                                    {% if stream.started_at and stream.ended_at %}
                                    {{ ((stream.ended_at - stream.started_at).total_seconds() / 60)|round(0)|int }}m
                                    {% elif stream.started_at and stream.is_active %}
                                    <span class="text-success">Live</span>
                                    {% else %}
                                    --
                                    {% endif %}
                                </td>
                                <td>{{ stream.viewer_count }}</td>
                                <td>{{ stream.started_at.strftime('%m/%d %I:%M %p') if stream.started_at else '--' }}</td>
                                <td>
                                    {% if stream.is_active %}
                                    <span class="badge bg-success">Live</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Ended</span>
                                    {% endif %}
                                    {% if stream.recording_url %}
                                    <span class="badge bg-info ms-1">Recorded</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <span class="material-symbols-outlined text-muted mb-2" style="font-size: 2rem;">history</span>
                    <p class="text-muted mb-0">No recent streams</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Set template data for JavaScript
window.userActiveStreamData = {{ user_active_stream_dict|tojson if user_active_stream_dict else 'null' }};

console.log('ðŸŽ›ï¸ Starting admin stream control page...');

// Enhanced BroadcastChannel + localStorage communication system
let screenShareCommunication = {
    channel: null,
    isAdmin: true,
    
    init: function() {
        // Initialize BroadcastChannel
        try {
            this.channel = new BroadcastChannel('tgfx-screen-share');
            console.log('âœ… Admin BroadcastChannel initialized');
            
            this.channel.addEventListener('message', (event) => {
                this.handleMessage(event.data);
            });
        } catch (error) {
            console.error('BroadcastChannel failed:', error);
        }
        
        console.log('ðŸ“¡ Enhanced admin screen share communication initialized');
    },
    
    // Send screen share start message
    broadcastStart: function(screenName, width = 1280, height = 720) {
        const message = {
            type: 'SCREEN_SHARE_START',
            name: screenName,
            width: width,
            height: height,
            timestamp: Date.now(),
            admin: true
        };
        
        // Send via BroadcastChannel
        if (this.channel) {
            this.channel.postMessage(message);
        }
        
        // Store in localStorage for cross-session communication
        localStorage.setItem('tgfx_screen_share_status', JSON.stringify({
            active: true,
            name: screenName,
            width: width,
            height: height,
            timestamp: Date.now(),
            admin: true
        }));
        
        console.log('ðŸ“¡ Screen share start broadcasted:', screenName);
    },
    
    // Send screen share frame
    broadcastFrame: function(imageData) {
        const frameData = {
            imageData: imageData,
            timestamp: Date.now(),
            admin: true
        };
        
        // Send via BroadcastChannel (faster)
        if (this.channel) {
            this.channel.postMessage({
                type: 'SCREEN_SHARE_FRAME',
                ...frameData
            });
        }
        
        // Store in localStorage (fallback)
        localStorage.setItem('tgfx_screen_share_frame', JSON.stringify(frameData));
    },
    
    // Send screen share stop message
    broadcastStop: function() {
        const message = {
            type: 'SCREEN_SHARE_STOP',
            timestamp: Date.now(),
            admin: true
        };
        
        // Send via BroadcastChannel
        if (this.channel) {
            this.channel.postMessage(message);
        }
        
        // Update localStorage
        localStorage.setItem('tgfx_screen_share_status', JSON.stringify({
            active: false,
            timestamp: Date.now(),
            admin: true
        }));
        
        // Clear frame data
        localStorage.removeItem('tgfx_screen_share_frame');
        
        console.log('ðŸ“¡ Screen share stop broadcasted');
    },
    
    // Handle incoming messages
    handleMessage: function(data) {
        console.log('ðŸ“¡ Admin received message:', data.type);
        
        if (data.type === 'REQUEST_STATUS') {
            this.sendCurrentStatus();
        }
    },
    
    // Send current status (admin responds to viewer requests)
    sendCurrentStatus: function() {
        const isSharing = window.userStreamStates && window.userStreamStates.screenSharing;
        
        if (isSharing) {
            this.broadcastStart(window.currentScreenShareName || 'Admin Screen Share');
        }
    }
};

// Enhanced Audio Streaming System
let audioStreaming = {
    isAdmin: true,
    isStreaming: false,
    audioContext: null,
    mediaStream: null,
    audioWorklet: null,
    channel: null,
    
    // Initialize audio system
    init: function() {
        // Initialize communication channel
        try {
            this.channel = new BroadcastChannel('tgfx-audio-stream');
            console.log('ðŸŽ¤ Admin audio BroadcastChannel initialized');
        } catch (error) {
            console.error('Audio BroadcastChannel failed:', error);
        }
        
        console.log('ðŸŽ¤ Audio streaming system initialized for admin');
    },
    
    // Start audio streaming (admin only)
    startStreaming: async function() {
        try {
            console.log('ðŸŽ¤ Starting admin audio streaming...');
            
            // Request microphone access
            this.mediaStream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true,
                    sampleRate: 44100,
                    channelCount: 1
                }
            });
            
            // Create audio context
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)({
                sampleRate: 44100
            });
            
            // Resume context if suspended
            if (this.audioContext.state === 'suspended') {
                await this.audioContext.resume();
            }
            
            // Set up audio processing
            await this.setupAudioProcessing();
            
            this.isStreaming = true;
            
            // Broadcast audio start
            this.broadcastAudioStatus(true);
            
            // Update admin UI
            this.updateAdminAudioUI(true);
            
            console.log('âœ… Audio streaming started successfully');
            return true;
            
        } catch (error) {
            console.error('âŒ Failed to start audio streaming:', error);
            
            if (error.name === 'NotAllowedError') {
                showToast('Microphone access denied. Please allow microphone permissions.', 'warning');
            } else {
                showToast('Failed to start microphone: ' + error.message, 'error');
            }
            
            return false;
        }
    },
    
    // Stop audio streaming
    stopStreaming: function() {
        console.log('ðŸ”‡ Stopping admin audio streaming...');
        
        // Stop media tracks
        if (this.mediaStream) {
            this.mediaStream.getTracks().forEach(track => track.stop());
            this.mediaStream = null;
        }
        
        // Clean up audio context
        if (this.audioWorklet) {
            this.audioWorklet.disconnect();
            this.audioWorklet = null;
        }
        
        if (this.audioContext && this.audioContext.state !== 'closed') {
            this.audioContext.close();
            this.audioContext = null;
        }
        
        this.isStreaming = false;
        
        // Broadcast audio stop
        this.broadcastAudioStatus(false);
        
        // Update admin UI
        this.updateAdminAudioUI(false);
        
        console.log('âœ… Audio streaming stopped');
    },
    
    // Set up audio processing and streaming
    setupAudioProcessing: async function() {
        const source = this.audioContext.createMediaStreamSource(this.mediaStream);
        
        // Create analyser for audio visualization
        const analyser = this.audioContext.createAnalyser();
        analyser.fftSize = 512;
        analyser.smoothingTimeConstant = 0.3;
        
        // Create gain node for volume control
        const gainNode = this.audioContext.createGain();
        gainNode.gain.value = 1.0;
        
        // Connect nodes
        source.connect(gainNode);
        gainNode.connect(analyser);
        
        // Store references
        this.audioWorklet = analyser;
        
        // Start audio data broadcasting
        this.startAudioDataBroadcast(analyser);
        
        // Start admin visualization
        this.startAdminVisualization(analyser);
    },
    
    // Broadcast audio data to viewers
    startAudioDataBroadcast: function(analyser) {
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        const timeArray = new Uint8Array(bufferLength);
        
        let frameCount = 0;
        
        const broadcastLoop = () => {
            if (!this.isStreaming) return;
            
            // Get frequency and time domain data
            analyser.getByteFrequencyData(dataArray);
            analyser.getByteTimeDomainData(timeArray);
            
            // Calculate audio level
            const audioLevel = Array.from(dataArray).reduce((a, b) => a + b) / bufferLength;
            const volumeLevel = Array.from(timeArray).reduce((sum, value) => {
                return sum + Math.abs(value - 128);
            }) / bufferLength;
            
            // Broadcast every 3rd frame (about 20 times per second)
            if (frameCount % 3 === 0 && audioLevel > 5) {
                const audioData = {
                    level: audioLevel,
                    volume: volumeLevel,
                    frequency: Array.from(dataArray.slice(0, 32)), // First 32 frequency bins
                    timestamp: Date.now(),
                    admin: true
                };
                
                // Send via BroadcastChannel
                if (this.channel) {
                    this.channel.postMessage({
                        type: 'AUDIO_DATA',
                        data: audioData
                    });
                }
                
                // Store in localStorage
                localStorage.setItem('tgfx_audio_data', JSON.stringify(audioData));
            }
            
            frameCount++;
            
            if (this.isStreaming) {
                requestAnimationFrame(broadcastLoop);
            }
        };
        
        broadcastLoop();
    },
    
    // Start admin audio visualization
    startAdminVisualization: function(analyser) {
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        
        const visualizeLoop = () => {
            if (!this.isStreaming) return;
            
            analyser.getByteFrequencyData(dataArray);
            
            // Update admin audio indicator
            const audioLevel = Array.from(dataArray).reduce((a, b) => a + b) / bufferLength;
            this.updateAdminVisualization(audioLevel, dataArray.slice(0, 5));
            
            if (this.isStreaming) {
                requestAnimationFrame(visualizeLoop);
            }
        };
        
        visualizeLoop();
    },
    
    // Update admin audio visualization
    updateAdminVisualization: function(audioLevel, frequencyData) {
        const visualizer = document.querySelector('#adminAudioIndicator .audio-visualizer');
        const micIndicator = document.getElementById('adminMicIndicator');
        
        if (visualizer) {
            const bars = visualizer.querySelectorAll('.audio-bar');
            
            bars.forEach((bar, index) => {
                const value = frequencyData[index] || 0;
                const height = Math.max(20, (value / 255) * 100);
                
                bar.style.height = height + '%';
                
                // Color based on intensity
                if (value > 100) {
                    bar.style.backgroundColor = '#10B981';
                } else if (value > 50) {
                    bar.style.backgroundColor = '#fbbf24';
                } else {
                    bar.style.backgroundColor = '#6b7280';
                }
            });
        }
        
        if (micIndicator) {
            if (audioLevel > 10) {
                micIndicator.style.color = '#10B981';
                micIndicator.classList.add('active');
            } else {
                micIndicator.style.color = '#6b7280';
                micIndicator.classList.remove('active');
            }
        }
    },
    
    // Update admin UI
    updateAdminAudioUI: function(isActive) {
        const adminIndicator = document.getElementById('adminAudioIndicator');
        const micIndicator = document.getElementById('adminMicIndicator');
        
        if (adminIndicator) {
            if (isActive) {
                adminIndicator.classList.add('active');
                adminIndicator.classList.remove('muted');
            } else {
                adminIndicator.classList.remove('active');
                adminIndicator.classList.add('muted');
            }
        }
        
        if (micIndicator) {
            micIndicator.textContent = isActive ? 'mic' : 'mic_off';
            micIndicator.style.color = isActive ? '#10B981' : '#6b7280';
        }
    },
    
    // Broadcast audio status
    broadcastAudioStatus: function(isActive) {
        const statusData = {
            active: isActive,
            timestamp: Date.now(),
            admin: true
        };
        
        // Send via BroadcastChannel
        if (this.channel) {
            this.channel.postMessage({
                type: 'AUDIO_STATUS',
                data: statusData
            });
        }
        
        // Store in localStorage
        localStorage.setItem('tgfx_audio_status', JSON.stringify(statusData));
        
        if (!isActive) {
            localStorage.removeItem('tgfx_audio_data');
        }
    },
    
    // Toggle admin audio (for UI buttons)
    toggleAudio: async function() {
        if (this.isStreaming) {
            this.stopStreaming();
            return false;
        } else {
            return await this.startStreaming();
        }
    },
    
    // Get current audio status
    isAudioActive: function() {
        return this.isStreaming;
    }
};

// Global state management
let userStreamStates = {
    muted: true,
    videoEnabled: false,
    screenSharing: false
};

let currentAdminScreenShare = null;
let screenShareFrameInterval = null;

// Get user active stream data safely
const userActiveStream = window.userActiveStreamData || null;

// Enhanced Admin Screen Share Functions
window.startUserScreenShare = async function() {
    try {
        console.log('ðŸ–¥ï¸ Admin attempting to start screen share...');
        
        let stream;
        let screenName = 'Admin Screen Share';
        
        // Try to get real screen capture
        if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
            try {
                stream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: 'always',
                        width: { ideal: 1280, max: 1920 },
                        height: { ideal: 720, max: 1080 },
                        frameRate: { ideal: 15, max: 30 }
                    },
                    audio: true
                });
                
                screenName = 'Admin Live Screen Share';
                console.log('âœ… Real screen capture successful');
                
            } catch (error) {
                console.log('â„¹ï¸ Real screen capture failed:', error.message);
                if (error.name === 'NotAllowedError') {
                    showToast('Screen sharing was denied. Please allow screen access.', 'warning');
                    return;
                }
                
                // Fallback to demo
                stream = createDemoScreenStream();
                screenName = 'Admin Demo Screen Share';
            }
        } else {
            // Fallback to demo
            stream = createDemoScreenStream();
            screenName = 'Admin Demo Screen Share';
        }
        
        // Store screen share info
        currentAdminScreenShare = stream;
        userStreamStates.screenSharing = true;
        window.currentScreenShareName = screenName;
        
        // Update UI
        document.getElementById('userScreenIcon').textContent = 'stop_screen_share';
        document.getElementById('userScreenBtn').classList.add('btn-success');
        
        // Show screen share in admin preview
        displayScreenShareInAdminPreview(stream);
        
        // CRITICAL: Use enhanced communication system
        screenShareCommunication.broadcastStart(screenName, 1280, 720);
        
        // Set up frame broadcasting
        await setupEnhancedScreenShareBroadcasting(stream, screenName);
        
        showToast('Screen sharing started: ' + screenName, 'success');
        
        // Handle stream end
        stream.getVideoTracks().forEach(track => {
            track.onended = () => {
                console.log('ðŸ›‘ Screen share ended by user');
                stopUserScreenShare();
            };
        });
        
    } catch (error) {
        console.error('âŒ Screen share failed:', error);
        showToast('Screen sharing failed: ' + error.message, 'error');
    }
};

window.stopUserScreenShare = async function() {
    console.log('ðŸ›‘ Admin stopping screen share...');
    
    try {
        // Stop broadcasting
        if (screenShareFrameInterval) {
            clearTimeout(screenShareFrameInterval);
            screenShareFrameInterval = null;
        }
        
        // Stop stream tracks
        if (currentAdminScreenShare) {
            currentAdminScreenShare.getTracks().forEach(track => track.stop());
            currentAdminScreenShare = null;
        }
        
        // Clean up elements
        if (window.screenShareVideo) {
            window.screenShareVideo.remove();
            window.screenShareVideo = null;
        }
        window.screenShareCanvas = null;
        
        // Update state
        userStreamStates.screenSharing = false;
        window.currentScreenShareName = null;
        
        // Update UI
        document.getElementById('userScreenIcon').textContent = 'screen_share';
        document.getElementById('userScreenBtn').classList.remove('btn-success');
        
        // Restore admin preview
        const adminVideoGrid = document.getElementById('userVideoGrid');
        const spinner = document.getElementById('userStreamSpinner');
        
        if (adminVideoGrid) {
            adminVideoGrid.innerHTML = '';
            adminVideoGrid.style.display = 'none';
        }
        if (spinner) {
            spinner.style.display = 'flex';
        }
        
        // CRITICAL: Use enhanced communication system
        screenShareCommunication.broadcastStop();
        
        showToast('Screen sharing stopped', 'info');
        
    } catch (error) {
        console.error('âŒ Error stopping screen share:', error);
        showToast('Error stopping screen share', 'error');
    }
};

// Enhanced frame broadcasting
async function setupEnhancedScreenShareBroadcasting(stream, screenName) {
    console.log('ðŸ“¡ Setting up enhanced screen share broadcasting');
    
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    // Create hidden video for frame capture
    const hiddenVideo = document.createElement('video');
    hiddenVideo.style.display = 'none';
    hiddenVideo.autoplay = true;
    hiddenVideo.muted = true;
    hiddenVideo.srcObject = stream;
    document.body.appendChild(hiddenVideo);
    
    // Create canvas for frame capture
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    hiddenVideo.addEventListener('loadedmetadata', () => {
        canvas.width = Math.min(hiddenVideo.videoWidth, 1280);
        canvas.height = Math.min(hiddenVideo.videoHeight, 720);
        
        console.log('ðŸ“º Broadcasting at:', canvas.width, 'x', canvas.height);
        
        let frameCount = 0;
        const broadcastFrame = () => {
            if (hiddenVideo.readyState >= 2 && userStreamStates.screenSharing) {
                try {
                    ctx.drawImage(hiddenVideo, 0, 0, canvas.width, canvas.height);
                    
                    const frameSkip = isMobile ? 3 : 2;
                    
                    if (frameCount % frameSkip === 0) {
                        const quality = isMobile ? 0.7 : 0.8;
                        const imageData = canvas.toDataURL('image/jpeg', quality);
                        
                        // Use enhanced communication system
                        screenShareCommunication.broadcastFrame(imageData);
                    }
                    
                    frameCount++;
                    
                    if (userStreamStates.screenSharing) {
                        const captureInterval = isMobile ? 50 : 33;
                        screenShareFrameInterval = setTimeout(broadcastFrame, captureInterval);
                    }
                    
                } catch (error) {
                    console.error('Error broadcasting frame:', error);
                    if (userStreamStates.screenSharing) {
                        screenShareFrameInterval = setTimeout(broadcastFrame, isMobile ? 100 : 50);
                    }
                }
            }
        };
        
        hiddenVideo.play().then(() => {
            setTimeout(broadcastFrame, 100);
        });
    });
    
    window.screenShareVideo = hiddenVideo;
    window.screenShareCanvas = canvas;
}

// Display screen share in admin preview
function displayScreenShareInAdminPreview(stream) {
    const adminVideoGrid = document.getElementById('userVideoGrid');
    const spinner = document.getElementById('userStreamSpinner');
    
    if (adminVideoGrid) {
        adminVideoGrid.innerHTML = '';
        
        const screenShareVideo = document.createElement('video');
        screenShareVideo.style.width = '100%';
        screenShareVideo.style.height = '100%';
        screenShareVideo.style.objectFit = 'contain';
        screenShareVideo.autoplay = true;
        screenShareVideo.muted = true;
        screenShareVideo.srcObject = stream;
        
        adminVideoGrid.appendChild(screenShareVideo);
        adminVideoGrid.style.display = 'block';
        
        if (spinner) spinner.style.display = 'none';
    }
}

// Create demo screen stream
function createDemoScreenStream() {
    const canvas = document.createElement('canvas');
    canvas.width = 1280;
    canvas.height = 720;
    const ctx = canvas.getContext('2d');
    
    let frame = 0;
    const animate = () => {
        // Professional demo content
        ctx.fillStyle = '#1a1a1a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = '#10B981';
        ctx.font = 'bold 36px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Admin Screen Share (Demo)', 640, 100);
        
        // Animated trading chart
        ctx.strokeStyle = '#10B981';
        ctx.lineWidth = 3;
        ctx.beginPath();
        for (let i = 100; i < 1180; i += 10) {
            const y = 360 + Math.sin((i + frame * 3) * 0.01) * 150;
            if (i === 100) ctx.moveTo(i, y);
            else ctx.lineTo(i, y);
        }
        ctx.stroke();
        
        // Live indicator
        ctx.fillStyle = '#ff0000';
        ctx.beginPath();
        ctx.arc(100, 50, 10, 0, 2 * Math.PI);
        ctx.fill();
        
        ctx.fillStyle = '#ffffff';
        ctx.font = '20px Arial';
        ctx.textAlign = 'left';
        ctx.fillText('â— ADMIN LIVE DEMO', 120, 60);
        
        frame++;
        if (userStreamStates.screenSharing) {
            requestAnimationFrame(animate);
        }
    };
    animate();
    
    return canvas.captureStream(15);
}

// CRITICAL: Set up screen sharing toggle
window.toggleUserScreenShare = async function() {
    if (userStreamStates.screenSharing) {
        await stopUserScreenShare();
    } else {
        await startUserScreenShare();
    }
};

// Enhanced Audio Functions for Admin
window.toggleUserMute = async function() {
    const success = await audioStreaming.toggleAudio();
    
    // Update UI based on result
    const muteIcon = document.getElementById('userMuteIcon');
    const muteBtn = document.getElementById('userMuteBtn');
    
    if (success || audioStreaming.isAudioActive()) {
        muteIcon.textContent = 'mic';
        muteBtn.classList.add('btn-outline-success');
        userStreamStates.muted = false;
        showToast('ðŸŽ¤ Admin microphone enabled - Viewers can now hear you', 'success');
    } else {
        muteIcon.textContent = 'mic_off';
        muteBtn.classList.remove('btn-outline-success');
        userStreamStates.muted = true;
        showToast('ðŸ”‡ Admin microphone muted', 'info');
    }
};

window.toggleUserVideo = function() {
    if (userStreamStates.videoEnabled) {
        document.getElementById('userVideoIcon').textContent = 'videocam_off';
        document.getElementById('userVideoBtn').classList.remove('btn-outline-success');
        userStreamStates.videoEnabled = false;
        showToast('Admin camera disabled', 'info');
    } else {
        document.getElementById('userVideoIcon').textContent = 'videocam';
        document.getElementById('userVideoBtn').classList.add('btn-outline-success');
        userStreamStates.videoEnabled = true;
        showToast('Admin camera enabled', 'success');
    }
};

window.toggleUserRecording = async function() {
    if (!userActiveStream) return;
    
    const recordingBtn = document.getElementById('userRecordingBtn');
    const recordingIcon = document.getElementById('userRecordingIcon');
    const isRecording = recordingBtn.textContent.includes('Stop Rec');
    
    try {
        const endpoint = isRecording ? '/api/stream/recording/stop' : '/api/stream/recording/start';
        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                stream_id: userActiveStream.id
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            if (isRecording) {
                recordingIcon.textContent = 'fiber_manual_record';
                recordingBtn.innerHTML = '<span class="material-symbols-outlined me-2">fiber_manual_record</span>Record';
                recordingBtn.className = 'btn btn-warning btn-sm';
                showToast('Recording stopped', 'info');
            } else {
                recordingIcon.textContent = 'stop';
                recordingBtn.innerHTML = '<span class="material-symbols-outlined me-2">stop</span>Stop Rec';
                recordingBtn.className = 'btn btn-danger btn-sm';
                showToast('Recording started', 'success');
            }
        } else {
            throw new Error(data.error || 'Failed to toggle recording');
        }
    } catch (error) {
        console.error('Error toggling recording:', error);
        showToast(error.message, 'error');
    }
};

// Stream management functions
window.handleStartUserStream = async function(e) {
    e.preventDefault();
    
    const submitBtn = document.querySelector('#startUserStreamForm button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Starting...';
    
    try {
        const title = document.getElementById('userStreamTitle').value;
        const description = document.getElementById('userStreamDescription').value;
        const streamType = document.getElementById('userStreamType').value;
        
        const response = await fetch('/api/stream/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                title: title,
                description: description,
                stream_type: streamType
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Your stream started successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            throw new Error(data.error || 'Failed to start stream');
        }
    } catch (error) {
        console.error('Error starting stream:', error);
        showToast(error.message, 'error');
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
};

window.stopUserStream = async function() {
    if (!confirm('Are you sure you want to end your stream? This action cannot be undone.')) {
        return;
    }
    
    // Stop screen sharing first
    if (userStreamStates.screenSharing) {
        await stopUserScreenShare();
    }
    
    // Stop audio streaming
    if (audioStreaming.isAudioActive()) {
        audioStreaming.stopStreaming();
    }
    
    try {
        const response = await fetch('/api/stream/stop', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                stream_id: userActiveStream ? userActiveStream.id : null
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Your stream ended successfully', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            throw new Error(data.error || 'Failed to stop stream');
        }
    } catch (error) {
        console.error('Error stopping stream:', error);
        showToast(error.message, 'error');
    }
};

window.shareStream = function(streamId) {
    const streamUrl = window.location.origin + '/livestream';
    
    if (navigator.share) {
        navigator.share({
            title: 'TGFX Trade Lab Live Streams',
            text: 'Join the live trading sessions!',
            url: streamUrl
        });
    } else {
        navigator.clipboard.writeText(streamUrl).then(function() {
            showToast('Stream link copied to clipboard', 'success');
        });
    }
};

async function updateStreamStats() {
    try {
        const response = await fetch('/api/stream/status');
        const data = await response.json();
        
        if (data.active && data.streams) {
            const totalViewers = data.streams.reduce((sum, stream) => sum + (stream.viewer_count || 0), 0);
            const recordingCount = data.streams.filter(stream => stream.is_recording).length;
            
            const activeStreamCountEl = document.getElementById('activeStreamCount');
            const totalViewersCountEl = document.getElementById('totalViewersCount');
            const recordingStreamsCountEl = document.getElementById('recordingStreamsCount');
            
            if (activeStreamCountEl) activeStreamCountEl.textContent = data.count;
            if (totalViewersCountEl) totalViewersCountEl.textContent = totalViewers;
            if (recordingStreamsCountEl) recordingStreamsCountEl.textContent = recordingCount;
        }
    } catch (error) {
        console.error('Error updating stream stats:', error);
    }
}

function showToast(message, type) {
    const toast = document.createElement('div');
    const alertType = type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
    const iconType = type === 'error' ? 'error' : type === 'success' ? 'check_circle' : type === 'warning' ? 'warning' : 'info';
    
    toast.className = 'alert alert-' + alertType + ' position-fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.style.minWidth = '300px';
    toast.innerHTML = 
        '<div class="d-flex align-items-center">' +
            '<span class="material-symbols-outlined me-2">' + iconType + '</span>' +
            '<span>' + message + '</span>' +
        '</div>';
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 4000);
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸ“± Admin control page loaded');
    
    // Initialize enhanced communication systems
    screenShareCommunication.init();
    audioStreaming.init();
    
    if (userActiveStream) {
        console.log('ðŸŽ¬ User has active stream:', userActiveStream);
    }
    
    // Set up form handlers
    const startStreamForm = document.getElementById('startUserStreamForm');
    if (startStreamForm) {
        startStreamForm.addEventListener('submit', handleStartUserStream);
    }
    
    // Poll for updates
    setInterval(updateStreamStats, 5000);
    updateStreamStats();
    
    console.log('âœ… Enhanced admin stream control loaded');
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (userStreamStates.screenSharing) {
        stopUserScreenShare();
    }
    if (audioStreaming.isAudioActive()) {
        audioStreaming.stopStreaming();
    }
    if (screenShareCommunication.channel) {
        screenShareCommunication.channel.close();
    }
    if (audioStreaming.channel) {
        audioStreaming.channel.close();
    }
});
</script>

<style>
/* Audio Visualization Styles */
.audio-indicator {
    background: rgba(0, 0, 0, 0.6);
    padding: 6px 10px;
    border-radius: 8px;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
}

.audio-indicator.active {
    border-color: #10B981;
    background: rgba(16, 185, 129, 0.1);
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
}

.audio-indicator.muted {
    border-color: #6b7280;
    background: rgba(107, 114, 128, 0.1);
}

.audio-visualizer {
    display: flex;
    align-items: end;
    gap: 2px;
    width: 40px;
    height: 20px;
}

.audio-bar {
    width: 4px;
    min-height: 4px;
    background-color: #374151;
    border-radius: 2px;
    transition: height 0.1s ease, background-color 0.1s ease;
}

.audio-bar:nth-child(1) { height: 20%; }
.audio-bar:nth-child(2) { height: 40%; }
.audio-bar:nth-child(3) { height: 60%; }
.audio-bar:nth-child(4) { height: 80%; }
.audio-bar:nth-child(5) { height: 100%; }

.mic-indicator {
    color: #6b7280;
    transition: color 0.3s ease;
}

.mic-indicator.active {
    color: #10B981;
    animation: pulse 2s infinite;
}

.admin-audio-controls {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid #3B82F6;
}

.btn-outline-success {
    border-color: #10B981;
    color: #10B981;
}

.btn-outline-success:hover {
    background: #10B981;
    color: white;
}

.btn-success {
    background-color: #28a745;
    border-color: #28a745;
}

.btn-success:hover {
    background-color: #218838;
    border-color: #1e7e34;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

.table-dark {
    --bs-table-bg: transparent;
}

#userStreamContainer {
    min-height: 200px;
}

.card {
    transition: transform 0.3s ease;
}

.card:hover {
    transform: translateY(-1px);
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

@media (max-width: 768px) {
    .col-lg-6 {
        margin-bottom: 1rem;
    }
    
    #userStreamContainer {
        min-height: 150px;
    }
    
    .audio-indicator {
        padding: 4px 6px;
        flex-direction: row;
        gap: 4px;
        align-items: center;
    }
    
    .audio-visualizer {
        width: 30px;
        height: 16px;
    }
    
    .audio-bar {
        width: 3px;
    }
}
</style>
{% endblock %}
