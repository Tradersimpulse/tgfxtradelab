{% extends 'base.html' %}

{% block title %}Whop Price Mappings{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1 text-gray-800">
                <i class="fas fa-exchange-alt text-primary me-2"></i>
                Whop Price Mappings
            </h1>
            <p class="text-muted mb-0">Map Whop.com price IDs to your app's Stripe price IDs</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('admin_whop_transactions') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Transactions
            </a>
            <button class="btn btn-primary" onclick="showAddMappingModal()">
                <i class="fas fa-plus me-1"></i> Add Mapping
            </button>
        </div>
    </div>

    <!-- Info Alert -->
    <div class="alert alert-info bg-dark border-info border-opacity-25 text-white mb-4">
        <div class="d-flex align-items-start">
            <i class="fas fa-info-circle text-info me-3 mt-1"></i>
            <div>
                <h6 class="alert-heading mb-1 text-white">About Price Mappings</h6>
                <p class="mb-0 text-light">
                    These mappings connect Whop.com price IDs to your app's Stripe price IDs. 
                    When a user purchases through Whop, their subscription will be automatically mapped to the correct plan in your app.
                </p>
            </div>
        </div>
    </div>

    <!-- Mappings Table -->
    <div class="card bg-dark border-secondary border-opacity-25 shadow-sm">
        <div class="card-header bg-dark border-bottom border-secondary border-opacity-25 py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-list me-2"></i>
                    Active Price Mappings
                </h6>
                <div class="d-flex gap-2">
                    <div class="input-group input-group-sm" style="width: 250px;">
                        <input type="text" class="form-control bg-dark border-secondary text-white" placeholder="Search mappings..." id="searchInput">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            {% if mappings %}
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0" id="mappingsTable">
                    <thead class="bg-secondary bg-opacity-25">
                        <tr>
                            <th class="border-0 px-4 py-3 text-white">Product</th>
                            <th class="border-0 px-4 py-3 text-white">Whop Price ID</th>
                            <th class="border-0 px-4 py-3 text-white">App Price ID</th>
                            <th class="border-0 px-4 py-3 text-white">Status</th>
                            <th class="border-0 px-4 py-3 text-white">Created</th>
                            <th class="border-0 px-4 py-3 text-end text-white">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mapping in mappings %}
                        <tr id="mapping-{{ mapping.id }}">
                            <td class="px-4 py-3">
                                <div>
                                    <div class="fw-bold text-white">{{ mapping.product_name }}</div>
                                    {% if mapping.description %}
                                    <small class="text-muted">{{ mapping.description }}</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-4 py-3">
                                <code class="text-primary bg-dark">{{ mapping.whop_price_id }}</code>
                            </td>
                            <td class="px-4 py-3">
                                <code class="text-success bg-dark">{{ mapping.app_price_id }}</code>
                            </td>
                            <td class="px-4 py-3">
                                {% if mapping.is_active %}
                                <span class="badge bg-success">
                                    <i class="fas fa-check me-1"></i>
                                    Active
                                </span>
                                {% else %}
                                <span class="badge bg-secondary">
                                    <i class="fas fa-pause me-1"></i>
                                    Inactive
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3">
                                <div class="text-muted">
                                    {{ mapping.created_at.strftime('%m/%d/%Y') }}
                                </div>
                            </td>
                            <td class="px-4 py-3 text-end">
                                <div class="d-flex gap-1 justify-content-end">
                                    <button class="btn btn-sm btn-outline-light" 
                                            onclick="editMapping({{ mapping.id }})"
                                            data-bs-toggle="tooltip" 
                                            title="Edit Mapping">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" 
                                            onclick="deleteMapping({{ mapping.id }})"
                                            data-bs-toggle="tooltip" 
                                            title="Delete Mapping">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <div class="mb-3">
                    <i class="fas fa-exchange-alt fa-3x text-muted opacity-50"></i>
                </div>
                <h5 class="text-muted">No Price Mappings</h5>
                <p class="text-muted mb-3">Create your first price mapping to connect Whop purchases to your app.</p>
                <button class="btn btn-primary" onclick="showAddMappingModal()">
                    <i class="fas fa-plus me-1"></i> Add First Mapping
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add/Edit Mapping Modal -->
<div class="modal fade" id="mappingModal" tabindex="-1" aria-labelledby="mappingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark border-secondary shadow">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-white" id="mappingModalLabel">
                    <i class="fas fa-plus text-primary me-2"></i>
                    Add Price Mapping
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="mappingForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="productName" class="form-label fw-bold text-white">
                                <i class="fas fa-tag me-1"></i>
                                Product Name
                            </label>
                            <input type="text" class="form-control bg-dark border-secondary text-white" id="productName" required 
                                   placeholder="e.g., Monthly Subscription">
                            <div class="form-text text-muted">Human-readable name for this mapping</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="whopPriceId" class="form-label fw-bold text-white">
                                <i class="fas fa-shopping-cart me-1"></i>
                                Whop Price ID
                            </label>
                            <input type="text" class="form-control bg-dark border-secondary text-white" id="whopPriceId" required 
                                   placeholder="price_1abc123...">
                            <div class="form-text text-muted">The price ID from Whop.com/Stripe</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="appPriceId" class="form-label fw-bold text-white">
                                <i class="fas fa-credit-card me-1"></i>
                                App Price ID
                            </label>
                            <input type="text" class="form-control bg-dark border-secondary text-white" id="appPriceId" required 
                                   placeholder="price_1xyz789...">
                            <div class="form-text text-muted">Your app's corresponding Stripe price ID</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="description" class="form-label fw-bold text-white">
                                <i class="fas fa-align-left me-1"></i>
                                Description
                                <span class="text-muted">(Optional)</span>
                            </label>
                            <textarea class="form-control bg-dark border-secondary text-white" id="description" rows="3" 
                                      placeholder="Additional details about this mapping..."></textarea>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12 mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="isActive" checked>
                                <label class="form-check-label fw-bold text-white" for="isActive">
                                    <i class="fas fa-toggle-on me-1"></i>
                                    Active Mapping
                                </label>
                                <div class="form-text text-muted">Inactive mappings will not process new transactions</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top border-secondary bg-dark">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancel
                </button>
                <button type="button" class="btn btn-primary" onclick="saveMapping()">
                    <i class="fas fa-save me-1"></i>
                    Save Mapping
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary shadow">
            <div class="modal-header border-bottom border-secondary bg-danger">
                <h5 class="modal-title text-white" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirm Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-start">
                    <div class="text-danger me-3">
                        <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                    <div>
                        <h6 class="text-white">Are you sure you want to delete this price mapping?</h6>
                        <p class="mb-0 text-muted">
                            This action cannot be undone. Existing transactions using this mapping will not be affected, 
                            but new transactions from Whop will not be processed.
                        </p>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-1"></i>
                    Delete Mapping
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1055">
    <div id="toastNotification" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body"></div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<script>
let currentMappingId = null;
let deleteTargetId = null;

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Show toast notification
function showToast(message, type = 'success') {
    const toast = document.getElementById('toastNotification');
    const toastBody = toast.querySelector('.toast-body');
    
    // Set message and styling
    toastBody.textContent = message;
    toast.className = `toast align-items-center border-0 text-white bg-${type}`;
    
    // Show toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// Show add mapping modal
function showAddMappingModal() {
    currentMappingId = null;
    
    // Reset form
    document.getElementById('mappingForm').reset();
    document.getElementById('isActive').checked = true;
    
    // Update modal title
    const modalTitle = document.getElementById('mappingModalLabel');
    modalTitle.innerHTML = '<i class="fas fa-plus text-primary me-2"></i> Add Price Mapping';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('mappingModal'));
    modal.show();
}

// Edit mapping
function editMapping(mappingId) {
    currentMappingId = mappingId;
    
    // Update modal title
    const modalTitle = document.getElementById('mappingModalLabel');
    modalTitle.innerHTML = '<i class="fas fa-edit text-primary me-2"></i> Edit Price Mapping';
    
    // Show loading state
    const modal = new bootstrap.Modal(document.getElementById('mappingModal'));
    modal.show();
    
    // Get mapping data
    fetch(`/api/admin/whop-price-mapping/${mappingId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const mapping = data.mapping;
            document.getElementById('productName').value = mapping.product_name;
            document.getElementById('whopPriceId').value = mapping.whop_price_id;
            document.getElementById('appPriceId').value = mapping.app_price_id;
            document.getElementById('description').value = mapping.description || '';
            document.getElementById('isActive').checked = mapping.is_active;
        } else {
            showToast('Error loading mapping: ' + data.error, 'danger');
            modal.hide();
        }
    })
    .catch(error => {
        showToast('Error loading mapping: ' + error.message, 'danger');
        modal.hide();
    });
}

// Delete mapping
function deleteMapping(mappingId) {
    deleteTargetId = mappingId;
    
    // Show confirmation modal
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    deleteModal.show();
    
    // Set up confirmation handler
    document.getElementById('confirmDeleteBtn').onclick = function() {
        performDelete(mappingId);
        deleteModal.hide();
    };
}

// Perform the actual deletion
function performDelete(mappingId) {
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const originalContent = confirmBtn.innerHTML;
    
    // Show loading state
    confirmBtn.disabled = true;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Deleting...';
    
    fetch(`/api/admin/whop-price-mapping/${mappingId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Price mapping deleted successfully!', 'success');
            
            // Remove the row from table
            const row = document.getElementById(`mapping-${mappingId}`);
            if (row) {
                row.remove();
            }
            
            // Check if table is now empty
            const tbody = document.querySelector('#mappingsTable tbody');
            if (tbody && tbody.children.length === 0) {
                location.reload(); // Reload to show empty state
            }
        } else {
            showToast('Error deleting mapping: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showToast('Error deleting mapping: ' + error.message, 'danger');
    })
    .finally(() => {
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = originalContent;
    });
}

// Save mapping
function saveMapping() {
    const form = document.getElementById('mappingForm');
    const saveBtn = form.closest('.modal-content').querySelector('.btn-primary');
    const originalContent = saveBtn.innerHTML;
    
    // Validate form
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Show loading state
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
    
    const formData = {
        product_name: document.getElementById('productName').value,
        whop_price_id: document.getElementById('whopPriceId').value,
        app_price_id: document.getElementById('appPriceId').value,
        description: document.getElementById('description').value,
        is_active: document.getElementById('isActive').checked
    };
    
    const url = currentMappingId 
        ? `/api/admin/whop-price-mapping/${currentMappingId}`
        : '/api/admin/whop-price-mapping';
    
    const method = currentMappingId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Price mapping saved successfully!', 'success');
            
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('mappingModal'));
            if (modal) {
                modal.hide();
            }
            
            // Reload page to show updated data
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showToast('Error saving mapping: ' + error.message, 'danger');
    })
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalContent;
    });
}

// Search functionality
document.getElementById('searchInput').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#mappingsTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Clear form when modal is hidden
document.getElementById('mappingModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('mappingForm').reset();
    currentMappingId = null;
});
</script>

<style>
.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
}

.table tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

.badge {
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
}

code {
    font-size: 0.8rem;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    background-color: rgba(0, 123, 255, 0.1);
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.8rem;
}

.form-check-input:checked {
    background-color: #10B981;
    border-color: #10B981;
}

.text-primary {
    color: #10B981 !important;
}

.btn-primary {
    background-color: #10B981;
    border-color: #10B981;
}

.btn-primary:hover {
    background-color: #059669;
    border-color: #059669;
}

.modal-content {
    border-radius: 0.75rem;
}

.modal-header {
    border-radius: 0.75rem 0.75rem 0 0;
}

.alert {
    border-radius: 0.75rem;
}

.card {
    border-radius: 0.75rem;
}

.form-control:focus {
    border-color: #10B981;
    box-shadow: 0 0 0 0.2rem rgba(16, 185, 129, 0.25);
}
</style>
{% endblock %}
