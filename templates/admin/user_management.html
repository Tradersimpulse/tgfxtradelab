{% extends "base.html" %}

{% block title %}User Management - TGFX Trade Lab Admin{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="text-gradient-primary">
                <span class="material-symbols-outlined me-2" style="font-size: 2.5rem;">group</span>
                User Management
            </h1>
            <div>
                <button class="btn btn-outline-primary me-2" onclick="syncAllUsersWithStripe()">
                    <span class="material-symbols-outlined me-2">sync</span>
                    Sync All with Stripe
                </button>
                <button class="btn btn-primary" onclick="exportUsers()">
                    <span class="material-symbols-outlined me-2">download</span>
                    Export Users
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-gradient-primary text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <span class="material-symbols-outlined me-3" style="font-size: 2.5rem;">people</span>
                    <div>
                        <h3 class="mb-0">{{ users|length }}</h3>
                        <p class="mb-0">Total Users</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-gradient-success text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <span class="material-symbols-outlined me-3" style="font-size: 2.5rem;">star</span>
                    <div>
                        <h3 class="mb-0">{{ users|selectattr('has_subscription')|list|length }}</h3>
                        <p class="mb-0">Premium Users</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-gradient-warning text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <span class="material-symbols-outlined me-3" style="font-size: 2.5rem;">trending_up</span>
                    <div>
                        <h3 class="mb-0">${{ "%.0f"|format(users|sum(attribute='total_revenue') or 0) }}</h3>
                        <p class="mb-0">Total Revenue</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-gradient-info text-white">
            <div class="card-body">
                <div class="d-flex align-items-center">
                    <span class="material-symbols-outlined me-3" style="font-size: 2.5rem;">percent</span>
                    <div>
                        <h3 class="mb-0">{{ "%.1f"|format((users|selectattr('has_subscription')|list|length / users|length * 100) if users|length > 0 else 0) }}%</h3>
                        <p class="mb-0">Conversion Rate</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-end">
                    <div class="col-md-3">
                        <label class="form-label">Filter by Status</label>
                        <select class="form-select" id="statusFilter" onchange="filterUsers()">
                            <option value="">All Users</option>
                            <option value="active">Active Subscribers</option>
                            <option value="canceled">Canceled</option>
                            <option value="past_due">Past Due</option>
                            <option value="free">Free Users</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Filter by Plan</label>
                        <select class="form-select" id="planFilter" onchange="filterUsers()">
                            <option value="">All Plans</option>
                            <option value="monthly">Monthly</option>
                            <option value="annual">Annual</option>
                            <option value="lifetime">Lifetime</option>
                            <option value="free">Free</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Search Users</label>
                        <input type="text" class="form-control" id="userSearch" placeholder="Search by name, email, or username" onkeyup="filterUsers()">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                            <span class="material-symbols-outlined me-2">clear</span>
                            Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <span class="material-symbols-outlined me-2">table_view</span>
                    Users List
                </h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="showDetailsToggle" onchange="toggleDetails()">
                    <label class="form-check-label" for="showDetailsToggle">
                        Show Details
                    </label>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-striped mb-0" id="usersTable">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Subscription</th>
                                <th>Revenue</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr data-user-id="{{ user.id }}" 
                                data-status="{{ user.subscription_status or 'free' }}" 
                                data-plan="{{ user.subscription_plan or 'free' }}"
                                data-search-text="{{ user.username.lower() }} {{ user.email.lower() }} {{ user.display_name.lower() if user.display_name }}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle me-3" style="background-color: {{ user.stream_color }}">
                                            {{ user.username[0].upper() }}
                                        </div>
                                        <div>
                                            <div class="fw-bold">{{ user.username }}</div>
                                            <small class="text-muted">{{ user.email }}</small>
                                            {% if user.is_admin %}
                                                <span class="badge bg-warning text-dark ms-2">Admin</span>
                                            {% endif %}
                                            {% if user.can_stream %}
                                                <span class="badge bg-info ms-2">Streamer</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <span class="badge bg-{{ 'success' if user.has_subscription else 'secondary' }}">
                                            {{ user.get_subscription_status_display() }}
                                        </span>
                                        {% if user.subscription_plan %}
                                            <div class="small text-muted mt-1">{{ user.get_subscription_plan_display() }}</div>
                                        {% endif %}
                                        {% if user.subscription_expires %}
                                            <div class="small text-muted">
                                                Expires: {{ user.subscription_expires.strftime('%m/%d/%Y') }}
                                            </div>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="fw-bold">${{ "%.2f"|format(user.total_revenue or 0) }}</div>
                                    {% if user.last_payment_date %}
                                        <div class="small text-muted">
                                            Last: {{ user.last_payment_date.strftime('%m/%d/%Y') }}
                                        </div>
                                    {% endif %}
                                </td>
                                <td>
                                    <div>{{ user.created_at.strftime('%m/%d/%Y') }}</div>
                                    <div class="small text-muted">{{ user.timezone }}</div>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-primary" onclick="viewUser({{ user.id }})">
                                            <span class="material-symbols-outlined">visibility</span>
                                        </button>
                                        <button class="btn btn-outline-warning" onclick="editUser({{ user.id }})">
                                            <span class="material-symbols-outlined">edit</span>
                                        </button>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                                <span class="material-symbols-outlined">more_horiz</span>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-dark">
                                                <li><a class="dropdown-item" onclick="syncUserWithStripe({{ user.id }})">
                                                    <span class="material-symbols-outlined me-2">sync</span>Sync with Stripe
                                                </a></li>
                                                {% if user.has_subscription %}
                                                    <li><a class="dropdown-item" onclick="manageSubscription({{ user.id }})">
                                                        <span class="material-symbols-outlined me-2">payment</span>Manage Subscription
                                                    </a></li>
                                                    <li><a class="dropdown-item" onclick="cancelSubscription({{ user.id }})">
                                                        <span class="material-symbols-outlined me-2">cancel</span>Cancel Subscription
                                                    </a></li>
                                                {% else %}
                                                    <li><a class="dropdown-item" onclick="grantSubscription({{ user.id }})">
                                                        <span class="material-symbols-outlined me-2">star</span>Grant Subscription
                                                    </a></li>
                                                {% endif %}
                                                <li><hr class="dropdown-divider"></li>
                                                <li><a class="dropdown-item" onclick="loginAsUser({{ user.id }})">
                                                    <span class="material-symbols-outlined me-2">login</span>Login as User
                                                </a></li>
                                                <li><a class="dropdown-item text-danger" onclick="deleteUser({{ user.id }})">
                                                    <span class="material-symbols-outlined me-2">delete</span>Delete User
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <!-- Detailed row (hidden by default) -->
                            <tr class="user-details" id="details-{{ user.id }}" style="display: none;">
                                <td colspan="5">
                                    <div class="row p-3">
                                        <div class="col-md-4">
                                            <h6 class="text-muted">Subscription Details</h6>
                                            <p><strong>Stripe Customer:</strong> {{ user.stripe_customer_id or 'Not linked' }}</p>
                                            <p><strong>Subscription ID:</strong> {{ user.stripe_subscription_id or 'None' }}</p>
                                            <p><strong>Cancel at Period End:</strong> {{ 'Yes' if user.subscription_cancel_at_period_end else 'No' }}</p>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="text-muted">Activity</h6>
                                            <p><strong>Videos Completed:</strong> {{ user.progress|selectattr('completed')|list|length }}</p>
                                            <p><strong>Favorites:</strong> {{ user.favorites|length }}</p>
                                            <p><strong>Last Login:</strong> Recently</p>
                                        </div>
                                        <div class="col-md-4">
                                            <h6 class="text-muted">Payment History</h6>
                                            <p><strong>Total Paid:</strong> ${{ "%.2f"|format(user.total_revenue or 0) }}</p>
                                            <p><strong>Last Payment:</strong> ${{ "%.2f"|format(user.last_payment_amount or 0) }}</p>
                                            <button class="btn btn-sm btn-outline-info" onclick="viewPaymentHistory({{ user.id }})">
                                                View Payment History
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Edit Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">Edit User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="userModalBody">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Subscription Management Modal -->
<div class="modal fade" id="subscriptionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Subscription Management</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="subscriptionModalBody">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<style>
.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.user-details {
    background-color: rgba(255, 255, 255, 0.05);
}

.table td {
    vertical-align: middle;
}

.subscription-info-card {
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
}

.subscription-status {
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
}

.status-active { background-color: rgba(40, 167, 69, 0.2); border-left: 4px solid #28a745; }
.status-canceled { background-color: rgba(220, 53, 69, 0.2); border-left: 4px solid #dc3545; }
.status-past_due { background-color: rgba(255, 193, 7, 0.2); border-left: 4px solid #ffc107; }
.status-none { background-color: rgba(108, 117, 125, 0.2); border-left: 4px solid #6c757d; }

.form-section {
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.loading-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}
</style>

<script>
let currentEditingUserId = null;

// Filter and search functionality
function filterUsers() {
    const statusFilter = document.getElementById('statusFilter').value;
    const planFilter = document.getElementById('planFilter').value;
    const searchText = document.getElementById('userSearch').value.toLowerCase();
    
    const rows = document.querySelectorAll('#usersTable tbody tr:not(.user-details)');
    
    rows.forEach(row => {
        const status = row.dataset.status;
        const plan = row.dataset.plan;
        const searchableText = row.dataset.searchText;
        
        let showRow = true;
        
        // Status filter
        if (statusFilter && status !== statusFilter) {
            showRow = false;
        }
        
        // Plan filter
        if (planFilter && plan !== planFilter) {
            showRow = false;
        }
        
        // Search filter
        if (searchText && !searchableText.includes(searchText)) {
            showRow = false;
        }
        
        row.style.display = showRow ? '' : 'none';
        
        // Also hide/show corresponding details row
        const detailsRow = document.getElementById(`details-${row.dataset.userId}`);
        if (detailsRow) {
            detailsRow.style.display = showRow && detailsRow.style.display !== 'none' ? '' : 'none';
        }
    });
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('planFilter').value = '';
    document.getElementById('userSearch').value = '';
    filterUsers();
}

function toggleDetails() {
    const showDetails = document.getElementById('showDetailsToggle').checked;
    const detailRows = document.querySelectorAll('.user-details');
    
    detailRows.forEach(row => {
        row.style.display = showDetails ? '' : 'none';
    });
}

// User management functions
function viewUser(userId) {
    fetch(`/admin/user/${userId}`)
        .then(response => {
            if (!response.ok) throw new Error('Failed to load user');
            return response.text();
        })
        .then(html => {
            // If it's an HTML response, redirect
            window.location.href = `/admin/user/${userId}`;
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error loading user details', 'error');
        });
}

function editUser(userId) {
    currentEditingUserId = userId;
    
    fetch(`/api/admin/user/${userId}/edit`)
        .then(response => response.json())
        .then(data => {
            if (data.user) {
                document.getElementById('userModalTitle').textContent = `Edit User: ${data.user.username}`;
                document.getElementById('userModalBody').innerHTML = generateEditUserHTML(data.user);
                new bootstrap.Modal(document.getElementById('userModal')).show();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error loading user details', 'error');
        });
}

function generateEditUserHTML(user) {
    return `
        <div class="row">
            <!-- User Information Section -->
            <div class="col-md-6">
                <div class="form-section">
                    <h6 class="text-primary mb-3">
                        <span class="material-symbols-outlined me-2">person</span>
                        User Information
                    </h6>
                    
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="editUsername" value="${user.username}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="editEmail" value="${user.email}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Display Name</label>
                        <input type="text" class="form-control" id="editDisplayName" value="${user.display_name || ''}">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Timezone</label>
                        <select class="form-select" id="editTimezone">
                            <option value="America/New_York" ${user.timezone === 'America/New_York' ? 'selected' : ''}>Eastern Time</option>
                            <option value="America/Chicago" ${user.timezone === 'America/Chicago' ? 'selected' : ''}>Central Time</option>
                            <option value="America/Denver" ${user.timezone === 'America/Denver' ? 'selected' : ''}>Mountain Time</option>
                            <option value="America/Los_Angeles" ${user.timezone === 'America/Los_Angeles' ? 'selected' : ''}>Pacific Time</option>
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editIsAdmin" ${user.is_admin ? 'checked' : ''}>
                                <label class="form-check-label" for="editIsAdmin">Admin Access</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editCanStream" ${user.can_stream ? 'checked' : ''}>
                                <label class="form-check-label" for="editCanStream">Can Stream</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Subscription Section -->
            <div class="col-md-6">
                <div class="form-section">
                    <h6 class="text-warning mb-3">
                        <span class="material-symbols-outlined me-2">payment</span>
                        Subscription Management
                    </h6>
                    
                    <!-- Current Subscription Status -->
                    <div class="subscription-status status-${user.subscription_status || 'none'}" id="currentSubscriptionStatus">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Current Status:</strong> ${user.subscription_status || 'Free User'}
                                ${user.subscription_plan ? `<br><small class="text-muted">Plan: ${user.subscription_plan}</small>` : ''}
                            </div>
                            <span class="badge bg-${user.has_subscription ? 'success' : 'secondary'}">
                                ${user.has_subscription ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Link Stripe Subscription -->
                    <div class="mb-3">
                        <label class="form-label">Link Stripe Subscription</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="stripeSubscriptionId" 
                                   placeholder="sub_1234567890abcdef" 
                                   value="${user.stripe_subscription_id || ''}">
                            <button class="btn btn-primary" type="button" onclick="fetchSubscriptionInfo()">
                                <span class="material-symbols-outlined me-2">search</span>
                                Fetch Info
                            </button>
                        </div>
                        <div class="form-text">Enter a Stripe subscription ID to link it to this user</div>
                    </div>
                    
                    <!-- Subscription Info Display -->
                    <div id="subscriptionInfoDisplay" style="display: none;">
                        <div class="subscription-info-card">
                            <h6 class="text-light mb-3">Stripe Subscription Details</h6>
                            <div id="subscriptionDetails">
                                <!-- Populated by fetchSubscriptionInfo() -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Manual Subscription Management -->
                    <div class="mt-4">
                        <h6 class="text-info mb-3">Manual Subscription Override</h6>
                        
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label">Subscription Plan</label>
                                <select class="form-select" id="editSubscriptionPlan">
                                    <option value="">No Subscription</option>
                                    <option value="monthly" ${user.subscription_plan === 'monthly' ? 'selected' : ''}>Monthly</option>
                                    <option value="annual" ${user.subscription_plan === 'annual' ? 'selected' : ''}>Annual</option>
                                    <option value="lifetime" ${user.subscription_plan === 'lifetime' ? 'selected' : ''}>Lifetime</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="editSubscriptionStatus">
                                    <option value="">No Status</option>
                                    <option value="active" ${user.subscription_status === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="canceled" ${user.subscription_status === 'canceled' ? 'selected' : ''}>Canceled</option>
                                    <option value="past_due" ${user.subscription_status === 'past_due' ? 'selected' : ''}>Past Due</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="editHasSubscription" ${user.has_subscription ? 'checked' : ''}>
                            <label class="form-check-label" for="editHasSubscription">
                                Has Active Subscription
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="d-flex justify-content-between mt-4">
            <div>
                <button class="btn btn-outline-danger" onclick="unlinkStripeSubscription()">
                    <span class="material-symbols-outlined me-2">link_off</span>
                    Unlink Stripe
                </button>
            </div>
            <div>
                <button class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" onclick="saveUserChanges()">
                    <span class="material-symbols-outlined me-2">save</span>
                    Save Changes
                </button>
            </div>
        </div>
    `;
}

function fetchSubscriptionInfo() {
    const subscriptionId = document.getElementById('stripeSubscriptionId').value.trim();
    
    if (!subscriptionId) {
        showToast('Please enter a subscription ID', 'warning');
        return;
    }
    
    if (!subscriptionId.startsWith('sub_')) {
        showToast('Invalid subscription ID format. Should start with "sub_"', 'error');
        return;
    }
    
    // Show loading state
    const button = document.querySelector('#userModalBody button[onclick="fetchSubscriptionInfo()"]');
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Loading...';
    button.disabled = true;
    
    fetch(`/api/admin/stripe/subscription/${subscriptionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.subscription) {
                displaySubscriptionInfo(data.subscription);
                document.getElementById('subscriptionInfoDisplay').style.display = 'block';
                showToast('Subscription info loaded successfully', 'success');
            } else {
                showToast(data.error || 'Subscription not found', 'error');
                document.getElementById('subscriptionInfoDisplay').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error fetching subscription info', 'error');
            document.getElementById('subscriptionInfoDisplay').style.display = 'none';
        })
        .finally(() => {
            // Reset button
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

function displaySubscriptionInfo(subscription) {
    const container = document.getElementById('subscriptionDetails');
    
    const statusBadgeClass = {
        'active': 'bg-success',
        'canceled': 'bg-danger', 
        'past_due': 'bg-warning text-dark',
        'incomplete': 'bg-secondary'
    }[subscription.status] || 'bg-secondary';
    
    container.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>Status:</strong> <span class="badge ${statusBadgeClass}">${subscription.status}</span></p>
                <p><strong>Customer:</strong> ${subscription.customer_email || 'N/A'}</p>
                <p><strong>Created:</strong> ${new Date(subscription.created * 1000).toLocaleDateString()}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Current Period:</strong><br>
                   ${new Date(subscription.current_period_start * 1000).toLocaleDateString()} - 
                   ${new Date(subscription.current_period_end * 1000).toLocaleDateString()}</p>
                <p><strong>Cancel at Period End:</strong> ${subscription.cancel_at_period_end ? 'Yes' : 'No'}</p>
            </div>
        </div>
        ${subscription.items && subscription.items.data.length > 0 ? `
        <div class="mt-3">
            <strong>Plan Details:</strong>
            <ul class="list-unstyled mt-2">
                ${subscription.items.data.map(item => `
                    <li class="mb-1">
                        <span class="badge bg-info me-2">$${(item.price.unit_amount / 100).toFixed(2)}</span>
                        ${item.price.nickname || 'Subscription'} 
                        (${item.price.recurring ? item.price.recurring.interval : 'one-time'})
                    </li>
                `).join('')}
            </ul>
        </div>
        ` : ''}
        <div class="mt-3">
            <button class="btn btn-success btn-sm" onclick="linkSubscriptionToUser()">
                <span class="material-symbols-outlined me-2">link</span>
                Link to User
            </button>
        </div>
    `;
}

function linkSubscriptionToUser() {
    const subscriptionId = document.getElementById('stripeSubscriptionId').value.trim();
    
    if (!subscriptionId || !currentEditingUserId) {
        showToast('Missing subscription ID or user ID', 'error');
        return;
    }
    
    fetch(`/api/admin/user/${currentEditingUserId}/link-subscription`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({subscription_id: subscriptionId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Subscription linked successfully', 'success');
            // Refresh the edit form with updated data
            editUser(currentEditingUserId);
        } else {
            showToast(data.error || 'Failed to link subscription', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error linking subscription', 'error');
    });
}

function unlinkStripeSubscription() {
    if (!confirm('Are you sure you want to unlink the Stripe subscription from this user?')) {
        return;
    }
    
    fetch(`/api/admin/user/${currentEditingUserId}/unlink-subscription`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Subscription unlinked successfully', 'success');
            document.getElementById('stripeSubscriptionId').value = '';
            document.getElementById('subscriptionInfoDisplay').style.display = 'none';
            // Update current status display
            updateCurrentSubscriptionDisplay('Free User', false);
        } else {
            showToast(data.error || 'Failed to unlink subscription', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error unlinking subscription', 'error');
    });
}

function updateCurrentSubscriptionDisplay(status, hasSubscription) {
    const statusDisplay = document.getElementById('currentSubscriptionStatus');
    statusDisplay.className = `subscription-status status-${hasSubscription ? 'active' : 'none'}`;
    statusDisplay.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <strong>Current Status:</strong> ${status}
            </div>
            <span class="badge bg-${hasSubscription ? 'success' : 'secondary'}">
                ${hasSubscription ? 'Active' : 'Inactive'}
            </span>
        </div>
    `;
}

function saveUserChanges() {
    const userData = {
        username: document.getElementById('editUsername').value,
        email: document.getElementById('editEmail').value,
        display_name: document.getElementById('editDisplayName').value,
        timezone: document.getElementById('editTimezone').value,
        is_admin: document.getElementById('editIsAdmin').checked,
        can_stream: document.getElementById('editCanStream').checked,
        subscription_plan: document.getElementById('editSubscriptionPlan').value,
        subscription_status: document.getElementById('editSubscriptionStatus').value,
        has_subscription: document.getElementById('editHasSubscription').checked
    };
    
    fetch(`/api/admin/user/${currentEditingUserId}/edit`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(userData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('User updated successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.error || 'Failed to update user', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error updating user', 'error');
    });
}

function syncUserWithStripe(userId) {
    showToast('Syncing user with Stripe...', 'info');
    
    fetch(`/api/admin/sync-all-subscriptions`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('User synced with Stripe successfully', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.error || 'Failed to sync user', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error syncing user', 'error');
    });
}

function syncAllUsersWithStripe() {
    if (!confirm('This will sync all users with Stripe. This may take a while. Continue?')) {
        return;
    }
    
    showToast('Syncing all users with Stripe...', 'info');
    
    fetch('/api/admin/sync-all-subscriptions', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(`Synced ${data.synced || 'all'} users successfully`, 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showToast(data.error || 'Failed to sync users', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error syncing users', 'error');
    });
}

function manageSubscription(userId) {
    // Redirect to existing subscription management
    window.location.href = `/admin/user/${userId}`;
}

function cancelSubscription(userId) {
    if (!confirm('Are you sure you want to cancel this user\'s subscription?')) {
        return;
    }
    
    fetch(`/api/admin/user/${userId}/grant-subscription`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({plan: 'cancel'})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Subscription canceled successfully', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.error || 'Failed to cancel subscription', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error canceling subscription', 'error');
    });
}

function grantSubscription(userId) {
    const modal = `
        <div class="form-section">
            <h6 class="text-success mb-3">Grant Subscription</h6>
            <div class="mb-3">
                <label class="form-label">Subscription Plan</label>
                <select class="form-select" id="grantPlan">
                    <option value="monthly">Monthly ($80/month)</option>
                    <option value="annual">Annual ($777/year)</option>
                    <option value="lifetime">Lifetime ($499 one-time)</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Duration (months) - Ignored for lifetime</label>
                <input type="number" class="form-control" id="grantDuration" value="1" min="1" max="12">
            </div>
            <div class="text-end">
                <button class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-success" onclick="confirmGrantSubscription(${userId})">
                    <span class="material-symbols-outlined me-2">star</span>
                    Grant Subscription
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('userModalTitle').textContent = 'Grant Subscription';
    document.getElementById('userModalBody').innerHTML = modal;
    new bootstrap.Modal(document.getElementById('userModal')).show();
}

function confirmGrantSubscription(userId) {
    const plan = document.getElementById('grantPlan').value;
    const duration = document.getElementById('grantDuration').value;
    
    fetch(`/api/admin/user/${userId}/grant-subscription`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({plan, duration: parseInt(duration)})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Subscription granted successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.error || 'Failed to grant subscription', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error granting subscription', 'error');
    });
}

function loginAsUser(userId) {
    if (!confirm('Login as this user? You will be logged out of your admin account.')) {
        return;
    }
    
    showToast('Switching to user account...', 'info');
    window.location.href = `/admin/user/${userId}`;
}

function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/admin/user/${userId}`, {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('User deleted successfully', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.error || 'Failed to delete user', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error deleting user', 'error');
    });
}

function exportUsers() {
    showToast('Exporting users...', 'info');
    window.open('/api/admin/users/export', '_blank');
}

function viewPaymentHistory(userId) {
    showToast('Loading payment history...', 'info');
    window.location.href = `/admin/user/${userId}`;
}

// Toast notification function
function showToast(message, type = 'info') {
    // Create toast element if it doesn't exist
    let toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    const toastId = 'toast_' + Date.now();
    const toastColors = {
        success: 'bg-success',
        error: 'bg-danger', 
        warning: 'bg-warning text-dark',
        info: 'bg-info'
    };
    
    const toastHTML = `
        <div id="${toastId}" class="toast ${toastColors[type] || toastColors.info}" role="alert">
            <div class="toast-body text-white">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, {delay: 4000});
    toast.show();
    
    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastElement.remove();
    });
}
</script>
{% endblock %}
