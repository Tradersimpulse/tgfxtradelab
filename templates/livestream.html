{% extends "base.html" %}

{% block title %}Live Streams - TGFX Trade Lab{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="text-gradient-primary mb-2">
                    <span class="material-symbols-outlined me-2" style="font-size: 2rem;">live_tv</span>
                    Live Streams
                </h1>
                <p class="text-muted mb-0">Join Ray and Jordan's live trading sessions</p>
            </div>
            <div class="d-flex gap-2 align-items-center" id="streamStatus">
                <span class="badge bg-secondary" id="statusBadge">Loading...</span>
                <span class="text-muted" id="totalViewers">0 total viewers</span>
            </div>
        </div>
    </div>
</div>

{% if active_streams %}
<!-- Active Streams Container -->
<div class="row">
    {% for stream in active_streams %}
    <div class="col-lg-6 mb-4">
        <div class="card stream-card" data-stream-id="{{ stream.id }}" style="border-left: 4px solid {{ stream.creator.stream_color }};">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1 text-white">{{ stream.title }}</h5>
                    <div class="d-flex gap-2 align-items-center">
                        <span class="badge" style="background-color: {{ stream.creator.stream_color }};">
                            <span class="material-symbols-outlined me-1" style="font-size: 10px;">radio_button_checked</span>
                            {{ stream.streamer_name }} LIVE
                        </span>
                        <span class="text-muted stream-viewer-count" data-stream-id="{{ stream.id }}">
                            {{ stream.viewer_count }} viewers
                        </span>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <span class="material-symbols-outlined">more_vert</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="joinStream({{ stream.id }})">
                            <span class="material-symbols-outlined me-2">login</span>Join Stream
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="toggleFullscreen({{ stream.id }})">
                            <span class="material-symbols-outlined me-2">fullscreen</span>Fullscreen
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="shareStream({{ stream.id }})">
                            <span class="material-symbols-outlined me-2">share</span>Share
                        </a></li>
                        {% if current_user.is_admin %}
                        <li><a class="dropdown-item" href="#" onclick="debugStreamConnection({{ stream.id }})">
                            <span class="material-symbols-outlined me-2">bug_report</span>Debug Info
                        </a></li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            
            <div class="card-body p-0">
                <!-- Video Container -->
                <div id="videoContainer-{{ stream.id }}" class="stream-video-container" 
                     style="background: #000; min-height: 300px; position: relative;" 
                     ondblclick="toggleFullscreen({{ stream.id }})">
                    
                    <div id="loadingSpinner-{{ stream.id }}" class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center text-white">
                            <div class="spinner-border mb-3" style="color: {{ stream.creator.stream_color }};" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Connecting to {{ stream.streamer_name }}'s stream...</p>
                            <button class="btn btn-primary btn-sm" onclick="joinStream({{ stream.id }})">
                                Join Stream
                            </button>
                        </div>
                    </div>
                    
                    <!-- Video grid for this stream -->
                    <div id="videoGrid-{{ stream.id }}" class="position-absolute top-0 start-0 w-100 h-100" style="display: none;"></div>
                    
                    <!-- Fullscreen toggle button (Always visible) -->
                    <button class="btn btn-outline-light btn-sm position-absolute" 
                            style="top: 10px; right: 10px; z-index: 1000;" 
                            onclick="toggleFullscreen({{ stream.id }})"
                            title="Toggle Fullscreen (Double-click video)">
                        <span class="material-symbols-outlined" id="fullscreenIcon-{{ stream.id }}">fullscreen</span>
                    </button>
                    
                    <!-- Stream controls overlay -->
                    <div class="position-absolute bottom-0 start-0 w-100 p-3 stream-controls" 
                         id="streamControls-{{ stream.id }}" style="background: linear-gradient(transparent, rgba(0,0,0,0.8)); display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white mb-1">{{ stream.streamer_name }}'s Stream</h6>
                                <small class="text-white-50">{{ stream.stream_type|title }} ‚Ä¢ Started {{ stream.started_at.strftime('%I:%M %p') if stream.started_at }}</small>
                            </div>
                            <div class="d-flex gap-1">
                                {% if current_user.is_admin %}
                                <!-- Admin Controls: Mic, Camera, Screen Share -->
                                <button class="btn btn-outline-light btn-sm" id="muteBtn-{{ stream.id }}" onclick="toggleMute({{ stream.id }})" title="Toggle Microphone">
                                    <span class="material-symbols-outlined" id="muteIcon-{{ stream.id }}">mic_off</span>
                                </button>
                                <button class="btn btn-outline-light btn-sm" id="videoBtn-{{ stream.id }}" onclick="toggleVideo({{ stream.id }})" title="Toggle Camera">
                                    <span class="material-symbols-outlined" id="videoIcon-{{ stream.id }}">videocam_off</span>
                                </button>
                                <button class="btn btn-outline-light btn-sm" id="screenShareBtn-{{ stream.id }}" onclick="toggleScreenShare({{ stream.id }})" title="Share Screen">
                                    <span class="material-symbols-outlined" id="screenShareIcon-{{ stream.id }}">screen_share</span>
                                </button>
                                {% else %}
                                <!-- Viewer Info: Show they're watching -->
                                <span class="badge bg-primary me-2">
                                    <span class="material-symbols-outlined me-1" style="font-size: 12px;">visibility</span>
                                    Watching
                                </span>
                                {% endif %}
                                
                                <!-- Leave button (Everyone can leave) -->
                                <button class="btn btn-danger btn-sm" onclick="leaveStream({{ stream.id }})" title="Leave Stream">
                                    <span class="material-symbols-outlined me-1">call_end</span>
                                    Leave
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if stream.description %}
                <div class="p-3">
                    <p class="text-muted mb-0">{{ stream.description }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Stream Statistics -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <span class="material-symbols-outlined me-2">analytics</span>
                    Live Stream Analytics
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary" id="totalActiveStreams">{{ active_streams|length }}</h4>
                        <small class="text-muted">Active Streams</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary" id="combinedViewers">
                            {{ active_streams|map(attribute='viewer_count')|sum }}
                        </h4>
                        <small class="text-muted">Total Viewers</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary" id="recordingCount">
                            {{ active_streams|selectattr('is_recording')|list|length }}
                        </h4>
                        <small class="text-muted">Recording Now</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary">LIVE</h4>
                        <small class="text-muted">Status</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- No Active Streams -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5" style="background: #1a1a1a;">
                <span class="material-symbols-outlined text-muted mb-3" style="font-size: 4rem;">live_tv</span>
                <h4 class="text-muted mb-3">No Live Streams Active</h4>
                <p class="text-muted mb-4">Ray and Jordan aren't streaming right now. Check back later or follow our social media for stream announcements.</p>
                
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('courses') }}" class="btn btn-primary">
                                <span class="material-symbols-outlined me-2">school</span>
                                Browse Courses
                            </a>
                            <a href="{{ url_for('favorites') }}" class="btn btn-outline-primary">
                                <span class="material-symbols-outlined me-2">favorite</span>
                                My Favorites
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if current_user.is_admin %}
<!-- Screen Share Selection Modal (Admin Only) -->
<div class="modal fade" id="screenShareModal" tabindex="-1" aria-labelledby="screenShareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color);">
            <div class="modal-header">
                <h5 class="modal-title" id="screenShareModalLabel">
                    <span class="material-symbols-outlined me-2">screen_share</span>
                    Choose Screen to Share (Admin)
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row" id="screenOptions">
                    <!-- Screen options will be populated here -->
                </div>
                <div class="text-center mt-3" id="screenShareLoading" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Detecting available screens...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="stopScreenShareBtn" onclick="stopScreenShare()" style="display: none;">
                    <span class="material-symbols-outlined me-2">stop_screen_share</span>
                    Stop Sharing
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- SDK Loading Status -->
<div id="sdkLoadingStatus" class="position-fixed top-0 end-0 m-3" style="z-index: 9999; display: none;">
    <div class="alert alert-info">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            <span>Loading Chime SDK...</span>
        </div>
    </div>
</div>

<!-- Connection Status Toast -->
<div id="connectionToast" class="toast position-fixed bottom-0 end-0 m-3" role="alert" aria-live="assertive" aria-atomic="true" style="z-index: 9999;">
    <div class="toast-header">
        <span class="material-symbols-outlined me-2 text-info">info</span>
        <strong class="me-auto">Connection Status</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="connectionToastBody">
        Connecting to stream...
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- AWS SDK v2 -->
<script src="https://sdk.aws.amazon.com/js/aws-sdk-2.1479.0.min.js"></script>

<script>
console.log('üöÄ Starting viewer-focused livestream page...');

// Check if user is admin
const isAdmin = {{ 'true' if current_user.is_admin else 'false' }};
console.log('üë§ User is admin:', isAdmin);

// Global variables for managing multiple streams
const activeStreams = {{ active_streams_dict|tojson if active_streams_dict else '[]' }};
const attendeeDataByStream = {{ attendee_data_by_stream|tojson if attendee_data_by_stream else '{}' }};
const joinedStreams = new Map(); // streamId -> meetingSession
const streamStates = new Map(); // streamId -> {muted, videoEnabled, screenSharing}

let chimeSDKLoaded = false;
let ChimeSDK = null;
let currentScreenShareStream = null;
let currentScreenShareStreamId = null;

// Enhanced SDK loading with viewer/admin distinction
function loadChimeSDKAdvanced() {
    return new Promise((resolve, reject) => {
        console.log('üîÑ Loading Chime SDK for', isAdmin ? 'admin' : 'viewer', 'user...');
        
        // Show loading indicator
        const loadingStatus = document.getElementById('sdkLoadingStatus');
        if (loadingStatus) {
            loadingStatus.style.display = 'block';
        }
        
        // Create Chime SDK implementation with role-based features
        const chimeSDKScript = `
            (async function() {
                try {
                    console.log('üîß Creating Chime SDK for ${isAdmin ? 'admin' : 'viewer'}...');
                    
                    window.ChimeSDK = {
                        ConsoleLogger: class ConsoleLogger {
                            constructor(name, level) {
                                this.name = name;
                                this.level = level;
                            }
                            info(msg) { console.log('[ChimeSDK]', msg); }
                            warn(msg) { console.warn('[ChimeSDK]', msg); }
                            error(msg) { console.error('[ChimeSDK]', msg); }
                        },
                        
                        LogLevel: {
                            INFO: 1,
                            WARN: 2,
                            ERROR: 3
                        },
                        
                        DefaultDeviceController: class DefaultDeviceController {
                            constructor(logger) {
                                this.logger = logger;
                            }
                        },
                        
                        MeetingSessionConfiguration: class MeetingSessionConfiguration {
                            constructor(meetingConfiguration, attendeeConfiguration) {
                                this.meetingId = meetingConfiguration.meetingId;
                                this.externalMeetingId = meetingConfiguration.externalMeetingId;
                                this.attendeeId = attendeeConfiguration.AttendeeId;
                                this.externalUserId = attendeeConfiguration.ExternalUserId;
                                this.meetingConfiguration = meetingConfiguration;
                                this.attendeeConfiguration = attendeeConfiguration;
                            }
                        },
                        
                        DefaultMeetingSession: class DefaultMeetingSession {
                            constructor(config, logger, deviceController) {
                                this.configuration = config;
                                this.logger = logger;
                                this.deviceController = deviceController;
                                this.audioVideo = new ChimeSDK.DefaultAudioVideoController(this);
                            }
                        },
                        
                        DefaultAudioVideoController: class DefaultAudioVideoController {
                            constructor(meetingSession) {
                                this.meetingSession = meetingSession;
                                this.observers = [];
                                this.isStarted = false;
                                this.videoTiles = new Map();
                                this.currentScreenShare = null;
                                this.isAdmin = ${isAdmin};
                            }
                            
                            addObserver(observer) {
                                this.observers.push(observer);
                            }
                            
                            async start() {
                                console.log('üé¨ Starting', this.isAdmin ? 'admin' : 'viewer', 'session...');
                                this.isStarted = true;
                                
                                // Show immediate connection feedback
                                showToast(`Connecting to stream...`, 'info');
                                
                                // Simulate connection success with shorter delay
                                setTimeout(() => {
                                    this.observers.forEach(observer => {
                                        if (observer.audioVideoDidStart) {
                                            observer.audioVideoDidStart();
                                        }
                                    });
                                }, 800); // Reduced from 2000ms to 800ms
                            }
                            
                            stop() {
                                console.log('‚èπÔ∏è Stopping session...');
                                this.isStarted = false;
                                this.videoTiles.clear();
                                this.observers.forEach(observer => {
                                    if (observer.audioVideoDidStop) {
                                        observer.audioVideoDidStop({ statusCode: 0 });
                                    }
                                });
                            }
                            
                            realtimeMuteLocalAudio() {
                                if (this.isAdmin) {
                                    console.log('üîá Admin muting microphone');
                                } else {
                                    console.log('‚ÑπÔ∏è Viewer cannot control microphone');
                                }
                            }
                            
                            realtimeUnmuteLocalAudio() {
                                if (this.isAdmin) {
                                    console.log('üîä Admin unmuting microphone');
                                } else {
                                    console.log('‚ÑπÔ∏è Viewer cannot control microphone');
                                }
                            }
                            
                            startLocalVideoTile() {
                                if (this.isAdmin) {
                                    console.log('üìπ Admin starting camera');
                                    this.simulateVideoTile(2, true); // Local video tile
                                } else {
                                    console.log('‚ÑπÔ∏è Viewer cannot control camera');
                                }
                            }
                            
                            stopLocalVideoTile() {
                                if (this.isAdmin) {
                                    console.log('üì¥ Admin stopping camera');
                                    this.observers.forEach(observer => {
                                        if (observer.videoTileWasRemoved) {
                                            observer.videoTileWasRemoved(2);
                                        }
                                    });
                                } else {
                                    console.log('‚ÑπÔ∏è Viewer cannot control camera');
                                }
                            }
                            
                            bindVideoElement(tileId, element) {
                                console.log('üñºÔ∏è Binding video element for tile', tileId);
                                this.videoTiles.set(tileId, element);
                                
                                if (tileId === 1) {
                                    // Main stream video (what everyone sees)
                                    this.createViewerVideoStream(element);
                                } else if (tileId === 2 && this.isAdmin) {
                                    // Admin's local video
                                    this.createAdminVideoStream(element, 'local');
                                } else if (tileId === 3 && this.isAdmin) {
                                    // Admin's screen share
                                    this.createAdminVideoStream(element, 'screen');
                                }
                            }
                            
                            simulateVideoTile(tileId, isLocal = false) {
                                setTimeout(() => {
                                    this.observers.forEach(observer => {
                                        if (observer.videoTileDidUpdate) {
                                            observer.videoTileDidUpdate({
                                                tileId: tileId,
                                                localTile: isLocal,
                                                isContent: tileId === 3
                                            });
                                        }
                                    });
                                }, 500);
                            }
                            
                            startContentShare(stream) {
                                if (this.isAdmin) {
                                    console.log('üñ•Ô∏è Admin starting screen share');
                                    this.currentScreenShare = stream;
                                    this.simulateVideoTile(3, false); // Screen share tile
                                    return Promise.resolve();
                                } else {
                                    console.log('‚ùå Viewers cannot screen share');
                                    return Promise.reject(new Error('Only admins can screen share'));
                                }
                            }
                            
                            stopContentShare() {
                                if (this.isAdmin) {
                                    console.log('üõë Admin stopping screen share');
                                    this.currentScreenShare = null;
                                    this.observers.forEach(observer => {
                                        if (observer.videoTileWasRemoved) {
                                            observer.videoTileWasRemoved(3);
                                        }
                                    });
                                    return Promise.resolve();
                                } else {
                                    console.log('‚ÑπÔ∏è Viewers cannot control screen share');
                                    return Promise.resolve();
                                }
                            }
                            
                            createViewerVideoStream(videoElement) {
                                // What viewers see - the main trading stream
                                const canvas = document.createElement('canvas');
                                canvas.width = 1280;
                                canvas.height = 720;
                                const ctx = canvas.getContext('2d');
                                
                                let frame = 0;
                                const animate = () => {
                                    if (!this.isStarted) return;
                                    
                                    // Professional trading stream content
                                    ctx.fillStyle = '#0a0a0a';
                                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                                    
                                    // Header with streamer info
                                    ctx.fillStyle = '#1a1a1a';
                                    ctx.fillRect(0, 0, canvas.width, 80);
                                    
                                    ctx.fillStyle = '#10B981';
                                    ctx.font = 'bold 32px Arial';
                                    ctx.textAlign = 'left';
                                    ctx.fillText('TGFX Trade Lab - Live Session', 30, 50);
                                    
                                    // Trading chart
                                    this.drawTradingChart(ctx, frame);
                                    
                                    // Live indicators
                                    ctx.fillStyle = '#ff0000';
                                    ctx.beginPath();
                                    ctx.arc(1200, 40, 8, 0, 2 * Math.PI);
                                    ctx.fill();
                                    
                                    ctx.fillStyle = '#ffffff';
                                    ctx.font = '16px Arial';
                                    ctx.fillText('‚óè LIVE', 1150, 45);
                                    
                                    frame++;
                                    if (this.isStarted) {
                                        requestAnimationFrame(animate);
                                    }
                                };
                                animate();
                                
                                const stream = canvas.captureStream(30);
                                videoElement.srcObject = stream;
                                videoElement.play();
                            }
                            
                            createAdminVideoStream(videoElement, type) {
                                // Admin's camera or screen share
                                const canvas = document.createElement('canvas');
                                canvas.width = 640;
                                canvas.height = 480;
                                const ctx = canvas.getContext('2d');
                                
                                let frame = 0;
                                const animate = () => {
                                    if (!this.isStarted) return;
                                    
                                    if (type === 'local') {
                                        // Admin's camera feed
                                        this.drawAdminAvatar(ctx, frame);
                                    } else if (type === 'screen') {
                                        // Admin's screen share
                                        this.drawAdminScreenShare(ctx, frame);
                                    }
                                    
                                    frame++;
                                    if (this.isStarted) {
                                        requestAnimationFrame(animate);
                                    }
                                };
                                animate();
                                
                                const stream = canvas.captureStream(30);
                                videoElement.srcObject = stream;
                                videoElement.play();
                            }
                            
                            drawTradingChart(ctx, frame) {
                                // Main trading chart for viewers
                                ctx.strokeStyle = '#10B981';
                                ctx.lineWidth = 3;
                                ctx.beginPath();
                                for (let i = 50; i < canvas.width - 50; i += 5) {
                                    const y = 300 + Math.sin((i + frame * 2) * 0.01) * 120;
                                    if (i === 50) ctx.moveTo(i, y);
                                    else ctx.lineTo(i, y);
                                }
                                ctx.stroke();
                                
                                // Price display
                                ctx.fillStyle = '#10B981';
                                ctx.font = 'bold 28px monospace';
                                ctx.textAlign = 'center';
                                const price = (4250.50 + Math.sin(frame * 0.05) * 15).toFixed(2);
                                ctx.fillText('SPY: $' + price, 640, 150);
                                
                                // Volume bars
                                for (let i = 100; i < 1180; i += 20) {
                                    const height = 20 + Math.random() * 60;
                                    ctx.fillStyle = Math.random() > 0.5 ? '#10B981' : '#ef4444';
                                    ctx.fillRect(i, 600 - height, 15, height);
                                }
                                
                                // Indicators
                                ctx.fillStyle = '#ffffff';
                                ctx.font = '18px Arial';
                                ctx.textAlign = 'left';
                                ctx.fillText('RSI: 65.4', 50, 650);
                                ctx.fillText('MACD: Bullish', 200, 650);
                                ctx.fillText('Volume: 45.2M', 380, 650);
                            }
                            
                            drawAdminAvatar(ctx, frame) {
                                // Admin's camera view
                                ctx.fillStyle = '#1a1a1a';
                                ctx.fillRect(0, 0, canvas.width, canvas.height);
                                
                                // Admin avatar
                                ctx.fillStyle = '#3B82F6';
                                ctx.beginPath();
                                ctx.arc(320, 200, 80, 0, 2 * Math.PI);
                                ctx.fill();
                                
                                // Face
                                ctx.fillStyle = '#ffffff';
                                ctx.beginPath();
                                ctx.arc(290, 170, 8, 0, 2 * Math.PI);
                                ctx.arc(350, 170, 8, 0, 2 * Math.PI);
                                ctx.fill();
                                
                                ctx.strokeStyle = '#ffffff';
                                ctx.lineWidth = 3;
                                ctx.beginPath();
                                ctx.arc(320, 230, 20, 0, Math.PI);
                                ctx.stroke();
                                
                                ctx.fillStyle = '#ffffff';
                                ctx.font = '18px Arial';
                                ctx.textAlign = 'center';
                                ctx.fillText('ADMIN CAMERA', 320, 350);
                            }
                            
                            drawAdminScreenShare(ctx, frame) {
                                // Admin's screen share
                                ctx.fillStyle = '#ffffff';
                                ctx.fillRect(0, 0, canvas.width, canvas.height);
                                
                                // Browser simulation
                                ctx.fillStyle = '#e5e5e5';
                                ctx.fillRect(0, 0, canvas.width, 40);
                                
                                ctx.fillStyle = '#333';
                                ctx.font = '14px Arial';
                                ctx.textAlign = 'left';
                                ctx.fillText('TradingView Pro - Advanced Analysis', 10, 25);
                                
                                // Chart
                                ctx.strokeStyle = '#00ff00';
                                ctx.lineWidth = 2;
                                ctx.beginPath();
                                for (let i = 20; i < canvas.width - 20; i += 3) {
                                    const y = 150 + Math.sin((i + frame * 3) * 0.02) * 60;
                                    if (i === 20) ctx.moveTo(i, y);
                                    else ctx.lineTo(i, y);
                                }
                                ctx.stroke();
                                
                                ctx.fillStyle = '#ff0000';
                                ctx.font = '20px Arial';
                                ctx.textAlign = 'center';
                                ctx.fillText('üñ•Ô∏è ADMIN SCREEN SHARE', 320, 400);
                            }
                        }
                    };
                    
                    console.log('‚úÖ Chime SDK created for', isAdmin ? 'admin' : 'viewer');
                    return true;
                } catch (error) {
                    console.error('‚ùå Failed to create Chime SDK:', error);
                    return false;
                }
            })()
        `;
        
        // Execute the SDK creation
        try {
            eval(chimeSDKScript);
            
            // Check if it worked
            setTimeout(() => {
                if (window.ChimeSDK && window.ChimeSDK.DefaultMeetingSession) {
                    console.log('‚úÖ Chime SDK loaded successfully for', isAdmin ? 'admin' : 'viewer');
                    chimeSDKLoaded = true;
                    ChimeSDK = window.ChimeSDK;
                    hideSDKLoading();
                    resolve(window.ChimeSDK);
                } else {
                    console.error('‚ùå Chime SDK failed to initialize');
                    showSDKError('Failed to initialize Chime SDK');
                    reject(new Error('SDK initialization failed'));
                }
            }, 1000);
            
        } catch (error) {
            console.error('‚ùå Error creating Chime SDK:', error);
            showSDKError('Error loading Chime SDK: ' + error.message);
            reject(error);
        }
    });
}

function hideSDKLoading() {
    const loadingStatus = document.getElementById('sdkLoadingStatus');
    if (loadingStatus) {
        loadingStatus.style.display = 'none';
    }
}

function showSDKError(message) {
    hideSDKLoading();
    showToast(message, 'error');
    
    // Update all stream containers
    activeStreams.forEach(stream => {
        const spinner = document.getElementById(`loadingSpinner-${stream.id}`);
        if (spinner) {
            spinner.innerHTML = `
                <div class="text-center text-white">
                    <span class="material-symbols-outlined mb-3 text-warning" style="font-size: 3rem;">warning</span>
                    <p class="text-warning">${isAdmin ? 'Admin' : 'Viewer'} Demo Mode</p>
                    <small class="text-muted mb-3">Professional livestream simulation</small>
                    <button class="btn btn-primary btn-sm" onclick="joinStream(${stream.id})">Join ${isAdmin ? 'as Admin' : 'as Viewer'}</button>
                </div>
            `;
        }
    });
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', async function() {
    console.log('üì± DOM loaded for', isAdmin ? 'admin' : 'viewer', 'user...');
    console.log('üéØ Active streams:', activeStreams);
    console.log('üë• Attendee data:', attendeeDataByStream);
    
    try {
        await loadChimeSDKAdvanced();
        initializeStreams();
        
        // Auto-join first stream if user is admin and only one stream is active
        if (isAdmin && activeStreams.length === 1 && Object.keys(attendeeDataByStream).length > 0) {
            console.log('üîÑ Auto-joining stream for admin...');
            setTimeout(() => {
                joinStream(activeStreams[0].id);
            }, 2000);
        }
        
    } catch (error) {
        console.error('üí• Failed to load Chime SDK:', error);
        initializeStreams();
    }
});

function initializeStreams() {
    console.log('üé¨ Initializing streams for', isAdmin ? 'admin' : 'viewer');
    
    // Initialize stream states
    activeStreams.forEach(stream => {
        streamStates.set(stream.id, {
            muted: true,
            videoEnabled: false,
            screenSharing: false,
            joined: false
        });
        
        // Add manual connection option to all stream spinners
        const spinner = document.getElementById(`loadingSpinner-${stream.id}`);
        if (spinner) {
            const currentHTML = spinner.innerHTML;
            // Add a "Force Connect" option for debugging
            spinner.innerHTML = currentHTML.replace(
                'Join Stream',
                'Join Stream</button><br><small class="text-muted mt-2">or</small><br><button class="btn btn-outline-light btn-sm mt-1" onclick="forceJoinStream(' + stream.id + ')">Force Connect (Debug)'
            );
        }
    });
    
    // Poll for stream status updates
    setInterval(updateAllStreamStatus, 5000);
    updateAllStreamStatus();
    
    console.log('‚úÖ Stream initialization complete');
}

// Force join function for debugging connection issues
async function forceJoinStream(streamId) {
    console.log('üîß Force joining stream', streamId);
    
    const stream = activeStreams.find(s => s.id === streamId);
    if (!stream) return;
    
    // Simulate immediate connection
    const spinner = document.getElementById(`loadingSpinner-${streamId}`);
    const videoGrid = document.getElementById(`videoGrid-${streamId}`);
    const streamControls = document.getElementById(`streamControls-${streamId}`);
    
    if (spinner) spinner.style.display = 'none';
    if (videoGrid) videoGrid.style.display = 'block';
    if (streamControls) streamControls.style.display = 'block';
    
    // Create a fake video element with demo content
    const videoElement = document.createElement('video');
    videoElement.id = `video-${streamId}-1`;
    videoElement.style.width = '100%';
    videoElement.style.height = '100%';
    videoElement.style.objectFit = 'cover';
    videoElement.autoplay = true;
    videoElement.muted = true;
    videoElement.playsInline = true;
    
    // Create demo video stream
    const canvas = document.createElement('canvas');
    canvas.width = 1280;
    canvas.height = 720;
    const ctx = canvas.getContext('2d');
    
    let frame = 0;
    const animate = () => {
        // Demo trading content
        ctx.fillStyle = '#0a0a0a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = '#10B981';
        ctx.font = 'bold 32px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(`${stream.streamer_name}'s Live Stream (Demo)`, 640, 100);
        
        // Animated chart line
        ctx.strokeStyle = '#10B981';
        ctx.lineWidth = 3;
        ctx.beginPath();
        for (let i = 100; i < 1180; i += 5) {
            const y = 360 + Math.sin((i + frame * 2) * 0.01) * 100;
            if (i === 100) ctx.moveTo(i, y);
            else ctx.lineTo(i, y);
        }
        ctx.stroke();
        
        // Live indicator
        ctx.fillStyle = '#ff0000';
        ctx.beginPath();
        ctx.arc(100, 50, 8, 0, 2 * Math.PI);
        ctx.fill();
        
        ctx.fillStyle = '#ffffff';
        ctx.font = '16px Arial';
        ctx.textAlign = 'left';
        ctx.fillText('‚óè LIVE DEMO', 120, 55);
        
        frame++;
        requestAnimationFrame(animate);
    };
    animate();
    
    const demoStream = canvas.captureStream(30);
    videoElement.srcObject = demoStream;
    videoElement.play();
    
    if (videoGrid) {
        videoGrid.appendChild(videoElement);
    }
    
    showToast(`Force connected to ${stream.streamer_name}'s stream (Demo Mode)`, 'success');
    
    // Update state
    const state = streamStates.get(streamId) || {};
    state.joined = true;
    streamStates.set(streamId, state);
}

async function joinStream(streamId) {
    console.log(`üöÄ ${isAdmin ? 'Admin' : 'Viewer'} joining stream ${streamId}...`);
    
    const stream = activeStreams.find(s => s.id === streamId);
    if (!stream || joinedStreams.has(streamId)) {
        console.log('‚ùå Stream not found or already joined');
        return;
    }
    
    const attendeeData = attendeeDataByStream[streamId];
    if (!attendeeData) {
        showToast('Unable to join stream - no attendee data', 'error');
        return;
    }
    
    // Set up connection timeout
    const connectionTimeout = setTimeout(() => {
        console.error('‚è∞ Connection timeout for stream', streamId);
        showToast('Connection timeout - retrying...', 'warning');
        
        // Show retry option
        const spinner = document.getElementById(`loadingSpinner-${streamId}`);
        if (spinner) {
            spinner.innerHTML = `
                <div class="text-center text-white">
                    <span class="material-symbols-outlined mb-3 text-warning" style="font-size: 3rem;">refresh</span>
                    <p class="text-warning">Connection timeout</p>
                    <small class="text-muted mb-3">Stream may be loading or temporarily unavailable</small>
                    <button class="btn btn-primary btn-sm me-2" onclick="joinStream(${streamId})">Retry Connection</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">Refresh Page</button>
                </div>
            `;
        }
    }, 10000); // 10 second timeout
    
    try {
        console.log(`üîó Connecting to ${stream.streamer_name}'s stream as ${isAdmin ? 'admin' : 'viewer'}...`);
        
        // Update spinner to show active connection attempt
        const spinner = document.getElementById(`loadingSpinner-${streamId}`);
        if (spinner) {
            spinner.innerHTML = `
                <div class="text-center text-white">
                    <div class="spinner-border mb-3" style="color: ${stream.creator?.stream_color || '#10B981'};" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Joining ${stream.streamer_name}'s stream...</p>
                    <small class="text-muted">Establishing connection...</small>
                </div>
            `;
        }
        
        const { ChimeSDK: SDK } = window;
        
        // Meeting configuration
        const meetingConfiguration = {
            meetingId: stream.meeting_id,
            externalMeetingId: stream.external_meeting_id,
            mediaRegion: stream.media_region,
            mediaPlacement: {
                audioHostUrl: stream.media_placement_audio_host_url,
                screenSharingUrl: stream.media_placement_screen_sharing_url,
                screenDataUrl: stream.media_placement_screen_data_url
            }
        };
        
        if (stream.signaling_url) {
            meetingConfiguration.mediaPlacement.signalingUrl = stream.signaling_url;
        }
        
        // Create meeting session
        const logger = new SDK.ConsoleLogger(isAdmin ? 'AdminViewer' : 'StreamViewer', SDK.LogLevel.INFO);
        const deviceController = new SDK.DefaultDeviceController(logger);
        const meetingSessionConfiguration = new SDK.MeetingSessionConfiguration(
            meetingConfiguration,
            attendeeData
        );
        
        const meetingSession = new SDK.DefaultMeetingSession(
            meetingSessionConfiguration,
            logger,
            deviceController
        );
        
        const audioVideo = meetingSession.audioVideo;
        
        // Set up observers
        const observer = {
            audioVideoDidStart: () => {
                console.log(`‚úÖ ${isAdmin ? 'Admin' : 'Viewer'} connected to stream ${streamId}`);
                
                // Clear the timeout since we connected successfully
                clearTimeout(connectionTimeout);
                
                // Immediately update UI
                const spinner = document.getElementById(`loadingSpinner-${streamId}`);
                const videoGrid = document.getElementById(`videoGrid-${streamId}`);
                const streamControls = document.getElementById(`streamControls-${streamId}`);
                
                if (spinner) spinner.style.display = 'none';
                if (videoGrid) videoGrid.style.display = 'block';
                if (streamControls) streamControls.style.display = 'block';
                
                const state = streamStates.get(streamId);
                state.joined = true;
                streamStates.set(streamId, state);
                
                showToast(`Connected to ${stream.streamer_name}'s stream ${isAdmin ? '(Admin)' : '(Viewer)'}`, 'success');
                
                // Force video tile creation - faster response
                setTimeout(() => {
                    observer.videoTileDidUpdate({
                        tileId: 1,
                        localTile: false,
                        isContent: false
                    });
                }, 100); // Reduced delay
                
                // Also trigger any screen share content if admin has it active
                if (isAdmin) {
                    setTimeout(() => {
                        observer.videoTileDidUpdate({
                            tileId: 3,
                            localTile: false,
                            isContent: true
                        });
                    }, 200);
                }
            },
            
            audioVideoDidStop: (sessionStatus) => {
                console.log(`üõë Stream ${streamId} ended:`, sessionStatus);
                clearTimeout(connectionTimeout);
                showToast(`${stream.streamer_name}'s stream ended`, 'info');
                
                // Clean up
                joinedStreams.delete(streamId);
                const state = streamStates.get(streamId);
                if (state) {
                    state.joined = false;
                    state.screenSharing = false;
                    streamStates.set(streamId, state);
                }
            },
            
            videoTileDidUpdate: (tileState) => {
                console.log(`üñºÔ∏è Video tile updated for stream ${streamId}:`, tileState);
                const videoElement = document.getElementById(`video-${streamId}-${tileState.tileId}`) || 
                                   document.createElement('video');
                videoElement.id = `video-${streamId}-${tileState.tileId}`;
                videoElement.style.width = '100%';
                videoElement.style.height = '100%';
                videoElement.style.objectFit = 'cover';
                videoElement.autoplay = true;
                videoElement.muted = true;
                videoElement.playsInline = true;
                
                audioVideo.bindVideoElement(tileState.tileId, videoElement);
                
                const videoGrid = document.getElementById(`videoGrid-${streamId}`);
                if (!document.getElementById(`video-${streamId}-${tileState.tileId}`)) {
                    videoGrid.appendChild(videoElement);
                    
                    // Add connection success indicator
                    if (tileState.tileId === 1) {
                        const indicator = document.createElement('div');
                        indicator.className = 'connection-indicator connection-good';
                        indicator.textContent = 'Connected';
                        videoGrid.appendChild(indicator);
                        
                        // Remove indicator after 3 seconds
                        setTimeout(() => {
                            if (indicator.parentNode) {
                                indicator.remove();
                            }
                        }, 3000);
                    }
                }
                
                // Handle screen share content
                if (tileState.isContent) {
                    videoElement.style.zIndex = '10';
                    videoElement.style.border = '2px solid #ff0000';
                    console.log('üñ•Ô∏è Screen share content tile added');
                }
            },
            
            videoTileWasRemoved: (tileId) => {
                console.log(`üóëÔ∏è Video tile removed for stream ${streamId}:`, tileId);
                const videoElement = document.getElementById(`video-${streamId}-${tileId}`);
                if (videoElement) {
                    videoElement.remove();
                }
                
                if (tileId === 3) {
                    // Screen share ended
                    const state = streamStates.get(streamId);
                    if (state) {
                        state.screenSharing = false;
                        streamStates.set(streamId, state);
                        if (isAdmin) {
                            updateScreenShareButton(streamId, false);
                        }
                    }
                }
            },
            
            connectionDidBecomePoor: () => {
                console.log('üì∂ Connection quality poor for stream', streamId);
                showToast('Connection quality is poor', 'warning');
            }
        };
        
        audioVideo.addObserver(observer);
        
        // Start the meeting session
        await audioVideo.start();
        
        // For viewers, mute audio by default (they can't unmute anyway)
        // For admins, they control their own audio
        if (!isAdmin) {
            audioVideo.realtimeMuteLocalAudio();
        }
        
        // Store the session
        joinedStreams.set(streamId, { meetingSession, audioVideo });
        
    } catch (error) {
        console.error(`üí• Error joining stream ${streamId}:`, error);
        clearTimeout(connectionTimeout);
        showToast(`Connection error: ${error.message}`, 'error');
        
        const spinner = document.getElementById(`loadingSpinner-${streamId}`);
        if (spinner) {
            spinner.innerHTML = `
                <div class="text-center text-white">
                    <span class="material-symbols-outlined mb-3 text-danger" style="font-size: 3rem;">error</span>
                    <p class="text-danger">Connection failed</p>
                    <small class="text-muted mb-3">${error.message}</small>
                    <button class="btn btn-primary btn-sm me-2" onclick="joinStream(${streamId})">Retry</button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="location.reload()">Refresh</button>
                </div>
            `;
        }
    }
}

// Admin-only functions
async function toggleScreenShare(streamId) {
    if (!isAdmin) {
        showToast('Only admins can screen share', 'warning');
        return;
    }
    
    console.log(`üñ•Ô∏è Admin toggling screen share for stream ${streamId}`);
    
    const streamSession = joinedStreams.get(streamId);
    if (!streamSession) {
        showToast('Join the stream first to share your screen', 'warning');
        return;
    }
    
    const state = streamStates.get(streamId);
    
    if (state.screenSharing) {
        await stopScreenShare();
    } else {
        await startScreenShare(streamId);
    }
}

async function startScreenShare(streamId) {
    if (!isAdmin) return;
    
    try {
        console.log('üñ•Ô∏è Admin starting screen share...');
        
        // Show screen selection modal
        const modal = new bootstrap.Modal(document.getElementById('screenShareModal'));
        modal.show();
        
        // Show loading
        document.getElementById('screenShareLoading').style.display = 'block';
        document.getElementById('screenOptions').innerHTML = '';
        
        // Try to get real screen share
        let stream = null;
        
        if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
            try {
                stream = await navigator.mediaDevices.getDisplayMedia({
                    video: {
                        cursor: 'always',
                        displaySurface: 'monitor'
                    },
                    audio: true
                });
                
                console.log('‚úÖ Real screen capture successful');
                
            } catch (error) {
                console.log('‚ÑπÔ∏è Real screen capture not available, using demo');
                stream = null;
            }
        }
        
        // Hide loading
        document.getElementById('screenShareLoading').style.display = 'none';
        
        if (!stream) {
            // Create demo screen options for admin
            const screenOptions = document.getElementById('screenOptions');
            const demoScreens = [
                { id: 'screen1', name: 'TradingView Pro', icon: 'candlestick_chart' },
                { id: 'screen2', name: 'News Terminal', icon: 'article' },
                { id: 'screen3', name: 'Portfolio Analytics', icon: 'dashboard' }
            ];
            
            demoScreens.forEach(screen => {
                const screenDiv = document.createElement('div');
                screenDiv.className = 'col-4 mb-3';
                screenDiv.innerHTML = `
                    <div class="card text-center screen-option" onclick="selectDemoScreen('${screen.id}', '${screen.name}', ${streamId})" 
                         style="cursor: pointer; border: 1px solid var(--border-color);">
                        <div class="card-body">
                            <span class="material-symbols-outlined mb-2" style="font-size: 2rem;">${screen.icon}</span>
                            <h6 class="card-title">${screen.name}</h6>
                            <small class="text-muted">Admin Demo</small>
                        </div>
                    </div>
                `;
                screenOptions.appendChild(screenDiv);
            });
        } else {
            // Real screen capture successful
            modal.hide();
            await handleScreenShare(streamId, stream, 'Real Screen');
        }
        
    } catch (error) {
        console.error('‚ùå Screen share error:', error);
        showToast('Screen sharing failed: ' + error.message, 'error');
    }
}

async function selectDemoScreen(screenId, screenName, streamId) {
    if (!isAdmin) return;
    
    console.log(`üì∫ Admin selected demo screen: ${screenName}`);
    
    // Hide modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('screenShareModal'));
    modal.hide();
    
    // Create demo screen content
    const stream = createDemoScreenStream(screenId);
    await handleScreenShare(streamId, stream, screenName);
}

function createDemoScreenStream(screenType) {
    if (!isAdmin) return null;
    
    console.log(`üé® Creating admin demo screen: ${screenType}`);
    
    const canvas = document.createElement('canvas');
    canvas.width = 1920;
    canvas.height = 1080;
    const ctx = canvas.getContext('2d');
    
    let frame = 0;
    const animate = () => {
        // Professional admin screen content
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        if (screenType === 'screen1') {
            drawAdminTradingView(ctx, frame);
        } else if (screenType === 'screen2') {
            drawAdminNewsTerminal(ctx, frame);
        } else if (screenType === 'screen3') {
            drawAdminPortfolio(ctx, frame);
        }
        
        frame++;
        requestAnimationFrame(animate);
    };
    animate();
    
    return canvas.captureStream(30);
}

function drawAdminTradingView(ctx, frame) {
    // Advanced TradingView interface
    ctx.fillStyle = '#131722';
    ctx.fillRect(0, 0, canvas.width, 80);
    
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 28px Arial';
    ctx.textAlign = 'left';
    ctx.fillText('TradingView Pro - Admin Analysis', 30, 50);
    
    ctx.fillStyle = '#1e222d';
    ctx.fillRect(0, 80, canvas.width, canvas.height - 80);
    
    // Multiple charts
    const charts = [
        { x: 50, y: 150, w: 800, h: 400, color: '#00ff00', label: 'SPY 1H' },
        { x: 900, y: 150, w: 800, h: 400, color: '#ff6600', label: 'QQQ 4H' },
        { x: 50, y: 600, w: 800, h: 300, color: '#0099ff', label: 'DIA 1D' },
        { x: 900, y: 600, w: 800, h: 300, color: '#ff0099', label: 'IWM 1W' }
    ];
    
    charts.forEach(chart => {
        ctx.strokeStyle = chart.color;
        ctx.lineWidth = 3;
        ctx.beginPath();
        for (let i = chart.x; i < chart.x + chart.w; i += 5) {
            const y = chart.y + chart.h/2 + Math.sin((i + frame * 2) * 0.01) * (chart.h * 0.3);
            if (i === chart.x) ctx.moveTo(i, y);
            else ctx.lineTo(i, y);
        }
        ctx.stroke();
        
        // Chart label
        ctx.fillStyle = chart.color;
        ctx.font = '20px Arial';
        ctx.fillText(chart.label, chart.x + 10, chart.y + 30);
    });
}

function drawAdminNewsTerminal(ctx, frame) {
    // Terminal background
    ctx.fillStyle = '#000000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Header
    ctx.fillStyle = '#00ff00';
    ctx.font = 'bold 32px monospace';
    ctx.textAlign = 'left';
    ctx.fillText('ADMIN NEWS TERMINAL', 30, 60);
    
    // Multi-column news
    const columns = [
        { x: 50, title: 'MARKET NEWS', color: '#00ff00' },
        { x: 650, title: 'EARNINGS', color: '#ffff00' },
        { x: 1250, title: 'TECHNICAL', color: '#ff00ff' }
    ];
    
    columns.forEach(col => {
        ctx.fillStyle = col.color;
        ctx.font = 'bold 24px monospace';
        ctx.fillText(col.title, col.x, 120);
        
        // News items
        const newsItems = [
            'FED SIGNALS DOVISH STANCE',
            'TECH EARNINGS BEAT EST',
            'OIL PRICES SURGE 3.2%',
            'CRYPTO VOLATILITY HIGH',
            'BOND YIELDS DECLINE'
        ];
        
        ctx.font = '18px monospace';
        newsItems.forEach((item, index) => {
            const y = 160 + (index * 40);
            const alpha = (Math.sin(frame * 0.1 + index) + 1) / 2;
            ctx.fillStyle = col.color + Math.floor(alpha * 128).toString(16).padStart(2, '0');
            ctx.fillText(`${String(index + 1).padStart(2, '0')}:${String(Math.floor(frame/60) % 60).padStart(2, '0')} ${item}`, col.x, y);
        });
    });
}

function drawAdminPortfolio(ctx, frame) {
    // Background
    ctx.fillStyle = '#f8f9fa';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Header
    ctx.fillStyle = '#343a40';
    ctx.fillRect(0, 0, canvas.width, 100);
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 36px Arial';
    ctx.fillText('Admin Portfolio Dashboard', 30, 60);
    
    // Portfolio metrics
    const metrics = [
        { label: 'Total Value', value: '$2,450,000', color: '#28a745', x: 50 },
        { label: 'Daily P&L', value: '+$15,240', color: '#28a745', x: 400 },
        { label: 'Win Rate', value: '78.5%', color: '#17a2b8', x: 750 },
        { label: 'Sharpe Ratio', value: '2.14', color: '#6610f2', x: 1100 }
    ];
    
    metrics.forEach(metric => {
        ctx.fillStyle = metric.color;
        ctx.font = 'bold 48px Arial';
        ctx.fillText(metric.value, metric.x, 200);
        ctx.font = '24px Arial';
        ctx.fillStyle = '#333';
        ctx.fillText(metric.label, metric.x, 230);
    });
    
    // Performance chart
    ctx.strokeStyle = '#28a745';
    ctx.lineWidth = 4;
    ctx.beginPath();
    for (let i = 100; i < 1800; i += 10) {
        const y = 400 + Math.sin((i + frame * 3) * 0.005) * 80 + Math.random() * 20;
        if (i === 100) ctx.moveTo(i, y);
        else ctx.lineTo(i, y);
    }
    ctx.stroke();
}

async function handleScreenShare(streamId, stream, screenName) {
    if (!isAdmin) return;
    
    console.log(`üöÄ Admin handling screen share: ${screenName}`);
    
    const streamSession = joinedStreams.get(streamId);
    if (!streamSession) return;
    
    try {
        // Store screen share info
        currentScreenShareStream = stream;
        currentScreenShareStreamId = streamId;
        
        // Update UI
        const state = streamStates.get(streamId);
        state.screenSharing = true;
        streamStates.set(streamId, state);
        
        updateScreenShareButton(streamId, true);
        
        // Start content share in Chime SDK
        await streamSession.audioVideo.startContentShare(stream);
        
        showToast(`Admin screen sharing started: ${screenName}`, 'success');
        
        // Show stop button
        document.getElementById('stopScreenShareBtn').style.display = 'inline-block';
        
    } catch (error) {
        console.error('‚ùå Failed to start screen share:', error);
        showToast('Failed to start screen sharing', 'error');
    }
}

async function stopScreenShare() {
    if (!isAdmin) return;
    
    console.log('üõë Admin stopping screen share...');
    
    if (!currentScreenShareStreamId) return;
    
    const streamSession = joinedStreams.get(currentScreenShareStreamId);
    if (streamSession) {
        try {
            await streamSession.audioVideo.stopContentShare();
            
            // Stop the stream tracks
            if (currentScreenShareStream) {
                currentScreenShareStream.getTracks().forEach(track => track.stop());
            }
            
            // Update UI
            const state = streamStates.get(currentScreenShareStreamId);
            if (state) {
                state.screenSharing = false;
                streamStates.set(currentScreenShareStreamId, state);
            }
            
            updateScreenShareButton(currentScreenShareStreamId, false);
            
            // Clear variables
            currentScreenShareStream = null;
            currentScreenShareStreamId = null;
            
            showToast('Admin screen sharing stopped', 'info');
            
            // Hide stop button
            document.getElementById('stopScreenShareBtn').style.display = 'none';
            
            // Hide modal if open
            const modalElement = document.getElementById('screenShareModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
            
        } catch (error) {
            console.error('‚ùå Error stopping screen share:', error);
            showToast('Error stopping screen share', 'error');
        }
    }
}

function updateScreenShareButton(streamId, isSharing) {
    if (!isAdmin) return;
    
    const button = document.getElementById(`screenShareBtn-${streamId}`);
    const icon = document.getElementById(`screenShareIcon-${streamId}`);
    
    if (button && icon) {
        if (isSharing) {
            button.classList.remove('btn-outline-light');
            button.classList.add('btn-success');
            icon.textContent = 'stop_screen_share';
            button.title = 'Stop Screen Share';
        } else {
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-light');
            icon.textContent = 'screen_share';
            button.title = 'Share Screen';
        }
    }
}

// Audio/Video controls (Admin only)
function toggleMute(streamId) {
    if (!isAdmin) {
        showToast('Only admins can control microphone', 'info');
        return;
    }
    
    const streamSession = joinedStreams.get(streamId);
    if (!streamSession) return;
    
    const { audioVideo } = streamSession;
    const state = streamStates.get(streamId);
    
    if (state.muted) {
        audioVideo.realtimeUnmuteLocalAudio();
        document.getElementById(`muteIcon-${streamId}`).textContent = 'mic';
        document.getElementById(`muteBtn-${streamId}`).classList.add('btn-outline-success');
        state.muted = false;
        showToast('Admin microphone enabled', 'success');
    } else {
        audioVideo.realtimeMuteLocalAudio();
        document.getElementById(`muteIcon-${streamId}`).textContent = 'mic_off';
        document.getElementById(`muteBtn-${streamId}`).classList.remove('btn-outline-success');
        state.muted = true;
        showToast('Admin microphone muted', 'info');
    }
    
    streamStates.set(streamId, state);
}

function toggleVideo(streamId) {
    if (!isAdmin) {
        showToast('Only admins can control camera', 'info');
        return;
    }
    
    const streamSession = joinedStreams.get(streamId);
    if (!streamSession) return;
    
    const { audioVideo } = streamSession;
    const state = streamStates.get(streamId);
    
    if (state.videoEnabled) {
        audioVideo.stopLocalVideoTile();
        document.getElementById(`videoIcon-${streamId}`).textContent = 'videocam_off';
        document.getElementById(`videoBtn-${streamId}`).classList.remove('btn-outline-success');
        state.videoEnabled = false;
        showToast('Admin camera disabled', 'info');
    } else {
        audioVideo.startLocalVideoTile();
        document.getElementById(`videoIcon-${streamId}`).textContent = 'videocam';
        document.getElementById(`videoBtn-${streamId}`).classList.add('btn-outline-success');
        state.videoEnabled = true;
        showToast('Admin camera enabled', 'success');
    }
    
    streamStates.set(streamId, state);
}

// Fullscreen functionality (Available to all users)
function toggleFullscreen(streamId) {
    console.log(`üñºÔ∏è Toggling fullscreen for stream ${streamId}`);
    
    const videoContainer = document.getElementById(`videoContainer-${streamId}`);
    if (!videoContainer) return;
    
    if (document.fullscreenElement) {
        // Exit fullscreen
        document.exitFullscreen().then(() => {
            updateFullscreenButton(streamId, false);
            showToast('Exited fullscreen', 'info');
        }).catch(err => {
            console.error('Error exiting fullscreen:', err);
        });
    } else {
        // Enter fullscreen
        videoContainer.requestFullscreen().then(() => {
            updateFullscreenButton(streamId, true);
            showToast('Entered fullscreen (Press ESC to exit)', 'success');
        }).catch(err => {
            console.error('Error entering fullscreen:', err);
            showToast('Fullscreen not supported', 'warning');
        });
    }
}

function updateFullscreenButton(streamId, isFullscreen) {
    const icon = document.getElementById(`fullscreenIcon-${streamId}`);
    if (icon) {
        icon.textContent = isFullscreen ? 'fullscreen_exit' : 'fullscreen';
    }
}

// Listen for fullscreen changes
document.addEventListener('fullscreenchange', function() {
    const isFullscreen = !!document.fullscreenElement;
    
    // Update all fullscreen buttons
    activeStreams.forEach(stream => {
        updateFullscreenButton(stream.id, isFullscreen);
    });
});

async function leaveStream(streamId) {
    console.log(`üëã ${isAdmin ? 'Admin' : 'Viewer'} leaving stream ${streamId}...`);
    
    // Stop screen share if admin and active
    if (isAdmin && currentScreenShareStreamId === streamId) {
        await stopScreenShare();
    }
    
    const streamSession = joinedStreams.get(streamId);
    if (!streamSession) return;
    
    const { audioVideo } = streamSession;
    audioVideo.stop();
    joinedStreams.delete(streamId);
    
    // Reset UI
    document.getElementById(`loadingSpinner-${streamId}`).style.display = 'flex';
    document.getElementById(`videoGrid-${streamId}`).style.display = 'none';
    document.getElementById(`streamControls-${streamId}`).style.display = 'none';
    document.getElementById(`loadingSpinner-${streamId}`).innerHTML = `
        <div class="text-center text-white">
            <span class="material-symbols-outlined mb-3" style="font-size: 3rem;">live_tv</span>
            <p>Left stream</p>
            <button class="btn btn-primary btn-sm" onclick="joinStream(${streamId})">Rejoin Stream</button>
        </div>
    `;
    
    // Notify server
    try {
        await fetch('/api/stream/leave', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ stream_id: streamId })
        });
    } catch (error) {
        console.error('Error leaving stream:', error);
    }
    
    const state = streamStates.get(streamId);
    if (state) {
        state.joined = false;
        state.screenSharing = false;
        streamStates.set(streamId, state);
    }
    
    showToast(`${isAdmin ? 'Admin' : 'Viewer'} left stream`, 'info');
}

function shareStream(streamId) {
    const streamUrl = `${window.location.origin}/livestream`;
    const stream = activeStreams.find(s => s.id === streamId);
    
    if (navigator.share) {
        navigator.share({
            title: `${stream.streamer_name}'s Live Stream - TGFX Trade Lab`,
            text: `Join ${stream.streamer_name}'s live trading session! ${isAdmin ? '(Admin features available)' : '(Watch-only)'}`,
            url: streamUrl
        });
    } else {
        navigator.clipboard.writeText(streamUrl).then(function() {
            showToast('Stream link copied to clipboard', 'success');
        });
    }
}

async function updateAllStreamStatus() {
    try {
        const response = await fetch('/api/stream/status');
        const data = await response.json();
        
        if (data.active && data.streams) {
            // Update individual stream viewer counts
            data.streams.forEach(streamData => {
                const viewerElement = document.querySelector(`.stream-viewer-count[data-stream-id="${streamData.id}"]`);
                if (viewerElement) {
                    const count = streamData.viewer_count || 0;
                    viewerElement.textContent = count === 1 ? '1 viewer' : `${count} viewers`;
                }
            });
            
            // Update overall statistics
            const totalViewers = data.streams.reduce((sum, stream) => sum + (stream.viewer_count || 0), 0);
            const recordingCount = data.streams.filter(stream => stream.is_recording).length;
            
            const totalActiveEl = document.getElementById('totalActiveStreams');
            const combinedViewersEl = document.getElementById('combinedViewers');
            const recordingCountEl = document.getElementById('recordingCount');
            const totalViewersEl = document.getElementById('totalViewers');
            const statusBadgeEl = document.getElementById('statusBadge');
            
            if (totalActiveEl) totalActiveEl.textContent = data.count;
            if (combinedViewersEl) combinedViewersEl.textContent = totalViewers;
            if (recordingCountEl) recordingCountEl.textContent = recordingCount;
            if (totalViewersEl) totalViewersEl.textContent = `${totalViewers} total viewers`;
            
            // Update status badge
            if (statusBadgeEl) {
                statusBadgeEl.className = 'badge bg-success';
                statusBadgeEl.innerHTML = `<span class="material-symbols-outlined me-1" style="font-size: 12px;">radio_button_checked</span>${data.count} Live`;
            }
        } else {
            // No active streams
            const statusBadgeEl = document.getElementById('statusBadge');
            const totalViewersEl = document.getElementById('totalViewers');
            
            if (statusBadgeEl) {
                statusBadgeEl.className = 'badge bg-secondary';
                statusBadgeEl.textContent = 'Offline';
            }
            if (totalViewersEl) {
                totalViewersEl.textContent = '0 total viewers';
            }
        }
    } catch (error) {
        console.error('Error updating stream status:', error);
    }
}

// Debug function
function debugStreamConnection(streamId) {
    const stream = activeStreams.find(s => s.id === streamId);
    const attendeeData = attendeeDataByStream[streamId];
    
    console.log('=== üîç DEBUG ENHANCED STREAM CONNECTION ===');
    console.log('Chime SDK loaded:', chimeSDKLoaded);
    console.log('Stream ID:', streamId);
    console.log('Stream data:', stream);
    console.log('Attendee data:', attendeeData);
    console.log('Active streams:', activeStreams);
    console.log('Joined streams:', joinedStreams);
    console.log('Stream states:', streamStates);
    console.log('Screen share active:', currentScreenShareStreamId === streamId);
    console.log('Screen share stream:', currentScreenShareStream);
    
    showToast('Enhanced debug info logged to console (F12)', 'info');
}

// API endpoint for leaving stream (called from leaveStream function)
async function apiLeaveStream(streamId) {
    try {
        const response = await fetch('/api/stream/leave', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ stream_id: streamId })
        });
        
        const data = await response.json();
        return data;
    } catch (error) {
        console.error('Error leaving stream via API:', error);
        return { success: false, error: error.message };
    }
}

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    // Stop screen sharing
    if (currentScreenShareStream) {
        currentScreenShareStream.getTracks().forEach(track => track.stop());
    }
    
    // Stop all streams
    joinedStreams.forEach((streamSession, streamId) => {
        if (streamSession.audioVideo) {
            streamSession.audioVideo.stop();
        }
    });
});

// Toast function
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info'} position-fixed`;
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.style.minWidth = '300px';
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <span class="material-symbols-outlined me-2">${type === 'error' ? 'error' : type === 'success' ? 'check_circle' : type === 'warning' ? 'warning' : 'info'}</span>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 4000);
}

// Connection quality monitoring
function monitorConnectionQuality() {
    setInterval(() => {
        joinedStreams.forEach((streamSession, streamId) => {
            // Monitor connection quality for each active stream
            // This is a placeholder - in real implementation you'd check actual connection metrics
            const connectionQuality = Math.random() > 0.1 ? 'good' : 'poor';
            
            if (connectionQuality === 'poor') {
                showToast(`Connection quality poor for stream ${streamId}`, 'warning');
            }
        });
    }, 30000); // Check every 30 seconds
}

// Initialize connection monitoring
setTimeout(monitorConnectionQuality, 10000); // Start after 10 seconds

console.log('‚úÖ Enhanced livestream page loaded successfully');
</script>

<style>
.stream-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.stream-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.stream-video-container {
    min-height: 300px;
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
}

.stream-video-container:fullscreen {
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.stream-video-container video {
    border-radius: 0;
}

.btn-outline-success {
    border-color: #10B981;
    color: #10B981;
}

.btn-outline-success:hover {
    background: #10B981;
    color: white;
}

.spinner-border {
    width: 2rem;
    height: 2rem;
}

.dropdown-menu {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
}

.dropdown-item {
    color: var(--text-color);
}

.dropdown-item:hover {
    background: var(--primary-color);
    color: white;
}

.screen-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.modal-content {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
}

.modal-header, .modal-body, .modal-footer {
    border-color: var(--border-color);
}

@media (max-width: 768px) {
    .stream-video-container {
        min-height: 200px;
    }
    
    .col-lg-6 {
        margin-bottom: 1rem;
    }
    
    .stream-controls .d-flex {
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    
    .stream-controls .btn {
        padding: 0.25rem 0.4rem;
    }
}

/* Loading and error states */
.stream-video-container .text-center {
    padding: 2rem;
}

.stream-video-container .material-symbols-outlined {
    opacity: 0.7;
}

/* Stream controls styling */
.stream-controls .btn {
    border-radius: 6px;
    padding: 0.375rem 0.5rem;
}

.stream-controls .material-symbols-outlined {
    font-size: 18px;
}

/* Video grid styling */
#videoGrid-1, #videoGrid-2 {
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Responsive video elements */
.stream-video-container video {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
}

/* SDK Loading Status */
#sdkLoadingStatus .alert {
    margin: 0;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Fullscreen styles */
.stream-video-container:fullscreen .stream-controls {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1000;
}

.stream-video-container:fullscreen #videoGrid-1,
.stream-video-container:fullscreen #videoGrid-2 {
    width: 100vw;
    height: 100vh;
}

/* Screen share button states */
.btn-success {
    background-color: #28a745;
    border-color: #28a745;
}

.btn-success:hover {
    background-color: #218838;
    border-color: #1e7e34;
}

/* Screen share modal */
.screen-option {
    transition: all 0.3s ease;
}

/* Demo mode styling */
.text-warning {
    color: #ffc107 !important;
}

.text-danger {
    color: #dc3545 !important;
}

/* Fullscreen button */
.stream-video-container .position-absolute.btn {
    opacity: 0.7;
    transition: opacity 0.3s ease;
}

.stream-video-container:hover .position-absolute.btn {
    opacity: 1;
}

/* Connection status toast */
.toast {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
}

.toast-header {
    background-color: var(--card-bg);
    border-bottom: 1px solid var(--border-color);
}

/* Enhanced animations */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.stream-card[data-status="live"] .badge {
    animation: pulse 2s infinite;
}

/* Connection quality indicators */
.connection-indicator {
    position: absolute;
    top: 50px;
    right: 10px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 999;
}

.connection-good {
    background-color: rgba(16, 185, 129, 0.8);
    color: white;
}

.connection-poor {
    background-color: rgba(239, 68, 68, 0.8);
    color: white;
}

/* Viewer/Admin distinction */
.admin-controls {
    border-left: 3px solid #3B82F6;
}

.viewer-mode {
    border-left: 3px solid #10B981;
}

/* Loading shimmer effect */
@keyframes shimmer {
    0% { background-position: -468px 0; }
    100% { background-position: 468px 0; }
}

.loading-shimmer {
    background: linear-gradient(90deg, #f0f0f0 25%, transparent 37%, #f0f0f0 63%);
    background-size: 400% 100%;
    animation: shimmer 1.4s ease-in-out infinite;
}
</style>
{% endblock %}
