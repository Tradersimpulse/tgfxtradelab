{% extends "base.html" %}

{% block title %}Live Streams - TGFX Trade Lab{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="text-gradient-primary mb-2">
                    <span class="material-symbols-outlined me-2" style="font-size: 2rem;">live_tv</span>
                    Live Streams
                </h1>
                <p class="text-muted mb-0">Join Ray and Jordan's live trading sessions</p>
            </div>
            <div class="d-flex gap-2 align-items-center" id="streamStatus">
                <span class="badge bg-secondary" id="statusBadge">Loading...</span>
                <span class="text-muted" id="totalViewers">0 total viewers</span>
            </div>
        </div>
    </div>
</div>

{% if active_streams %}
<!-- Active Streams Container -->
<div class="row">
    {% for stream in active_streams %}
    <div class="col-lg-6 mb-4">
        <div class="card stream-card" data-stream-id="{{ stream.id }}" style="border-left: 4px solid {{ stream.creator.stream_color }};">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-1 text-white">{{ stream.title }}</h5>
                    <div class="d-flex gap-2 align-items-center">
                        <span class="badge" style="background-color: {{ stream.creator.stream_color }};">
                            <span class="material-symbols-outlined me-1" style="font-size: 10px;">radio_button_checked</span>
                            {{ stream.streamer_name }} LIVE
                        </span>
                        <span class="text-muted stream-viewer-count" data-stream-id="{{ stream.id }}">
                            {{ stream.viewer_count }} viewers
                        </span>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <span class="material-symbols-outlined">more_vert</span>
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="joinStream({{ stream.id }})">
                            <span class="material-symbols-outlined me-2">login</span>Join Stream
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="toggleFullscreen({{ stream.id }})">
                            <span class="material-symbols-outlined me-2">fullscreen</span>Fullscreen
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="shareStream({{ stream.id }})">
                            <span class="material-symbols-outlined me-2">share</span>Share
                        </a></li>
                        {% if current_user.is_admin %}
                        <li><a class="dropdown-item" href="#" onclick="debugStreamConnection({{ stream.id }})">
                            <span class="material-symbols-outlined me-2">bug_report</span>Debug Info
                        </a></li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            
            <div class="card-body p-0">
                <!-- Video Container -->
                <div id="videoContainer-{{ stream.id }}" class="stream-video-container" 
                     style="background: #000; min-height: 300px; position: relative;" 
                     ondblclick="toggleFullscreen({{ stream.id }})">
                    
                    <div id="loadingSpinner-{{ stream.id }}" class="d-flex align-items-center justify-content-center h-100">
                        <div class="text-center text-white">
                            <div class="spinner-border mb-3" style="color: {{ stream.creator.stream_color }};" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p>Connecting to {{ stream.streamer_name }}'s stream...</p>
                            <button class="btn btn-primary btn-sm" onclick="joinStream({{ stream.id }})">
                                Join Stream
                            </button>
                        </div>
                    </div>
                    
                    <!-- Video grid for this stream -->
                    <div id="videoGrid-{{ stream.id }}" class="position-absolute top-0 start-0 w-100 h-100" style="display: none;"></div>
                    
                    <!-- Fullscreen toggle button (Always visible) -->
                    <button class="btn btn-outline-light btn-sm position-absolute" 
                            style="top: 10px; right: 10px; z-index: 1000;" 
                            onclick="toggleFullscreen({{ stream.id }})"
                            title="Toggle Fullscreen (Double-click video)">
                        <span class="material-symbols-outlined" id="fullscreenIcon-{{ stream.id }}">fullscreen</span>
                    </button>
                    
                    <!-- Stream controls overlay -->
                    <div class="position-absolute bottom-0 start-0 w-100 p-3 stream-controls" 
                         id="streamControls-{{ stream.id }}" style="background: linear-gradient(transparent, rgba(0,0,0,0.8)); display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white mb-1">{{ stream.streamer_name }}'s Stream</h6>
                                <small class="text-white-50">{{ stream.stream_type|title }} ‚Ä¢ Started {{ stream.started_at.strftime('%I:%M %p') if stream.started_at }}</small>
                            </div>
                            <div class="d-flex gap-1">
                                {% if current_user.is_admin %}
                                <!-- Admin Controls: Mic, Camera, Screen Share -->
                                <button class="btn btn-outline-light btn-sm" id="muteBtn-{{ stream.id }}" onclick="toggleMute({{ stream.id }})" title="Toggle Microphone">
                                    <span class="material-symbols-outlined" id="muteIcon-{{ stream.id }}">mic_off</span>
                                </button>
                                <button class="btn btn-outline-light btn-sm" id="videoBtn-{{ stream.id }}" onclick="toggleVideo({{ stream.id }})" title="Toggle Camera">
                                    <span class="material-symbols-outlined" id="videoIcon-{{ stream.id }}">videocam_off</span>
                                </button>
                                <button class="btn btn-outline-light btn-sm" id="screenShareBtn-{{ stream.id }}" onclick="toggleScreenShare({{ stream.id }})" title="Share Screen">
                                    <span class="material-symbols-outlined" id="screenShareIcon-{{ stream.id }}">screen_share</span>
                                </button>
                                {% else %}
                                <!-- Viewer Info: Show they're watching -->
                                <span class="badge bg-primary me-2">
                                    <span class="material-symbols-outlined me-1" style="font-size: 12px;">visibility</span>
                                    Watching
                                </span>
                                {% endif %}
                                
                                <!-- Leave button (Everyone can leave) -->
                                <button class="btn btn-danger btn-sm" onclick="leaveStream({{ stream.id }})" title="Leave Stream">
                                    <span class="material-symbols-outlined me-1">call_end</span>
                                    Leave
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% if stream.description %}
                <div class="p-3">
                    <p class="text-muted mb-0">{{ stream.description }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Stream Statistics -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <span class="material-symbols-outlined me-2">analytics</span>
                    Live Stream Analytics
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary" id="totalActiveStreams">{{ active_streams|length }}</h4>
                        <small class="text-muted">Active Streams</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary" id="combinedViewers">
                            {{ active_streams|map(attribute='viewer_count')|sum }}
                        </h4>
                        <small class="text-muted">Total Viewers</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary" id="recordingCount">
                            {{ active_streams|selectattr('is_recording')|list|length }}
                        </h4>
                        <small class="text-muted">Recording Now</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-gradient-primary">LIVE</h4>
                        <small class="text-muted">Status</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- No Active Streams -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5" style="background: #1a1a1a;">
                <span class="material-symbols-outlined text-muted mb-3" style="font-size: 4rem;">live_tv</span>
                <h4 class="text-muted mb-3">No Live Streams Active</h4>
                <p class="text-muted mb-4">Ray and Jordan aren't streaming right now. Check back later or follow our social media for stream announcements.</p>
                
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('courses') }}" class="btn btn-primary">
                                <span class="material-symbols-outlined me-2">school</span>
                                Browse Courses
                            </a>
                            <a href="{{ url_for('favorites') }}" class="btn btn-outline-primary">
                                <span class="material-symbols-outlined me-2">favorite</span>
                                My Favorites
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if current_user.is_admin %}
<!-- Screen Share Selection Modal (Admin Only) -->
<div class="modal fade" id="screenShareModal" tabindex="-1" aria-labelledby="screenShareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--card-bg); border: 1px solid var(--border-color);">
            <div class="modal-header">
                <h5 class="modal-title" id="screenShareModalLabel">
                    <span class="material-symbols-outlined me-2">screen_share</span>
                    Choose Screen to Share (Admin)
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row" id="screenOptions">
                    <!-- Screen options will be populated here -->
                </div>
                <div class="text-center mt-3" id="screenShareLoading" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Detecting available screens...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="stopScreenShareBtn" onclick="stopScreenShare()" style="display: none;">
                    <span class="material-symbols-outlined me-2">stop_screen_share</span>
                    Stop Sharing
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- SDK Loading Status -->
<div id="sdkLoadingStatus" class="position-fixed top-0 end-0 m-3" style="z-index: 9999; display: none;">
    <div class="alert alert-info">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            <span>Loading Chime SDK...</span>
        </div>
    </div>
</div>

<!-- Connection Status Toast -->
<div id="connectionToast" class="toast position-fixed bottom-0 end-0 m-3" role="alert" aria-live="assertive" aria-atomic="true" style="z-index: 9999;">
    <div class="toast-header">
        <span class="material-symbols-outlined me-2 text-info">info</span>
        <strong class="me-auto">Connection Status</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="connectionToastBody">
        Connecting to stream...
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- AWS SDK removed due to loading issues, using demo mode with real screen share support -->

<script>
// Set template data for JavaScript
window.isAdminUser = {{ 'true' if current_user.is_admin else 'false' }};
window.activeStreamsData = {{ active_streams_dict|tojson if active_streams_dict else '[]' }};
window.attendeeDataByStream = {{ attendee_data_by_stream|tojson if attendee_data_by_stream else '{}' }};

console.log('üöÄ Starting viewer-focused livestream page...');

// Check if user is admin
const isAdmin = window.isAdminUser || false;
console.log('üë§ User is admin:', isAdmin);

// Global variables for managing multiple streams
const activeStreams = window.activeStreamsData || [];
const attendeeDataByStream = window.attendeeDataByStream || {};
const joinedStreams = new Map(); // streamId -> meetingSession
const streamStates = new Map(); // streamId -> {muted, videoEnabled, screenSharing}

// BroadcastChannel setup for screen sharing
window.screenShareChannel = new BroadcastChannel('screen-share-channel');
window.activeScreenShareStreams = new Set();

// Screen sharing state management
let currentScreenShareStream = null;
let currentScreenShareStreamId = null;
window.currentScreenShareName = null;
window.screenShareCanvas = null;

// Store user stream states for admin
window.userStreamStates = null;
if (isAdmin) {
    window.userStreamStates = {
        screenSharing: false
    };
}

// Debug: Log the data we received from the server
console.log('üìä Debug Info:');
console.log('- Active Streams:', activeStreams);
console.log('- Attendee Data:', attendeeDataByStream);
console.log('- Stream Count:', activeStreams.length);
console.log('- Attendee Count:', Object.keys(attendeeDataByStream).length);

let chimeSDKLoaded = false;
let ChimeSDK = null;

// BroadcastChannel listener for screen share messages
window.screenShareChannel.addEventListener('message', function(event) {
    const data = event.data;
    console.log('üì° Received screen share message:', data.type);
    
    switch(data.type) {
        case 'SCREEN_SHARE_START':
            handleScreenShareStart(data);
            break;
        case 'SCREEN_SHARE_FRAME':
            handleScreenShareFrame(data);
            break;
        case 'SCREEN_SHARE_STOP':
            handleScreenShareStop();
            break;
        case 'REQUEST_SCREEN_SHARE_STATUS':
            handleScreenShareStatusRequest();
            break;
    }
});

// CRITICAL: Also listen for localStorage changes as fallback
window.addEventListener('storage', function(e) {
    if (e.key === 'adminScreenShare') {
        console.log('üì° Admin screen share status changed via localStorage');
        const screenShareData = e.newValue ? JSON.parse(e.newValue) : null;
        
        if (screenShareData && screenShareData.active) {
            console.log('üñ•Ô∏è Admin started screen sharing:', screenShareData.name);
            // Update all joined streams to show screen share
            joinedStreams.forEach((streamSession, streamId) => {
                displayRealScreenShareForViewer(streamId, screenShareData.name || 'Admin Screen Share');
                window.activeScreenShareStreams.add(streamId);
            });
            showToast('Admin started screen sharing: ' + (screenShareData.name || 'Screen Share'), 'info');
        } else {
            console.log('üõë Admin stopped screen sharing');
            // Restore demo content for all joined streams
            window.activeScreenShareStreams.forEach(streamId => {
                const stream = activeStreams.find(s => s.id === streamId);
                if (stream) {
                    displayDemoContentForViewer(streamId, stream);
                }
            });
            window.activeScreenShareStreams.clear();
            showToast('Screen sharing ended - demo content restored', 'info');
        }
    }
});

// Screen share event handlers
function handleScreenShareStart(data) {
    console.log('üñ•Ô∏è Admin started screen sharing:', data.name);
    showToast('Admin started screen sharing: ' + data.name, 'info');
    
    // Update all joined streams to show screen share
    joinedStreams.forEach((streamSession, streamId) => {
        displayRealScreenShareForViewer(streamId, data.name, data.width, data.height);
        window.activeScreenShareStreams.add(streamId);
    });
}

function handleScreenShareFrame(data) {
    // Update all active screen share displays
    window.activeScreenShareStreams.forEach(streamId => {
        updateScreenShareFrame(streamId, data.imageData);
    });
}

function handleScreenShareStop() {
    console.log('üõë Admin stopped screen sharing');
    showToast('Screen sharing ended - demo content restored', 'info');
    
    // Restore demo content for all streams
    window.activeScreenShareStreams.forEach(streamId => {
        const stream = activeStreams.find(s => s.id === streamId);
        if (stream) {
            displayDemoContentForViewer(streamId, stream);
        }
    });
    
    window.activeScreenShareStreams.clear();
}

function handleScreenShareStatusRequest() {
    // Admin responds with current status
    if (isAdmin && window.userStreamStates && window.userStreamStates.screenSharing) {
        window.screenShareChannel.postMessage({
            type: 'SCREEN_SHARE_START',
            name: window.currentScreenShareName || 'Admin Screen Share',
            width: window.screenShareCanvas ? window.screenShareCanvas.width : 1280,
            height: window.screenShareCanvas ? window.screenShareCanvas.height : 720
        });
    }
}

// Function to display real screen share content for viewers with FPS counter
function displayRealScreenShareForViewer(streamId, screenName, width = 1280, height = 720) {
    const videoGrid = document.getElementById('videoGrid-' + streamId);
    if (!videoGrid) return;
    
    console.log('üñºÔ∏è Setting up LOW LATENCY screen share display for viewer:', streamId);
    
    // Clear existing content
    videoGrid.innerHTML = '';
    
    // Create container for screen share
    const screenShareContainer = document.createElement('div');
    screenShareContainer.style.width = '100%';
    screenShareContainer.style.height = '100%';
    screenShareContainer.style.position = 'relative';
    screenShareContainer.style.background = '#000';
    screenShareContainer.style.display = 'flex';
    screenShareContainer.style.alignItems = 'center';
    screenShareContainer.style.justifyContent = 'center';
    
    // Create canvas to display screen share frames
    const canvas = document.createElement('canvas');
    canvas.id = 'screenShareCanvas-' + streamId;
    canvas.width = width;
    canvas.height = height;
    canvas.style.maxWidth = '100%';
    canvas.style.maxHeight = '100%';
    canvas.style.objectFit = 'contain';
    canvas.style.background = '#1a1a1a';
    
    screenShareContainer.appendChild(canvas);
    videoGrid.appendChild(screenShareContainer);
    
    // Add screen share indicator
    const indicator = document.createElement('div');
    indicator.className = 'position-absolute top-0 start-0 m-2 badge bg-success';
    indicator.style.zIndex = '1000';
    indicator.style.fontSize = '12px';
    indicator.innerHTML = '<span class="material-symbols-outlined me-1" style="font-size: 12px;">screen_share</span>' + screenName;
    screenShareContainer.appendChild(indicator);
    
    // Add FPS indicator for low latency monitoring
    const fpsIndicator = document.createElement('div');
    fpsIndicator.className = 'fps-indicator';
    fpsIndicator.id = 'fps-' + streamId;
    fpsIndicator.textContent = 'FPS: --';
    screenShareContainer.appendChild(fpsIndicator);
    
    // Add loading message initially
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'loading-indicator position-absolute';
    loadingDiv.style.top = '50%';
    loadingDiv.style.left = '50%';
    loadingDiv.style.transform = 'translate(-50%, -50%)';
    loadingDiv.style.textAlign = 'center';
    loadingDiv.style.color = 'white';
    loadingDiv.style.zIndex = '999';
    loadingDiv.innerHTML = `
        <div class="mb-3">
            <span class="material-symbols-outlined" style="font-size: 3rem; color: #10B981;">screen_share</span>
        </div>
        <h5 style="color: #10B981; margin-bottom: 1rem;">‚ö° LOW LATENCY Loading</h5>
        <p style="color: #ccc;">${screenName}</p>
        <div class="mt-2">
            <div class="spinner-border" style="color: #10B981;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;
    screenShareContainer.appendChild(loadingDiv);
    
    // Initialize FPS counter
    initializeFPSCounter(streamId);
    
    console.log('‚úÖ LOW LATENCY screen share viewer setup complete for stream:', streamId);
}

// FPS Counter for monitoring performance
let fpsCounters = new Map();

function initializeFPSCounter(streamId) {
    fpsCounters.set(streamId, {
        frames: 0,
        lastTime: Date.now(),
        fps: 0
    });
    
    // Update FPS display every second
    setInterval(() => {
        updateFPSDisplay(streamId);
    }, 1000);
}

function updateFPSDisplay(streamId) {
    const counter = fpsCounters.get(streamId);
    const fpsElement = document.getElementById('fps-' + streamId);
    
    if (counter && fpsElement) {
        const now = Date.now();
        const deltaTime = (now - counter.lastTime) / 1000;
        
        if (deltaTime >= 1) {
            counter.fps = Math.round(counter.frames / deltaTime);
            counter.frames = 0;
            counter.lastTime = now;
            
            // Color-code FPS for performance indication
            const fpsColor = counter.fps >= 10 ? '#10B981' : counter.fps >= 5 ? '#fbbf24' : '#ef4444';
            fpsElement.style.color = fpsColor;
            fpsElement.textContent = `FPS: ${counter.fps}`;
        }
    }
}

// Track frame updates for FPS counter
function trackFrameUpdate(streamId) {
    const counter = fpsCounters.get(streamId);
    if (counter) {
        counter.frames++;
    }
}

// LOW LATENCY: Optimized frame update function
let frameUpdateQueue = new Map(); // streamId -> latest frame data

function updateScreenShareFrame(streamId, imageData) {
    // Queue the latest frame to avoid blocking
    frameUpdateQueue.set(streamId, imageData);
    
    // Process frame update immediately
    requestAnimationFrame(() => processFrameUpdate(streamId));
}

function processFrameUpdate(streamId) {
    const imageData = frameUpdateQueue.get(streamId);
    if (!imageData) return;
    
    const canvas = document.getElementById('screenShareCanvas-' + streamId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    // Create image with optimized loading
    const img = new Image();
    
    img.onload = function() {
        try {
            // Clear canvas efficiently
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // High-quality rendering for low latency
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            
            // Draw the frame
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            
            // Track frame for FPS counter
            trackFrameUpdate(streamId);
            
            // Remove loading indicator if it exists (only once)
            const container = canvas.parentElement;
            const loadingDiv = container.querySelector('.loading-indicator');
            if (loadingDiv) {
                loadingDiv.remove();
                console.log('‚ö° LOW LATENCY: First frame loaded for stream', streamId);
            }
            
        } catch (error) {
            console.error('‚ùå Error rendering frame:', error);
        }
    };
    
    img.onerror = function() {
        console.warn('‚ö†Ô∏è Frame load failed for stream', streamId);
        // Don't show error on mobile to avoid spam
        if (!isMobileDevice()) {
            console.error('Failed to load screen share frame');
        }
    };
    
    // Load image with cross-origin support
    img.crossOrigin = 'anonymous';
    img.src = imageData;
    
    // Clear the queue for this stream
    frameUpdateQueue.delete(streamId);
}

// CRITICAL: Define functions at the global scope first
window.joinStream = function(streamId) {
    console.log((isAdmin ? 'Admin' : 'Viewer') + ' joining stream ' + streamId + '...');
    
    const stream = activeStreams.find(s => s.id === streamId);
    if (!stream || joinedStreams.has(streamId)) {
        console.log('‚ùå Stream not found or already joined');
        return;
    }
    
    const attendeeData = attendeeDataByStream[streamId];
    if (!attendeeData) {
        showToast('Unable to join stream - no attendee data', 'error');
        return;
    }
    
    // For now, just force join since AWS SDK isn't loading
    console.log('üîÑ AWS SDK not available, using demo mode');
    forceJoinStream(streamId);
};

// LOW LATENCY: Force refresh screen share button for immediate updates
function addMobileRefreshButton(streamId) {
    if (!isMobileDevice()) return;
    
    const videoContainer = document.getElementById('videoContainer-' + streamId);
    if (!videoContainer) return;
    
    // Check if button already exists
    if (videoContainer.querySelector('.mobile-refresh-btn')) return;
    
    const refreshBtn = document.createElement('button');
    refreshBtn.className = 'btn btn-outline-info btn-sm position-absolute mobile-refresh-btn';
    refreshBtn.style.top = '50px';
    refreshBtn.style.right = '10px';
    refreshBtn.style.zIndex = '1001';
    refreshBtn.title = 'Refresh screen share (Mobile)';
    refreshBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 16px;">refresh</span>';
    
    refreshBtn.onclick = function() {
        console.log('‚ö° LOW LATENCY: Mobile manual refresh');
        showToast('Refreshing screen share...', 'info');
        
        // IMMEDIATE checks for low latency
        checkLocalStorageForScreenShare();
        
        // Request fresh status from admin
        if (window.screenShareChannel) {
            window.screenShareChannel.postMessage({
                type: 'REQUEST_SCREEN_SHARE_STATUS'
            });
        }
        
        // Force frame update if screen share is active
        const frameData = localStorage.getItem('adminScreenShareFrame');
        if (frameData && window.activeScreenShareStreams.has(streamId)) {
            try {
                const frame = JSON.parse(frameData);
                if (frame.imageData) {
                    updateScreenShareFrame(streamId, frame.imageData);
                }
            } catch (error) {
                console.error('Error forcing frame update:', error);
            }
        }
        
        // Visual feedback
        refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        setTimeout(() => {
            refreshBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 16px;">refresh</span>';
            showToast('Refresh complete', 'success');
        }, 1000);
    };
    
    videoContainer.appendChild(refreshBtn);
}

// UPDATED: Force join function with low latency enhancements
window.forceJoinStream = function(streamId) {
    console.log('‚ö° LOW LATENCY: Force joining stream', streamId);
    
    const stream = activeStreams.find(s => s.id === streamId);
    if (!stream) {
        console.error('Stream not found:', streamId);
        return;
    }
    
    // Immediate UI updates
    const spinner = document.getElementById('loadingSpinner-' + streamId);
    const videoGrid = document.getElementById('videoGrid-' + streamId);
    const streamControls = document.getElementById('streamControls-' + streamId);
    
    if (spinner) spinner.style.display = 'none';
    if (videoGrid) videoGrid.style.display = 'block';
    if (streamControls) streamControls.style.display = 'block';
    
    // Add mobile refresh button immediately
    if (isMobileDevice()) {
        addMobileRefreshButton(streamId);
    }
    
    // IMMEDIATE screen share status check
    if (window.screenShareChannel) {
        window.screenShareChannel.postMessage({
            type: 'REQUEST_SCREEN_SHARE_STATUS'
        });
    }
    
    // IMMEDIATE localStorage check
    setTimeout(checkLocalStorageForScreenShare, 50);
    
    // Show demo content initially
    displayDemoContentForViewer(streamId, stream);
    
    // Add to joined streams
    joinedStreams.set(streamId, { connected: true });
    
    // Shorter timeout for low latency detection
    setTimeout(() => {
        if (!window.activeScreenShareStreams.has(streamId)) {
            console.log('üé≠ No active screen share detected (low latency check)');
        }
    }, 1000); // Reduced from 3000ms to 1000ms
    
    showToast('Connected to ' + stream.streamer_name + ' stream', 'success');
    
    // Update state
    const state = streamStates.get(streamId) || {};
    state.joined = true;
    streamStates.set(streamId, state);
};

// Function to display demo content for viewers
function displayDemoContentForViewer(streamId, stream) {
    const videoGrid = document.getElementById('videoGrid-' + streamId);
    if (!videoGrid) return;
    
    // Clear existing content
    videoGrid.innerHTML = '';
    
    // Create demo video element
    const videoElement = document.createElement('video');
    videoElement.id = 'video-' + streamId + '-1';
    videoElement.style.width = '100%';
    videoElement.style.height = '100%';
    videoElement.style.objectFit = 'cover';
    videoElement.autoplay = true;
    videoElement.muted = true;
    videoElement.playsInline = true;
    
    // Create demo video stream
    const canvas = document.createElement('canvas');
    canvas.width = 1280;
    canvas.height = 720;
    const ctx = canvas.getContext('2d');
    
    let frame = 0;
    const animate = () => {
        // Demo trading content
        ctx.fillStyle = '#0a0a0a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = '#10B981';
        ctx.font = 'bold 32px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(stream.streamer_name + ' Live Stream (Demo)', 640, 100);
        
        // Animated chart line
        ctx.strokeStyle = '#10B981';
        ctx.lineWidth = 3;
        ctx.beginPath();
        for (let i = 100; i < 1180; i += 5) {
            const y = 360 + Math.sin((i + frame * 2) * 0.01) * 100;
            if (i === 100) ctx.moveTo(i, y);
            else ctx.lineTo(i, y);
        }
        ctx.stroke();
        
        // Live indicator
        ctx.fillStyle = '#ff0000';
        ctx.beginPath();
        ctx.arc(100, 50, 8, 0, 2 * Math.PI);
        ctx.fill();
        
        ctx.fillStyle = '#ffffff';
        ctx.font = '16px Arial';
        ctx.textAlign = 'left';
        ctx.fillText('‚óè LIVE DEMO', 120, 55);
        
        frame++;
        requestAnimationFrame(animate);
    };
    animate();
    
    const demoStream = canvas.captureStream(30);
    videoElement.srcObject = demoStream;
    videoElement.play();
    
    videoGrid.appendChild(videoElement);
    
    console.log('‚úÖ Demo content displayed for viewer:', streamId);
}

// Other global functions
window.toggleFullscreen = function(streamId) {
    console.log('üñºÔ∏è Toggling fullscreen for stream ' + streamId);
    
    const videoContainer = document.getElementById('videoContainer-' + streamId);
    if (!videoContainer) return;
    
    if (document.fullscreenElement) {
        document.exitFullscreen().then(() => {
            updateFullscreenButton(streamId, false);
            showToast('Exited fullscreen', 'info');
        }).catch(err => {
            console.error('Error exiting fullscreen:', err);
        });
    } else {
        videoContainer.requestFullscreen().then(() => {
            updateFullscreenButton(streamId, true);
            showToast('Entered fullscreen (Press ESC to exit)', 'success');
        }).catch(err => {
            console.error('Error entering fullscreen:', err);
            showToast('Fullscreen not supported', 'warning');
        });
    }
};

window.leaveStream = function(streamId) {
    console.log('üëã ' + (isAdmin ? 'Admin' : 'Viewer') + ' leaving stream ' + streamId + '...');
    
    // Stop screen share if admin and active
    if (isAdmin && currentScreenShareStreamId === streamId) {
        stopScreenShare();
    }
    
    // Remove from active screen share streams
    window.activeScreenShareStreams.delete(streamId);
    
    const streamSession = joinedStreams.get(streamId);
    if (streamSession && streamSession.audioVideo) {
        streamSession.audioVideo.stop();
    }
    joinedStreams.delete(streamId);
    
    // Reset UI
    const spinner = document.getElementById('loadingSpinner-' + streamId);
    const videoGrid = document.getElementById('videoGrid-' + streamId);
    const streamControls = document.getElementById('streamControls-' + streamId);
    
    if (spinner) {
        spinner.style.display = 'flex';
        spinner.innerHTML = 
            '<div class="text-center text-white">' +
                '<span class="material-symbols-outlined mb-3" style="font-size: 3rem;">live_tv</span>' +
                '<p>Left stream</p>' +
                '<button class="btn btn-primary btn-sm" onclick="joinStream(' + streamId + ')">Rejoin Stream</button>' +
            '</div>';
    }
    if (videoGrid) videoGrid.style.display = 'none';
    if (streamControls) streamControls.style.display = 'none';
    
    const state = streamStates.get(streamId);
    if (state) {
        state.joined = false;
        state.screenSharing = false;
        streamStates.set(streamId, state);
    }
    
    showToast((isAdmin ? 'Admin' : 'Viewer') + ' left stream', 'info');
};

window.shareStream = function(streamId) {
    const streamUrl = window.location.origin + '/livestream';
    const stream = activeStreams.find(s => s.id === streamId);
    
    if (navigator.share) {
        navigator.share({
            title: stream.streamer_name + ' Live Stream - TGFX Trade Lab',
            text: 'Join ' + stream.streamer_name + ' live trading session!',
            url: streamUrl
        });
    } else {
        navigator.clipboard.writeText(streamUrl).then(function() {
            showToast('Stream link copied to clipboard', 'success');
        });
    }
};

// Admin-only functions
window.toggleMute = function(streamId) {
    if (!isAdmin) {
        showToast('Only admins can control microphone', 'info');
        return;
    }
    
    const streamSession = joinedStreams.get(streamId);
    if (!streamSession) return;
    
    const state = streamStates.get(streamId) || {};
    
    if (state.muted) {
        document.getElementById('muteIcon-' + streamId).textContent = 'mic';
        document.getElementById('muteBtn-' + streamId).classList.add('btn-outline-success');
        state.muted = false;
        showToast('Admin microphone enabled', 'success');
    } else {
        document.getElementById('muteIcon-' + streamId).textContent = 'mic_off';
        document.getElementById('muteBtn-' + streamId).classList.remove('btn-outline-success');
        state.muted = true;
        showToast('Admin microphone muted', 'info');
    }
    
    streamStates.set(streamId, state);
};

window.toggleVideo = function(streamId) {
    if (!isAdmin) {
        showToast('Only admins can control camera', 'info');
        return;
    }
    
    const streamSession = joinedStreams.get(streamId);
    if (!streamSession) return;
    
    const state = streamStates.get(streamId) || {};
    
    if (state.videoEnabled) {
        document.getElementById('videoIcon-' + streamId).textContent = 'videocam_off';
        document.getElementById('videoBtn-' + streamId).classList.remove('btn-outline-success');
        state.videoEnabled = false;
        showToast('Admin camera disabled', 'info');
    } else {
        document.getElementById('videoIcon-' + streamId).textContent = 'videocam';
        document.getElementById('videoBtn-' + streamId).classList.add('btn-outline-success');
        state.videoEnabled = true;
        showToast('Admin camera enabled', 'success');
    }
    
    streamStates.set(streamId, state);
};

window.toggleScreenShare = function(streamId) {
    if (!isAdmin) {
        showToast('Only admins can screen share', 'warning');
        return;
    }
    
    console.log('üñ•Ô∏è Admin toggling screen share for stream ' + streamId);
    
    const streamSession = joinedStreams.get(streamId);
    if (!streamSession) {
        showToast('Join the stream first to share your screen', 'warning');
        return;
    }
    
    const state = streamStates.get(streamId) || {};
    
    if (state.screenSharing) {
        stopScreenShare();
    } else {
        startScreenShare(streamId);
    }
};

window.debugStreamConnection = function(streamId) {
    const stream = activeStreams.find(s => s.id === streamId);
    const attendeeData = attendeeDataByStream[streamId];
    
    console.log('=== üîç DEBUG STREAM CONNECTION ===');
    console.log('Stream ID:', streamId);
    console.log('Stream data:', stream);
    console.log('Attendee data:', attendeeData);
    console.log('Joined streams:', Array.from(joinedStreams.keys()));
    console.log('Stream states:', Array.from(streamStates.entries()));
    console.log('Active screen share streams:', Array.from(window.activeScreenShareStreams));
    console.log('BroadcastChannel available:', !!window.screenShareChannel);
    
    showToast('Debug info logged to console (F12)', 'info');
};

// Helper functions
function updateFullscreenButton(streamId, isFullscreen) {
    const icon = document.getElementById('fullscreenIcon-' + streamId);
    if (icon) {
        icon.textContent = isFullscreen ? 'fullscreen_exit' : 'fullscreen';
    }
}

function startScreenShare(streamId) {
    if (!isAdmin) return;
    
    // Mock screen share implementation
    console.log('üñ•Ô∏è Starting screen share for stream:', streamId);
    
    // Update UI state
    const screenShareBtn = document.getElementById('screenShareBtn-' + streamId);
    const screenShareIcon = document.getElementById('screenShareIcon-' + streamId);
    
    if (screenShareBtn) {
        screenShareBtn.classList.add('btn-outline-success');
    }
    if (screenShareIcon) {
        screenShareIcon.textContent = 'stop_screen_share';
    }
    
    // Update global state
    if (window.userStreamStates) {
        window.userStreamStates.screenSharing = true;
    }
    
    window.currentScreenShareName = 'Admin Screen Share';
    currentScreenShareStreamId = streamId;
    
    // Notify all viewers via BroadcastChannel
    window.screenShareChannel.postMessage({
        type: 'SCREEN_SHARE_START',
        name: window.currentScreenShareName,
        width: 1280,
        height: 720
    });
    
    showToast('Screen sharing started', 'success');
    
    const state = streamStates.get(streamId) || {};
    state.screenSharing = true;
    streamStates.set(streamId, state);
}

function stopScreenShare() {
    if (!isAdmin) return;
    
    console.log('üõë Stopping screen share');
    
    // Update UI state for all streams
    activeStreams.forEach(stream => {
        const screenShareBtn = document.getElementById('screenShareBtn-' + stream.id);
        const screenShareIcon = document.getElementById('screenShareIcon-' + stream.id);
        
        if (screenShareBtn) {
            screenShareBtn.classList.remove('btn-outline-success');
        }
        if (screenShareIcon) {
            screenShareIcon.textContent = 'screen_share';
        }
        
        const state = streamStates.get(stream.id) || {};
        state.screenSharing = false;
        streamStates.set(stream.id, state);
    });
    
    // Update global state
    if (window.userStreamStates) {
        window.userStreamStates.screenSharing = false;
    }
    
    currentScreenShareStreamId = null;
    window.currentScreenShareName = null;
    
    // Notify all viewers via BroadcastChannel
    window.screenShareChannel.postMessage({
        type: 'SCREEN_SHARE_STOP'
    });
    
    showToast('Screen sharing stopped', 'info');
}

async function updateAllStreamStatus() {
    try {
        const response = await fetch('/api/stream/status');
        const data = await response.json();
        
        if (data.active && data.streams) {
            // Update viewer counts
            data.streams.forEach(streamData => {
                const viewerElement = document.querySelector('.stream-viewer-count[data-stream-id="' + streamData.id + '"]');
                if (viewerElement) {
                    const count = streamData.viewer_count || 0;
                    viewerElement.textContent = count === 1 ? '1 viewer' : count + ' viewers';
                }
            });
            
            // Update overall statistics
            const totalViewers = data.streams.reduce((sum, stream) => sum + (stream.viewer_count || 0), 0);
            
            const statusBadgeEl = document.getElementById('statusBadge');
            const totalViewersEl = document.getElementById('totalViewers');
            
            if (statusBadgeEl) {
                statusBadgeEl.className = 'badge bg-success';
                statusBadgeEl.innerHTML = '<span class="material-symbols-outlined me-1" style="font-size: 12px;">radio_button_checked</span>' + data.count + ' Live';
            }
            if (totalViewersEl) {
                totalViewersEl.textContent = totalViewers + ' total viewers';
            }
        }
    } catch (error) {
        console.error('Error updating stream status:', error);
    }
}

function showToast(message, type) {
    const toast = document.createElement('div');
    const alertType = type === 'error' ? 'danger' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
    const iconType = type === 'error' ? 'error' : type === 'success' ? 'check_circle' : type === 'warning' ? 'warning' : 'info';
    
    toast.className = 'alert alert-' + alertType + ' position-fixed';
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.style.minWidth = '300px';
    toast.innerHTML = 
        '<div class="d-flex align-items-center">' +
            '<span class="material-symbols-outlined me-2">' + iconType + '</span>' +
            '<span>' + message + '</span>' +
        '</div>';
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 4000);
}

// MOBILE DETECTION
function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
           window.innerWidth <= 768;
}

// ENHANCED: Mobile-friendly BroadcastChannel setup for LOW LATENCY
function setupMobileBroadcastChannel() {
    console.log('üì° Setting up LOW LATENCY BroadcastChannel');
    
    // Enhanced BroadcastChannel with mobile fallbacks
    try {
        window.screenShareChannel = new BroadcastChannel('screen-share-channel');
        console.log('‚úÖ BroadcastChannel created successfully');
        
        // LOW LATENCY event listener - no delays
        window.screenShareChannel.addEventListener('message', function(event) {
            const data = event.data;
            console.log('‚ö° LOW LATENCY: Received message:', data.type);
            
            // Process immediately for low latency
            switch(data.type) {
                case 'SCREEN_SHARE_START':
                    handleScreenShareStart(data);
                    break;
                case 'SCREEN_SHARE_FRAME':
                    handleScreenShareFrame(data);
                    break;
                case 'SCREEN_SHARE_STOP':
                    handleScreenShareStop();
                    break;
                case 'REQUEST_SCREEN_SHARE_STATUS':
                    handleScreenShareStatusRequest();
                    break;
            }
        });
        
    } catch (error) {
        console.error('‚ùå BroadcastChannel failed, using localStorage only:', error);
        window.screenShareChannel = null;
    }
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('üì± DOM loaded for ' + (isAdmin ? 'admin' : 'viewer') + ' user...');
    console.log('üì± Mobile device detected:', isMobileDevice());
    
    // Initialize mobile-friendly BroadcastChannel
    setupMobileBroadcastChannel();
    
    // Initialize stream states
    activeStreams.forEach(stream => {
        streamStates.set(stream.id, {
            muted: true,
            videoEnabled: false,
            screenSharing: false,
            joined: false
        });
        
        // Update spinners with connection options
        const spinner = document.getElementById('loadingSpinner-' + stream.id);
        if (spinner) {
            const streamColor = (stream.creator && stream.creator.stream_color) ? stream.creator.stream_color : '#10B981';
            setTimeout(() => {
                if (!joinedStreams.has(stream.id)) {
                    spinner.innerHTML = 
                        '<div class="text-center text-white">' +
                            '<span class="material-symbols-outlined mb-3" style="color: ' + streamColor + '; font-size: 3rem;">live_tv</span>' +
                            '<p>' + stream.streamer_name + ' is Live!</p>' +
                            '<button class="btn btn-success btn-sm me-2" onclick="forceJoinStream(' + stream.id + ')">' +
                                '<span class="material-symbols-outlined me-1" style="font-size: 16px;">play_arrow</span>' +
                                'Join Stream' +
                            '</button>' +
                        '</div>';
                }
            }, 2000);
        }
    });
    
    // LOW LATENCY: High frequency polling for real-time updates
    if (isMobileDevice()) {
        console.log('üì± Setting up LOW LATENCY mobile polling');
        setInterval(updateAllStreamStatus, 2000); // 2 seconds on mobile
        setInterval(checkLocalStorageForScreenShare, 250); // Check every 250ms on mobile!
    } else {
        console.log('üíª Setting up LOW LATENCY desktop polling');
        setInterval(updateAllStreamStatus, 1000); // 1 second on desktop
        setInterval(checkLocalStorageForScreenShare, 100); // Check every 100ms on desktop!
    }
    
    updateAllStreamStatus();
    
    console.log('‚úÖ LOW LATENCY livestream page initialized');
});

// LOW LATENCY: Enhanced localStorage checker
let lastFrameTimestamp = 0;
let lastStatusTimestamp = 0;

function checkLocalStorageForScreenShare() {
    try {
        // Check for screen share status changes
        const screenShareData = localStorage.getItem('adminScreenShare');
        if (screenShareData) {
            const data = JSON.parse(screenShareData);
            const isRecent = Date.now() - data.timestamp < 2000; // 2 second window
            
            // Only process if timestamp is newer than last check
            if (data.timestamp > lastStatusTimestamp) {
                lastStatusTimestamp = data.timestamp;
                
                if (data.active && isRecent) {
                    // Check if we're not already showing screen share
                    const hasActiveScreenShare = window.activeScreenShareStreams.size > 0;
                    
                    if (!hasActiveScreenShare && joinedStreams.size > 0) {
                        console.log('‚ö° LOW LATENCY: Screen share start detected');
                        joinedStreams.forEach((streamSession, streamId) => {
                            displayRealScreenShareForViewer(streamId, data.name || 'Admin Screen Share');
                            window.activeScreenShareStreams.add(streamId);
                        });
                        showToast('Screen sharing started: ' + (data.name || 'Admin'), 'info');
                    }
                } else if (!data.active && window.activeScreenShareStreams.size > 0) {
                    console.log('‚ö° LOW LATENCY: Screen share stop detected');
                    window.activeScreenShareStreams.forEach(streamId => {
                        const stream = activeStreams.find(s => s.id === streamId);
                        if (stream) {
                            displayDemoContentForViewer(streamId, stream);
                        }
                    });
                    window.activeScreenShareStreams.clear();
                    showToast('Screen sharing ended', 'info');
                }
            }
        }
        
        // HIGH FREQUENCY: Check for new frames
        const frameData = localStorage.getItem('adminScreenShareFrame');
        if (frameData && window.activeScreenShareStreams.size > 0) {
            const frame = JSON.parse(frameData);
            const frameIsRecent = Date.now() - frame.timestamp < 1000; // 1 second window for frames
            
            // Only update if this is a newer frame
            if (frame.timestamp > lastFrameTimestamp && frameIsRecent && frame.imageData) {
                lastFrameTimestamp = frame.timestamp;
                
                // Update all active screen share streams with the latest frame
                window.activeScreenShareStreams.forEach(streamId => {
                    updateScreenShareFrame(streamId, frame.imageData);
                });
            }
        }
        
    } catch (error) {
        console.error('Error in localStorage check:', error);
    }
}

// Listen for fullscreen changes
document.addEventListener('fullscreenchange', function() {
    const isFullscreen = !!document.fullscreenElement;
    activeStreams.forEach(stream => {
        updateFullscreenButton(stream.id, isFullscreen);
    });
});

// Debug helpers
window.debugAllStreams = function() {
    console.log('=== üîç GLOBAL STREAM DEBUG ===');
    console.log('Is Admin:', isAdmin);
    console.log('Is Mobile:', isMobileDevice());
    console.log('Active Streams:', activeStreams);
    console.log('Attendee Data:', attendeeDataByStream);
    console.log('Joined Streams:', Array.from(joinedStreams.keys()));
    console.log('Stream States:', Array.from(streamStates.entries()));
    console.log('Active Screen Share Streams:', Array.from(window.activeScreenShareStreams));
    console.log('BroadcastChannel:', !!window.screenShareChannel);
    
    // Mobile-specific debug info
    if (isMobileDevice()) {
        console.log('=== üì± MOBILE DEBUG INFO ===');
        try {
            const screenShareData = localStorage.getItem('adminScreenShare');
            const frameData = localStorage.getItem('adminScreenShareFrame');
            console.log('localStorage screenShare:', screenShareData ? JSON.parse(screenShareData) : null);
            console.log('localStorage frameData:', frameData ? 'Present (size: ' + frameData.length + ')' : 'None');
        } catch (e) {
            console.log('localStorage error:', e);
        }
    }
    
    return {
        isAdmin,
        isMobile: isMobileDevice(),
        activeStreams,
        attendeeDataByStream,
        joinedStreams: Array.from(joinedStreams.keys()),
        streamStates: Array.from(streamStates.entries()),
        activeScreenShareStreams: Array.from(window.activeScreenShareStreams),
        broadcastChannel: !!window.screenShareChannel
    };
};

// Enhanced debugging function with LOW LATENCY info
window.debugMobile = function() {
    console.log('=== ‚ö° LOW LATENCY DEBUG ===');
    console.log('Mobile device:', isMobileDevice());
    console.log('BroadcastChannel support:', typeof BroadcastChannel !== 'undefined');
    console.log('Screen share channel:', !!window.screenShareChannel);
    console.log('Active screen share streams:', window.activeScreenShareStreams.size);
    console.log('Joined streams:', joinedStreams.size);
    console.log('Last frame timestamp:', lastFrameTimestamp);
    console.log('Last status timestamp:', lastStatusTimestamp);
    
    // Check localStorage with timing
    const startTime = Date.now();
    try {
        const screenShare = localStorage.getItem('adminScreenShare');
        const frameData = localStorage.getItem('adminScreenShareFrame');
        
        console.log('localStorage access time:', Date.now() - startTime, 'ms');
        console.log('localStorage adminScreenShare:', screenShare);
        console.log('localStorage frame data size:', frameData ? frameData.length : 0);
        
        if (screenShare) {
            const data = JSON.parse(screenShare);
            console.log('Screen share active:', data.active);
            console.log('Time since status update:', Date.now() - data.timestamp, 'ms');
        }
        
        if (frameData) {
            const frame = JSON.parse(frameData);
            console.log('Time since frame update:', Date.now() - frame.timestamp, 'ms');
        }
        
    } catch (error) {
        console.log('localStorage error:', error);
    }
    
    // Polling frequencies
    if (isMobileDevice()) {
        console.log('üì± Mobile polling: Status every 2s, Frames every 250ms');
    } else {
        console.log('üíª Desktop polling: Status every 1s, Frames every 100ms');
    }
    
    // Force immediate check
    console.log('üîÑ Running immediate checks...');
    const checkStart = Date.now();
    checkLocalStorageForScreenShare();
    console.log('Check completed in:', Date.now() - checkStart, 'ms');
    
    return {
        isMobile: isMobileDevice(),
        hasChannel: !!window.screenShareChannel,
        activeStreams: window.activeScreenShareStreams.size,
        joinedStreams: joinedStreams.size,
        lastFrame: lastFrameTimestamp,
        lastStatus: lastStatusTimestamp,
        timeSinceLastFrame: lastFrameTimestamp ? Date.now() - lastFrameTimestamp : null,
        timeSinceLastStatus: lastStatusTimestamp ? Date.now() - lastStatusTimestamp : null
    };
};

console.log('‚úÖ BroadcastChannel screen share integration loaded');
console.log('‚úÖ Enhanced livestream JavaScript loaded successfully with screen share support');
console.log('üí° Available functions: joinStream(), forceJoinStream(), toggleFullscreen(), leaveStream(), shareStream()');
</script>

<style>
.stream-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.stream-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.stream-video-container {
    min-height: 300px;
    border-radius: 12px;
    overflow: hidden;
    cursor: pointer;
}

.stream-video-container:fullscreen {
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.stream-video-container video {
    border-radius: 0;
}

.btn-outline-success {
    border-color: #10B981;
    color: #10B981;
}

.btn-outline-success:hover {
    background: #10B981;
    color: white;
}

.spinner-border {
    width: 2rem;
    height: 2rem;
}

.dropdown-menu {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
}

.dropdown-item {
    color: var(--text-color);
}

.dropdown-item:hover {
    background: var(--primary-color);
    color: white;
}

.screen-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.modal-content {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
}

.modal-header, .modal-body, .modal-footer {
    border-color: var(--border-color);
}

/* LOW LATENCY optimizations and mobile styles */
@media (max-width: 768px) {
    .stream-video-container {
        min-height: 200px;
    }
    
    .col-lg-6 {
        margin-bottom: 1rem;
    }
    
    .stream-controls .d-flex {
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    
    .stream-controls .btn {
        padding: 0.25rem 0.4rem;
    }
    
    /* Mobile refresh button with low latency styling */
    .mobile-refresh-btn {
        opacity: 0.9;
        backdrop-filter: blur(4px);
        background: rgba(16, 185, 129, 0.3) !important;
        border-color: #10B981 !important;
        color: #10B981 !important;
        transition: all 0.2s ease;
    }
    
    .mobile-refresh-btn:hover {
        opacity: 1;
        background: rgba(16, 185, 129, 0.5) !important;
        transform: scale(1.05);
    }
    
    /* Mobile canvas optimizations for low latency */
    .stream-video-container canvas {
        image-rendering: auto;
        image-rendering: -webkit-optimize-contrast;
        will-change: transform;
    }
    
    /* Mobile audio controls */
    .audio-indicator {
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    
    .audio-visualizer {
        width: 30px;
        height: 16px;
    }
}

/* LOW LATENCY performance optimizations */
.stream-video-container canvas {
    /* Hardware acceleration for better performance */
    transform: translateZ(0);
    backface-visibility: hidden;
    perspective: 1000;
}

/* Frame rate indicator */
.fps-indicator {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: #10B981;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-family: monospace;
    z-index: 1000;
    backdrop-filter: blur(4px);
}

/* Audio visualization */
.audio-indicator {
    background: rgba(0, 0, 0, 0.6);
    padding: 4px 8px;
    border-radius: 6px;
    backdrop-filter: blur(4px);
}

.audio-visualizer {
    display: flex;
    align-items: end;
    gap: 2px;
    width: 40px;
    height: 20px;
}

.audio-bar {
    width: 3px;
    min-height: 4px;
    background-color: #374151;
    border-radius: 1px;
    transition: height 0.1s ease, background-color 0.1s ease;
}

.audio-bar:nth-child(1) { height: 20%; }
.audio-bar:nth-child(2) { height: 40%; }
.audio-bar:nth-child(3) { height: 60%; }
.audio-bar:nth-child(4) { height: 80%; }
.audio-bar:nth-child(5) { height: 100%; }

/* Audio controls */
.audio-indicator .btn {
    padding: 0.2rem 0.4rem;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.audio-indicator .btn:hover {
    background: rgba(16, 185, 129, 0.2);
    border-color: #10B981;
}

/* Audio active state */
.audio-indicator.active {
    border: 1px solid #10B981;
    background: rgba(16, 185, 129, 0.1);
}

/* Low latency loading indicators */
.loading-indicator {
    background: rgba(0, 0, 0, 0.9);
    border-radius: 8px;
    padding: 2rem;
    backdrop-filter: blur(10px);
}

/* Real-time status indicators */
.stream-status-live {
    animation: pulse-green 1s infinite;
}

@keyframes pulse-green {
    0% { opacity: 1; }
    50% { opacity: 0.7; }
    100% { opacity: 1; }
}

/* High refresh rate optimizations */
.stream-card[data-low-latency="true"] {
    border-color: #10B981 !important;
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
}

.stream-card[data-low-latency="true"] .stream-controls {
    background: linear-gradient(transparent, rgba(16, 185, 129, 0.1));
}

/* Audio muted state */
.audio-indicator.muted .audio-bar {
    background-color: #ef4444 !important;
    opacity: 0.5;
}

/* Microphone indicator */
.mic-indicator {
    color: #10B981;
    animation: pulse 2s infinite;
}

.mic-indicator.muted {
    color: #6b7280;
    animation: none;
}

/* Audio level animation */
@keyframes audioLevel {
    0% { height: 20%; }
    50% { height: 100%; }
    100% { height: 20%; }
}

.audio-bar.active {
    animation: audioLevel 0.5s ease-in-out;
}

/* Volume control hints */
.audio-indicator:hover::after {
    content: "Click to mute/unmute";
    position: absolute;
    top: -30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    white-space: nowrap;
    z-index: 1001;
}

/* Audio enable prompt */
#audioEnablePrompt {
    transition: all 0.3s ease;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.7);
    animation: audioPromptFadeIn 0.3s ease;
}

@keyframes audioPromptFadeIn {
    from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
}

#audioEnablePrompt .btn {
    transition: all 0.2s ease;
}

#audioEnablePrompt .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

/* Audio status indicators */
.stream-controls.audio-enabled {
    border-bottom: 2px solid #10B981;
}

.stream-controls.audio-disabled {
    border-bottom: 2px solid #6b7280;
}

/* Mobile audio prompt adjustments */
@media (max-width: 768px) {
    #audioEnablePrompt {
        max-width: 280px;
        margin: 1rem;
    }
    
    #audioEnablePrompt h5 {
        font-size: 1.1rem;
    }
    
    #audioEnablePrompt p {
        font-size: 0.9rem;
    }
    
    .audio-indicator {
        flex-direction: column;
        gap: 4px;
    }
    
    .audio-visualizer {
        margin: 0 auto;
    }
}

/* Audio context state indicators */
.audio-context-suspended::before {
    content: "üîá";
    position: absolute;
    top: 5px;
    right: 50px;
    font-size: 14px;
    z-index: 1001;
}

.audio-context-running::before {
    content: "üîä";
    position: absolute;
    top: 5px;
    right: 50px;
    font-size: 14px;
    z-index: 1001;
    color: #10B981;
}

/* Loading and error states */
.stream-video-container .text-center {
    padding: 2rem;
}

.stream-video-container .material-symbols-outlined {
    opacity: 0.7;
}

/* Stream controls styling */
.stream-controls .btn {
    border-radius: 6px;
    padding: 0.375rem 0.5rem;
}

.stream-controls .material-symbols-outlined {
    font-size: 18px;
}

/* Video grid styling */
#videoGrid-1, #videoGrid-2 {
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Responsive video elements */
.stream-video-container video {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
}

/* SDK Loading Status */
#sdkLoadingStatus .alert {
    margin: 0;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Fullscreen styles */
.stream-video-container:fullscreen .stream-controls {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 1000;
}

.stream-video-container:fullscreen #videoGrid-1,
.stream-video-container:fullscreen #videoGrid-2 {
    width: 100vw;
    height: 100vh;
}

/* Screen share button states */
.btn-success {
    background-color: #28a745;
    border-color: #28a745;
}

.btn-success:hover {
    background-color: #218838;
    border-color: #1e7e34;
}

/* Demo mode styling */
.text-warning {
    color: #ffc107 !important;
}

.text-danger {
    color: #dc3545 !important;
}

/* Fullscreen button */
.stream-video-container .position-absolute.btn {
    opacity: 0.7;
    transition: opacity 0.3s ease;
}

.stream-video-container:hover .position-absolute.btn {
    opacity: 1;
}

/* Connection status toast */
.toast {
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
}

.toast-header {
    background-color: var(--card-bg);
    border-bottom: 1px solid var(--border-color);
}

/* Enhanced animations */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.stream-card[data-status="live"] .badge {
    animation: pulse 2s infinite;
}

/* Connection quality indicators */
.connection-indicator {
    position: absolute;
    top: 50px;
    right: 10px;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    z-index: 999;
}

.connection-good {
    background-color: rgba(16, 185, 129, 0.8);
    color: white;
}

.connection-poor {
    background-color: rgba(239, 68, 68, 0.8);
    color: white;
}

/* Viewer/Admin distinction */
.admin-controls {
    border-left: 3px solid #3B82F6;
}

.viewer-mode {
    border-left: 3px solid #10B981;
}

/* Loading shimmer effect */
@keyframes shimmer {
    0% { background-position: -468px 0; }
    100% { background-position: 468px 0; }
}

.loading-shimmer {
    background: linear-gradient(90deg, #f0f0f0 25%, transparent 37%, #f0f0f0 63%);
    background-size: 400% 100%;
    animation: shimmer 1.4s ease-in-out infinite;
}

/* Screen share specific styles */
.loading-indicator {
    background: rgba(0, 0, 0, 0.8);
    border-radius: 8px;
    padding: 2rem;
}

#screenShareCanvas-1, #screenShareCanvas-2 {
    border-radius: 4px;
}

.screen-share-active .stream-controls {
    background: linear-gradient(transparent, rgba(16, 185, 129, 0.1));
}
</style>
{% endblock %}
