<!-- templates/manage_subscription.html -->
{% extends "base.html" %}

{% block title %}Manage Subscription - TGFX Trade Lab{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="text-center">
                <h1 class="text-gradient-primary mb-3">
                    <span class="material-symbols-outlined me-2" style="font-size: 2.5rem;">manage_accounts</span>
                    Manage Your Subscription
                </h1>
                <p class="text-muted mb-0 lead">Update your plan, payment method, or billing information</p>
            </div>
        </div>
    </div>

    <!-- Current Subscription Status -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="text-gradient-primary mb-0">
                        <span class="material-symbols-outlined me-2">account_circle</span>
                        Current Subscription Status
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-3">
                                {% if current_user.subscription_plan == 'monthly' %}
                                <div class="status-indicator bg-gradient-primary me-3"></div>
                                <div>
                                    <h5 class="mb-1">Monthly Plan - $80/month</h5>
                                    <p class="text-muted mb-0">Billed monthly ‚Ä¢ Full access to premium content</p>
                                </div>
                                {% elif current_user.subscription_plan == 'annual' %}
                                <div class="status-indicator bg-gradient-annual me-3"></div>
                                <div>
                                    <h5 class="mb-1">Annual Plan - $777/year</h5>
                                    <p class="text-muted mb-0">Billed annually ‚Ä¢ Save $183 vs monthly ‚Ä¢ Best value</p>
                                </div>
                                {% elif current_user.subscription_plan == 'lifetime' %}
                                <div class="status-indicator bg-gradient-gold me-3"></div>
                                <div>
                                    <h5 class="mb-1">üèÜ Lifetime Access - $1,497</h5>
                                    <p class="text-muted mb-0">One-time payment ‚Ä¢ Never pay again ‚Ä¢ All future content included</p>
                                </div>
                                {% else %}
                                <div class="status-indicator bg-secondary me-3"></div>
                                <div>
                                    <h5 class="mb-1">Free Plan</h5>
                                    <p class="text-muted mb-0">Limited access to course content</p>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Subscription Details -->
                            {% if current_user.has_subscription %}
                            <div class="subscription-details">
                                {% if current_user.subscription_plan == 'lifetime' %}
                                <p class="text-success mb-2">
                                    <span class="material-symbols-outlined me-2">check_circle</span>
                                    üéâ You have lifetime access - enjoy all current and future content forever!
                                </p>
                                {% elif current_user.subscription_cancel_at_period_end %}
                                <p class="text-warning mb-2">
                                    <span class="material-symbols-outlined me-2">warning</span>
                                    ‚ö†Ô∏è Your subscription is set to cancel on {{ current_user.subscription_expires.strftime('%B %d, %Y') if current_user.subscription_expires else 'the end of your billing period' }}. You'll retain access until then.
                                </p>
                                {% else %}
                                <p class="text-info mb-2">
                                    <span class="material-symbols-outlined me-2">schedule</span>
                                    {% if current_user.subscription_expires %}
                                    Your subscription will renew on {{ current_user.subscription_expires.strftime('%B %d, %Y') }}.
                                    {% endif %}
                                </p>
                                {% endif %}
                                
                                <!-- Payment Info -->
                                {% if current_user.last_payment_date %}
                                <p class="text-muted small mb-0">
                                    Last payment: ${{ "%.2f"|format(current_user.last_payment_amount or 0) }} on {{ current_user.last_payment_date.strftime('%B %d, %Y') }}
                                </p>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 text-md-end">
                            <div class="subscription-status-card">
                                {% if current_user.subscription_plan == 'lifetime' %}
                                <span class="badge bg-gold text-dark fs-6 px-3 py-2">
                                    <span class="material-symbols-outlined me-1" style="font-size: 1rem;">workspace_premium</span>
                                    üèÜ Lifetime Member
                                </span>
                                {% elif current_user.subscription_cancel_at_period_end %}
                                <span class="badge bg-warning text-dark fs-6 px-3 py-2">
                                    <span class="material-symbols-outlined me-1" style="font-size: 1rem;">schedule</span>
                                    Ending Soon
                                </span>
                                {% elif current_user.has_subscription %}
                                <span class="badge bg-success fs-6 px-3 py-2">
                                    <span class="material-symbols-outlined me-1" style="font-size: 1rem;">check_circle</span>
                                    Active
                                </span>
                                {% else %}
                                <span class="badge bg-secondary fs-6 px-3 py-2">
                                    <span class="material-symbols-outlined me-1" style="font-size: 1rem;">person</span>
                                    Free Plan
                                </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    {% if current_user.has_subscription and current_user.subscription_plan != 'lifetime' %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="text-gradient-primary mb-0">
                        <span class="material-symbols-outlined me-2">settings</span>
                        Subscription Actions
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        {% if current_user.subscription_cancel_at_period_end %}
                        <!-- Reactivate Button -->
                        <div class="col-md-6">
                            <div class="action-card border-success">
                                <div class="action-icon bg-success">
                                    <span class="material-symbols-outlined">restart_alt</span>
                                </div>
                                <div class="action-content">
                                    <h6 class="mb-1">Reactivate Subscription</h6>
                                    <p class="text-muted small mb-2">Continue your subscription and keep premium access</p>
                                    <button class="btn btn-success" onclick="reactivateSubscription()">
                                        <span class="material-symbols-outlined me-2">restart_alt</span>
                                        Reactivate Now
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <!-- Cancel Button -->
                        <div class="col-md-6">
                            <div class="action-card border-warning">
                                <div class="action-icon bg-warning">
                                    <span class="material-symbols-outlined">pause_circle</span>
                                </div>
                                <div class="action-content">
                                    <h6 class="mb-1">Cancel Subscription</h6>
                                    <p class="text-muted small mb-2">Cancel at end of billing period</p>
                                    <button class="btn btn-outline-warning" onclick="showCancelModal()">
                                        <span class="material-symbols-outlined me-2">pause_circle</span>
                                        Cancel Subscription
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Update Payment Method -->
                        <div class="col-md-6">
                            <div class="action-card border-primary">
                                <div class="action-icon bg-primary">
                                    <span class="material-symbols-outlined">credit_card</span>
                                </div>
                                <div class="action-content">
                                    <h6 class="mb-1">Update Payment Method</h6>
                                    <p class="text-muted small mb-2">Change your credit card or payment details</p>
                                    <button class="btn btn-outline-primary" onclick="updatePaymentMethod()">
                                        <span class="material-symbols-outlined me-2">credit_card</span>
                                        Update Payment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Plan Upgrade Options -->
    {% if not current_user.subscription_plan == 'lifetime' %}
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="text-gradient-primary mb-0">
                        <span class="material-symbols-outlined me-2">upgrade</span>
                        Upgrade Your Plan
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <!-- Monthly Plan -->
                        {% if current_user.subscription_plan != 'monthly' %}
                        <div class="col-lg-4">
                            <div class="upgrade-card {% if not current_user.has_subscription %}border-primary{% endif %}">
                                <div class="upgrade-header bg-gradient-primary">
                                    <h5 class="text-white mb-2">Monthly Plan</h5>
                                    <div class="h3 text-white mb-1">$80</div>
                                    <p class="text-white opacity-75 mb-0">per month</p>
                                </div>
                                <div class="upgrade-body">
                                    <ul class="list-unstyled">
                                        <li class="mb-2">
                                            <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                                            All premium video content
                                        </li>
                                        <li class="mb-2">
                                            <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                                            Downloadable resources
                                        </li>
                                        <li class="mb-2">
                                            <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                                            Priority support
                                        </li>
                                        <li class="mb-2">
                                            <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                                            Monthly live Q&A sessions
                                        </li>
                                    </ul>
                                </div>
                                <div class="upgrade-footer">
                                    {% if not current_user.has_subscription %}
                                    <button class="btn btn-primary w-100" onclick="startSubscription('monthly')">
                                        <span class="material-symbols-outlined me-2">credit_card</span>
                                        Start Monthly Plan
                                    </button>
                                    <p class="text-muted small text-center mt-2 mb-0">Cancel anytime</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Annual Plan -->
                        {% if current_user.subscription_plan != 'annual' %}
                        <div class="col-lg-4">
                            <div class="upgrade-card border-warning position-relative">
                                <!-- Popular Badge -->
                                <div class="popular-badge">
                                    <span class="badge bg-warning text-dark px-3 py-2">Most Popular</span>
                                </div>
                                
                                <div class="upgrade-header bg-gradient-annual">
                                    <h5 class="text-white mb-2">Annual Plan</h5>
                                    <div class="d-flex align-items-center justify-content-center mb-2">
                                        <span class="text-white-muted text-decoration-line-through me-2">$960</span>
                                        <div class="h3 text-white mb-0">$777</div>
                                    </div>
                                    <p class="text-white opacity-75 mb-1">per year</p>
                                    <span class="badge bg-success">Save $183</span>
                                </div>
                                <div class="upgrade-body">
                                    <ul class="list-unstyled">
                                        <li class="mb-2">
                                            <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                                            <strong>Everything in Monthly</strong>
                                        </li>
                                        <li class="mb-2">
                                            <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                                            2 months free (19% savings)
                                        </li>
                                        <li class="mb-2">
                                            <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                                            Trading strategy PDFs
                                        </li>
                                        <li class="mb-2">
                                            <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                                            Monthly consultation call
                                        </li>
                                    </ul>
                                </div>
                                <div class="upgrade-footer">
                                    {% if current_user.subscription_plan == 'monthly' %}
                                    <button class="btn btn-annual w-100" onclick="upgradeToAnnual()">
                                        <span class="material-symbols-outlined me-2">upgrade</span>
                                        Upgrade to Annual
                                    </button>
                                    <p class="text-muted small text-center mt-2 mb-0">Prorated billing</p>
                                    {% elif not current_user.has_subscription %}
                                    <button class="btn btn-annual w-100" onclick="startSubscription('annual')">
                                        <span class="material-symbols-outlined me-2">payments</span>
                                        Start Annual Plan
                                    </button>
                                    <p class="text-muted small text-center mt-2 mb-0">Best value ‚Ä¢ Cancel anytime</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Lifetime Plan -->
                        <div class="col-lg-4">
                            <div class="upgrade-card border-gold position-relative">
                                <!-- Ultimate Badge -->
                                <div class="popular-badge">
                                    <span class="badge bg-gold text-dark px-3 py-2">üèÜ Ultimate</span>
                                </div>
                                
                                <div class="upgrade-header bg-gradient-gold">
                                    <h5 class="text-dark mb-2">Lifetime Access</h5>
                                    <div class="d-flex align-items-center justify-content-center mb-2">
                                        <span class="text-muted text-decoration-line-through me-2">$3,997</span>
                                        <div class="h3 text-dark mb-0">$1,497</div>
                                    </div>
                                    <p class="text-dark opacity-75 mb-1">one-time payment</p>
                                    <span class="badge bg-success">Save $2,500+</span>
                                </div>
                                <div class="upgrade-body">
                                    <ul class="list-unstyled">
                                        <li class="mb-2">
                                            <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                                            <strong>Everything in Annual</strong>
                                        </li>
                                        <li class="mb-2">
                                            <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                                            <strong>Lifetime access to all content</strong>
                                        </li>
                                        <li class="mb-2">
                                            <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                                            All future courses included
                                        </li>
                                        <li class="mb-2">
                                            <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                                            VIP community access
                                        </li>
                                    </ul>
                                </div>
                                <div class="upgrade-footer">
                                    <button class="btn btn-gold w-100" onclick="upgradeToLifetime()">
                                        <span class="material-symbols-outlined me-2">workspace_premium</span>
                                        Get Lifetime Access
                                    </button>
                                    <p class="text-muted small text-center mt-2 mb-0">One-time payment ‚Ä¢ No recurring fees</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Billing History -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="text-gradient-primary mb-0">
                        <span class="material-symbols-outlined me-2">receipt</span>
                        Billing History
                    </h4>
                </div>
                <div class="card-body">
                    <div id="billingHistory">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">Loading billing history...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscription Timeline -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="text-gradient-primary mb-0">
                        <span class="material-symbols-outlined me-2">timeline</span>
                        Subscription Timeline
                    </h4>
                </div>
                <div class="card-body">
                    <div id="subscriptionTimeline">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">Loading subscription timeline...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Processing your request...</h5>
                <p class="text-muted mb-0">Please wait while we update your subscription</p>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Subscription Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span class="material-symbols-outlined me-2 text-warning">warning</span>
                    Cancel Subscription
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Are you sure you want to cancel?</strong><br>
                    {% if current_user.subscription_expires %}
                    Your subscription will remain active until <strong>{{ current_user.subscription_expires.strftime('%B %d, %Y') }}</strong>, 
                    after which you'll lose access to premium content.
                    {% else %}
                    You'll lose access to premium content at the end of your current billing period.
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <label for="cancelReason" class="form-label">Help us improve - why are you canceling? (Optional)</label>
                    <select class="form-select" id="cancelReason">
                        <option value="">Select a reason</option>
                        <option value="too_expensive">Too expensive</option>
                        <option value="not_using">Not using it enough</option>
                        <option value="found_alternative">Found a better alternative</option>
                        <option value="technical_issues">Technical issues</option>
                        <option value="content_not_helpful">Content not helpful</option>
                        <option value="temporary_break">Taking a temporary break</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="cancelFeedback" class="form-label">Additional feedback (Optional)</label>
                    <textarea class="form-control" id="cancelFeedback" rows="3" placeholder="Tell us more about your experience..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep Subscription</button>
                <button type="button" class="btn btn-warning" onclick="confirmCancellation()">
                    <span class="material-symbols-outlined me-2">cancel</span>
                    Yes, Cancel Subscription
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Status Indicator */
.status-indicator {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.status-indicator::after {
    content: '‚úì';
    color: white;
    font-size: 1.5rem;
    font-weight: bold;
}

/* Subscription Status Card */
.subscription-status-card {
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
}

/* Action Cards */
.action-card {
    background: var(--bg-tertiary);
    border: 1px solid;
    border-radius: 12px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
}

.action-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.action-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
}

.action-content {
    flex-grow: 1;
}

/* Upgrade Cards */
.upgrade-card {
    background: var(--bg-card);
    border: 1px solid;
    border-radius: 16px;
    overflow: hidden;
    transition: all 0.3s ease;
    height: 100%;
}

.upgrade-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
}

.upgrade-header {
    padding: 2rem 1.5rem;
    text-align: center;
}

.upgrade-body {
    padding: 1.5rem;
}

.upgrade-footer {
    padding: 1.5rem;
    padding-top: 0;
}

.popular-badge {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1;
}

/* Plan-specific styling */
.bg-gradient-annual {
    background: linear-gradient(135deg, #f39c12, #e67e22);
}

.bg-gradient-gold {
    background: linear-gradient(135deg, #FFD700, #FFA500);
}

.border-gold {
    border-color: #FFD700 !important;
}

.text-white-muted {
    color: rgba(255, 255, 255, 0.7) !important;
}

/* Button Styling */
.btn-annual {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    border: none;
    color: white;
    font-weight: bold;
}

.btn-annual:hover {
    background: linear-gradient(135deg, #e67e22, #f39c12);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(243, 156, 18, 0.3);
}

.btn-gold {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    border: none;
    color: #000;
    font-weight: bold;
}

.btn-gold:hover {
    background: linear-gradient(135deg, #FFA500, #FFD700);
    color: #000;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
}

.badge.bg-gold {
    background: linear-gradient(135deg, #FFD700, #FFA500) !important;
    color: #000 !important;
}

/* Timeline Styling */
.timeline-item {
    padding: 1rem;
    border-left: 3px solid var(--border-color);
    margin-left: 1rem;
    position: relative;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 1.5rem;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--primary-color);
}

.timeline-item:last-child {
    border-left-color: transparent;
}

/* Billing History */
.billing-item {
    padding: 1rem;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
}

.billing-item:hover {
    background: var(--bg-tertiary);
}

/* Modal Styling */
.modal-content {
    background-color: var(--bg-card);
    border: 1px solid var(--border-color);
}

.modal-header {
    border-bottom: 1px solid var(--border-color);
}

.modal-footer {
    border-top: 1px solid var(--border-color);
}

.form-select, .form-control {
    background-color: var(--bg-secondary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
}

.form-select:focus, .form-control:focus {
    background-color: var(--bg-secondary);
    border-color: var(--primary-color);
    color: var(--text-primary);
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.form-select option {
    background-color: var(--bg-secondary);
    color: var(--text-primary);
}

/* Loading States */
.btn-loading {
    position: relative;
    pointer-events: none;
}

.btn-loading::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 16px;
    height: 16px;
    margin: -8px 0 0 -8px;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Responsive */
@media (max-width: 768px) {
    .upgrade-card {
        margin-bottom: 1rem;
    }
    
    .action-card {
        flex-direction: column;
        text-align: center;
    }
    
    .action-icon {
        margin-bottom: 1rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadBillingHistory();
    loadSubscriptionTimeline();
});

function startSubscription(planType) {
    showLoadingModal();
    
    fetch('/api/create-checkout-session', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({ plan_type: planType })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.checkout_url) {
            window.location.href = data.checkout_url;
        } else {
            hideLoadingModal();
            alert('Error: ' + (data.error || 'Failed to create checkout session'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        hideLoadingModal();
        alert('Network error. Please try again.');
    });
}

function upgradeToAnnual() {
    if (!confirm('Upgrade to Annual Plan?\n\n‚úÖ Save $183 per year\n‚úÖ Get 2 months free\n‚úÖ Exclusive annual member content\n\nYour next billing will be prorated.')) {
        return;
    }
    
    showLoadingModal();
    
    fetch('/api/user/upgrade-to-annual', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hideLoadingModal();
            alert(data.message || 'Successfully upgraded to annual plan!');
            window.location.reload();
        } else {
            hideLoadingModal();
            alert('Error: ' + (data.error || 'Failed to upgrade subscription'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        hideLoadingModal();
        alert('Network error. Please try again.');
    });
}

function upgradeToLifetime() {
    if (!confirm('üéâ Upgrade to Lifetime Access?\n\n‚úÖ One-time payment of $1,497\n‚úÖ Never pay again\n‚úÖ All future content included\n‚úÖ VIP community access\n\n‚ö†Ô∏è This will cancel your current subscription.\n\nProceed to checkout?')) {
        return;
    }
    
    showLoadingModal();
    
    fetch('/api/user/upgrade-to-lifetime', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.checkout_url) {
            window.location.href = data.checkout_url;
        } else {
            hideLoadingModal();
            alert('Error: ' + (data.error || 'Failed to create lifetime checkout'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        hideLoadingModal();
        alert('Network error. Please try again.');
    });
}

function showCancelModal() {
    const cancelModal = new bootstrap.Modal(document.getElementById('cancelModal'));
    cancelModal.show();
}

function confirmCancellation() {
    const reason = document.getElementById('cancelReason').value;
    const feedback = document.getElementById('cancelFeedback').value;
    
    const cancelBtn = document.querySelector('#cancelModal .btn-warning');
    const originalText = cancelBtn.innerHTML;
    cancelBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Canceling...';
    cancelBtn.disabled = true;
    
    fetch('/api/user/cancel-subscription', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            reason: reason,
            feedback: feedback
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('cancelModal')).hide();
            alert(data.message || 'Subscription canceled successfully.');
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Failed to cancel subscription'));
            cancelBtn.innerHTML = originalText;
            cancelBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please try again.');
        cancelBtn.innerHTML = originalText;
        cancelBtn.disabled = false;
    });
}

function reactivateSubscription() {
    if (!confirm('Reactivate your subscription?\n\nYour subscription will continue to renew automatically.')) {
        return;
    }
    
    showLoadingModal();
    
    fetch('/api/user/reactivate-subscription', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hideLoadingModal();
            alert(data.message || 'Subscription reactivated successfully!');
            window.location.reload();
        } else {
            hideLoadingModal();
            alert('Error: ' + (data.error || 'Failed to reactivate subscription'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        hideLoadingModal();
        alert('Network error. Please try again.');
    });
}

function updatePaymentMethod() {
    showLoadingModal();
    
    fetch('/api/user/update-payment-method', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.url) {
            window.location.href = data.url;
        } else {
            hideLoadingModal();
            alert('Error: ' + (data.error || 'Failed to open payment method update'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        hideLoadingModal();
        alert('Network error. Please try again.');
    });
}

function loadBillingHistory() {
    fetch('/api/user/billing-history')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayBillingHistory(data.invoices);
        } else {
            document.getElementById('billingHistory').innerHTML = 
                '<div class="text-center text-muted py-4">No billing history available</div>';
        }
    })
    .catch(error => {
        console.error('Error loading billing history:', error);
        document.getElementById('billingHistory').innerHTML = 
            '<div class="text-center text-danger py-4">Error loading billing history</div>';
    });
}

function displayBillingHistory(invoices) {
    const container = document.getElementById('billingHistory');
    
    if (!invoices || invoices.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">No billing history available</div>';
        return;
    }
    
    let html = '';
    invoices.forEach(invoice => {
        const statusBadge = invoice.status === 'paid' ? 
            '<span class="badge bg-success">Paid</span>' :
            '<span class="badge bg-warning">Pending</span>';
            
        html += `
            <div class="billing-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${invoice.description}</h6>
                        <small class="text-muted">${invoice.date}</small>
                    </div>
                    <div class="text-end">
                        <div class="h6 mb-1">$${invoice.amount}</div>
                        ${statusBadge}
                    </div>
                </div>
                ${invoice.pdf_url ? 
                    `<div class="mt-2">
                        <a href="${invoice.pdf_url}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <span class="material-symbols-outlined me-1" style="font-size: 0.875rem;">download</span>
                            Download PDF
                        </a>
                    </div>` : ''
                }
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function loadSubscriptionTimeline() {
    fetch('/api/subscription/timeline')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displaySubscriptionTimeline(data.timeline);
        } else {
            document.getElementById('subscriptionTimeline').innerHTML = 
                '<div class="text-center text-muted py-4">No subscription timeline available</div>';
        }
    })
    .catch(error => {
        console.error('Error loading timeline:', error);
        document.getElementById('subscriptionTimeline').innerHTML = 
            '<div class="text-center text-danger py-4">Error loading subscription timeline</div>';
    });
}

function displaySubscriptionTimeline(timeline) {
    const container = document.getElementById('subscriptionTimeline');
    
    if (!timeline || timeline.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">No subscription timeline available</div>';
        return;
    }
    
    let html = '';
    timeline.forEach(event => {
        const eventDate = new Date(event.date).toLocaleDateString();
        const amountDisplay = event.amount ? `$${event.amount}` : '';
        
        html += `
            <div class="timeline-item">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${event.description}</h6>
                        <small class="text-muted">${eventDate}</small>
                    </div>
                    ${amountDisplay ? `<div class="fw-bold text-success">${amountDisplay}</div>` : ''}
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function showLoadingModal() {
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
}

function hideLoadingModal() {
    const loadingModal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
    if (loadingModal) {
        loadingModal.hide();
    }
}

function getCsrfToken() {
    const token = document.querySelector('meta[name="csrf-token"]');
    return token ? token.getAttribute('content') : '';
}
</script>
{% endblock %}
