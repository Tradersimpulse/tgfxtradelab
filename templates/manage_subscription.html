{% extends "base.html" %}

{% block title %}Premium Subscription - TGFX Trade Lab{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="text-center">
            <h1 class="text-gradient-primary mb-3">
                <span class="material-symbols-outlined me-2" style="font-size: 2.5rem;">workspace_premium</span>
                Upgrade to Premium
            </h1>
            <p class="text-muted mb-0 lead">Unlock exclusive trading content and accelerate your learning</p>
        </div>
    </div>
</div>

<!-- Current Status (if user has subscription) -->
{% if current_user.has_subscription %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-success">
            <div class="d-flex align-items-center">
                <span class="material-symbols-outlined me-3" style="font-size: 2rem;">check_circle</span>
                <div>
                    <h5 class="mb-1">You're already a Premium member!</h5>
                    <p class="mb-0">
                        Your {{ current_user.get_subscription_plan_display() }} subscription is active
                        {% if current_user.subscription_expires and current_user.subscription_plan != 'lifetime' %}
                        until {{ current_user.subscription_expires.strftime('%B %d, %Y') }}
                        {% elif current_user.subscription_plan == 'lifetime' %}
                        for life!
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Pricing Cards -->
<div class="row justify-content-center mb-5">
    <!-- Free Plan -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 {% if not current_user.has_subscription %}border-primary{% endif %}">
            <div class="card-header text-center py-4">
                <h3 class="text-white mb-2">Free</h3>
                <div class="display-4 text-gradient-primary mb-2">$0</div>
                <p class="text-muted mb-0">Forever</p>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Access to free video lessons
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Basic progress tracking
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Favorite videos feature
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Community access
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-muted">cancel</span>
                        <span class="text-muted">Premium video content</span>
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-muted">cancel</span>
                        <span class="text-muted">Downloadable resources</span>
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-muted">cancel</span>
                        <span class="text-muted">Priority support</span>
                    </li>
                </ul>
            </div>
            <div class="card-footer text-center">
                {% if not current_user.has_subscription %}
                <span class="badge bg-primary">Current Plan</span>
                {% else %}
                <button class="btn btn-outline-secondary" disabled>Your Free Plan</button>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Premium Monthly Plan -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 {% if current_user.subscription_plan == 'monthly' %}border-success{% else %}border-primary{% endif %}">
            <div class="card-header text-center py-4 bg-gradient-primary">
                <h3 class="text-white mb-2">Monthly</h3>
                <div class="display-4 text-white mb-2">$80</div>
                <p class="text-white mb-0 opacity-75">per month</p>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        <strong>Everything in Free</strong>
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Access to all premium videos
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Downloadable course materials
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Advanced progress analytics
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Priority customer support
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Monthly live Q&A sessions
                    </li>
                </ul>
            </div>
            <div class="card-footer text-center">
                {% if current_user.subscription_plan == 'monthly' %}
                <span class="badge bg-success">Current Plan</span>
                {% else %}
                <button class="btn btn-primary btn-lg w-100" onclick="startSubscription('monthly')" id="monthly-btn">
                    <span class="material-symbols-outlined me-2">credit_card</span>
                    Subscribe Monthly
                </button>
                <p class="text-muted small mt-2 mb-0">Cancel anytime</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Premium Annual Plan -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 border-warning position-relative {% if current_user.subscription_plan == 'annual' %}border-success{% endif %}">
            <!-- Popular Badge -->
            <div class="position-absolute top-0 start-50 translate-middle">
                <span class="badge bg-warning text-dark px-3 py-2">Most Popular</span>
            </div>
            
            <div class="card-header text-center py-4 bg-gradient-annual">
                <h3 class="text-white mb-2">Annual</h3>
                <div class="d-flex align-items-center justify-content-center mb-2">
                    <span class="text-white-muted text-decoration-line-through me-2">$960</span>
                    <div class="display-4 text-white">$777</div>
                </div>
                <p class="text-white mb-1">per year</p>
                <span class="badge bg-success">Save $183</span>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        <strong>Everything in Monthly</strong>
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        2 months free (19% savings)
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Exclusive annual member content
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Trading strategy PDFs
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        One-on-one monthly consultation
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Priority in live sessions
                    </li>
                </ul>
            </div>
            <div class="card-footer text-center">
                {% if current_user.subscription_plan == 'annual' %}
                <span class="badge bg-success">Current Plan</span>
                {% else %}
                <button class="btn btn-annual btn-lg w-100" onclick="startSubscription('annual')" id="annual-btn">
                    <span class="material-symbols-outlined me-2">payments</span>
                    Subscribe Annually
                </button>
                <p class="text-muted small mt-2 mb-0">Best value • Cancel anytime</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Lifetime Plan -->
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card h-100 border-gold position-relative {% if current_user.subscription_plan == 'lifetime' %}border-success{% endif %}">
            <!-- Ultimate Badge -->
            <div class="position-absolute top-0 start-50 translate-middle">
                <span class="badge bg-gold text-dark px-3 py-2">🏆 Ultimate</span>
            </div>
            
            <div class="card-header text-center py-4 bg-gradient-gold">
                <h3 class="text-dark mb-2">Lifetime</h3>
                <div class="d-flex align-items-center justify-content-center mb-2">
                    <span class="text-muted text-decoration-line-through me-2">$1497</span>
                    <div class="display-4 text-dark">$499</div>
                </div>
                <p class="text-dark mb-1">one-time payment</p>
                <span class="badge bg-success">Save $2,500+</span>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        <strong>Everything in Annual</strong>
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        <strong>Lifetime access to all content</strong>
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        All future courses included
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Exclusive lifetime member perks
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Direct access to instructors
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        VIP community access
                    </li>
                </ul>
            </div>
            <div class="card-footer text-center">
                {% if current_user.subscription_plan == 'lifetime' %}
                <span class="badge bg-success">Current Plan</span>
                <p class="text-success small mt-2 mb-0">🎉 Lifetime Access Active!</p>
                {% else %}
                <button class="btn btn-gold btn-lg w-100" onclick="startSubscription('lifetime')" id="lifetime-btn">
                    <span class="material-symbols-outlined me-2">workspace_premium</span>
                    Get Lifetime Access
                </button>
                <p class="text-muted small mt-2 mb-0">One-time payment • No recurring fees</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Features Comparison Table -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header text-center">
                <h3 class="text-gradient-primary mb-2">
                    <span class="material-symbols-outlined me-2">compare</span>
                    Feature Comparison
                </h3>
                <p class="text-muted mb-0">See what's included in each plan</p>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th class="text-center">Free</th>
                                <th class="text-center">Monthly</th>
                                <th class="text-center">Annual</th>
                                <th class="text-center">Lifetime</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Basic Video Lessons</td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                            </tr>
                            <tr>
                                <td>Premium Video Content</td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                            </tr>
                            <tr>
                                <td>Downloadable Resources</td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                            </tr>
                            <tr>
                                <td>Monthly Live Q&A</td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                            </tr>
                            <tr>
                                <td>One-on-One Consultation</td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                            </tr>
                            <tr>
                                <td>All Future Content</td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                            </tr>
                            <tr>
                                <td>VIP Community Access</td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                            </tr>
                            <tr>
                                <td>Direct Instructor Access</td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Value Proposition for Lifetime -->
{% if not current_user.subscription_plan == 'lifetime' %}
<div class="row mb-5">
    <div class="col-12">
        <div class="card bg-gradient-gold text-dark">
            <div class="card-body text-center py-5">
                <h3 class="mb-3">🚀 Why Choose Lifetime Access?</h3>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="h2">💰</div>
                        <h5>Massive Savings</h5>
                        <p>Pay once, save $2,500+ over time compared to monthly subscriptions</p>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="h2">🎓</div>
                        <h5>All Future Content</h5>
                        <p>Get every new course, update, and feature we ever release</p>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="h2">🔒</div>
                        <h5>Price Protection</h5>
                        <p>Lock in this price forever - never worry about price increases</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Redirecting to secure checkout...</h5>
                <p class="text-muted mb-0">Please wait while we prepare your subscription</p>
            </div>
        </div>
    </div>
</div>

<style>
/* Annual Plan Styling - White text */
.bg-gradient-annual {
    background: linear-gradient(135deg, #f39c12, #e67e22);
}

.text-white-muted {
    color: rgba(255, 255, 255, 0.7) !important;
}

.btn-annual {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    border: none;
    color: white;
    font-weight: bold;
}

.btn-annual:hover {
    background: linear-gradient(135deg, #e67e22, #f39c12);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(243, 156, 18, 0.3);
}

/* Gold styling for lifetime */
.border-gold {
    border-color: #FFD700 !important;
}

.bg-gradient-gold {
    background: linear-gradient(135deg, #FFD700, #FFA500);
}

.btn-gold {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    border: none;
    color: #000;
    font-weight: bold;
}

.btn-gold:hover {
    background: linear-gradient(135deg, #FFA500, #FFD700);
    color: #000;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(255, 215, 0, 0.3);
}

.badge.bg-gold {
    background: linear-gradient(135deg, #FFD700, #FFA500) !important;
    color: #000 !important;
}

/* Card animations */
.card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
}

.table th, .table td {
    vertical-align: middle;
}

/* Button loading state */
.btn-loading {
    position: relative;
    pointer-events: none;
}

.btn-loading::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 16px;
    height: 16px;
    margin: -8px 0 0 -8px;
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
function startSubscription(planType) {
    const hasActiveSubscription = {{ 'true' if current_user.has_subscription else 'false' }};
    const currentPlan = '{{ current_user.subscription_plan or "none" }}';
    
    // Show confirmation for lifetime plan
    if (planType === 'lifetime') {
        let confirmMessage = '🎉 You\'re about to get LIFETIME access to TGFX Trade Lab!\n\n✅ One-time payment of $499\n✅ Never pay again\n✅ All future content included\n✅ VIP community access\n\n';
        
        if (hasActiveSubscription) {
            confirmMessage += '⚠️ This will cancel your current subscription and you\'ll be charged the full lifetime amount.\n\n';
        }
        
        confirmMessage += 'Proceed to checkout?';
        
        if (!confirm(confirmMessage)) {
            return;
        }
    }
    
    // Show loading state
    const button = document.getElementById(planType + '-btn');
    const originalText = button.innerHTML;
    button.classList.add('btn-loading');
    button.innerHTML = '<span class="material-symbols-outlined me-2">hourglass_empty</span>Processing...';
    button.disabled = true;
    
    // Show loading modal
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();
    
    // Determine which endpoint to use based on current subscription status
    let endpoint, requestBody;
    
    if (!hasActiveSubscription) {
        // No subscription - create new checkout session
        endpoint = '/api/create-checkout-session';
        requestBody = { plan_type: planType };
    } else if (planType === 'lifetime') {
        // Lifetime upgrade - special handling
        endpoint = '/api/user/upgrade-to-lifetime';
        requestBody = {};
    } else if (currentPlan === 'monthly' && planType === 'annual') {
        // Monthly to Annual upgrade - use proration
        endpoint = '/api/user/upgrade-to-annual';
        requestBody = {};
    } else {
        // Other plan changes - use change plan endpoint
        endpoint = '/api/user/change-plan';
        requestBody = { plan: planType };
    }
    
    // Make the API call
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.checkout_url) {
                // Redirect to Stripe checkout (for new subscriptions or lifetime)
                window.location.href = data.checkout_url;
            } else {
                // Plan change completed - reload page to show updated status
                loadingModal.hide();
                alert(data.message || 'Subscription updated successfully!');
                window.location.reload();
            }
        } else {
            // Hide loading modal
            loadingModal.hide();
            
            // Show error
            alert('Error: ' + (data.error || 'Failed to process subscription change'));
            
            // Reset button
            button.classList.remove('btn-loading');
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        
        // Hide loading modal
        loadingModal.hide();
        
        // Show error
        alert('Network error. Please try again.');
        
        // Reset button
        button.classList.remove('btn-loading');
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function getCsrfToken() {
    // Get CSRF token from meta tag or cookie
    const token = document.querySelector('meta[name="csrf-token"]');
    return token ? token.getAttribute('content') : '';
}

// Handle page visibility change to reset buttons if user comes back from Stripe
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        // Reset all buttons when page becomes visible
        const buttons = document.querySelectorAll('.btn-loading');
        buttons.forEach(button => {
            button.classList.remove('btn-loading');
            button.disabled = false;
            // You might want to refresh the page to show updated subscription status
        });
    }
});
</script>
{% endblock %}
