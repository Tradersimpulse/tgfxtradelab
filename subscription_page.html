{% extends "base.html" %}

{% block title %}Premium Subscription - TGFX Trade Lab{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="text-center">
            <h1 class="text-gradient-primary mb-3">
                <span class="material-symbols-outlined me-2" style="font-size: 2.5rem;">workspace_premium</span>
                Upgrade to Premium
            </h1>
            <p class="text-muted mb-0 lead">Unlock exclusive trading content and accelerate your learning</p>
        </div>
    </div>
</div>

<!-- Current Status (if user has subscription) -->
{% if current_user.has_subscription %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-success">
            <div class="d-flex align-items-center">
                <span class="material-symbols-outlined me-3" style="font-size: 2rem;">check_circle</span>
                <div>
                    <h5 class="mb-1">You're already a Premium member!</h5>
                    <p class="mb-0">
                        Your subscription is active
                        {% if current_user.subscription_expires %}
                        until {{ current_user.subscription_expires.strftime('%B %d, %Y') }}
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Pricing Cards -->
<div class="row justify-content-center mb-5">
    <!-- Free Plan -->
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100 {% if not current_user.has_subscription %}border-primary{% endif %}">
            <div class="card-header text-center py-4">
                <h3 class="text-white mb-2">Free</h3>
                <div class="display-4 text-gradient-primary mb-2">$0</div>
                <p class="text-muted mb-0">Forever</p>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Access to free video lessons
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Basic progress tracking
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Favorite videos feature
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Community access
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-muted">cancel</span>
                        <span class="text-muted">Premium video content</span>
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-muted">cancel</span>
                        <span class="text-muted">Downloadable resources</span>
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-muted">cancel</span>
                        <span class="text-muted">Priority support</span>
                    </li>
                </ul>
            </div>
            <div class="card-footer text-center">
                {% if not current_user.has_subscription %}
                <span class="badge bg-primary">Current Plan</span>
                {% else %}
                <button class="btn btn-outline-secondary" disabled>Your Free Plan</button>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Premium Plan -->
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100 border-warning position-relative">
            <!-- Popular Badge -->
            <div class="position-absolute top-0 start-50 translate-middle">
                <span class="badge bg-warning text-dark px-3 py-2">Most Popular</span>
            </div>
            
            <div class="card-header text-center py-4 bg-gradient-primary">
                <h3 class="text-white mb-2">Premium</h3>
                <div class="display-4 text-white mb-2">$29</div>
                <p class="text-white mb-0 opacity-75">per month</p>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        <strong>Everything in Free</strong>
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Access to all premium videos
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Downloadable course materials
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Advanced progress analytics
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Priority customer support
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Early access to new content
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Monthly live Q&A sessions
                    </li>
                </ul>
            </div>
            <div class="card-footer text-center">
                {% if current_user.has_subscription %}
                <span class="badge bg-success">Current Plan</span>
                {% else %}
                <button class="btn btn-primary btn-lg w-100" onclick="startSubscription('monthly')">
                    <span class="material-symbols-outlined me-2">credit_card</span>
                    Subscribe Now
                </button>
                <p class="text-muted small mt-2 mb-0">Cancel anytime</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Annual Plan -->
    <div class="col-lg-4 col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header text-center py-4">
                <h3 class="text-white mb-2">Premium Annual</h3>
                <div class="d-flex align-items-center justify-content-center mb-2">
                    <span class="text-muted text-decoration-line-through me-2">$348</span>
                    <div class="display-4 text-gradient-primary">$299</div>
                </div>
                <p class="text-muted mb-1">per year</p>
                <span class="badge bg-success">Save $49</span>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        <strong>Everything in Premium</strong>
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        2 months free (14% savings)
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Exclusive annual member content
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Trading strategy PDFs
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        One-on-one monthly consultation
                    </li>
                    <li class="mb-3">
                        <span class="material-symbols-outlined me-2 text-success">check_circle</span>
                        Priority in live sessions
                    </li>
                </ul>
            </div>
            <div class="card-footer text-center">
                {% if current_user.has_subscription %}
                <button class="btn btn-outline-warning w-100" onclick="upgradeToAnnual()">
                    <span class="material-symbols-outlined me-2">upgrade</span>
                    Upgrade to Annual
                </button>
                {% else %}
                <button class="btn btn-outline-primary btn-lg w-100" onclick="startSubscription('annual')">
                    <span class="material-symbols-outlined me-2">payments</span>
                    Subscribe Annually
                </button>
                <p class="text-muted small mt-2 mb-0">Best value â€¢ Cancel anytime</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Features Comparison -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header text-center">
                <h3 class="text-gradient-primary mb-2">
                    <span class="material-symbols-outlined me-2">compare</span>
                    Feature Comparison
                </h3>
                <p class="text-muted mb-0">See what's included in each plan</p>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th class="text-center">Free</th>
                                <th class="text-center">Premium</th>
                                <th class="text-center">Premium Annual</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Basic Video Lessons</td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                            </tr>
                            <tr>
                                <td>Progress Tracking</td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                            </tr>
                            <tr>
                                <td>Premium Video Content</td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                            </tr>
                            <tr>
                                <td>Downloadable Resources</td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                            </tr>
                            <tr>
                                <td>Priority Support</td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                            </tr>
                            <tr>
                                <td>Monthly Live Q&A</td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                            </tr>
                            <tr>
                                <td>One-on-One Consultation</td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                            </tr>
                            <tr>
                                <td>Exclusive Annual Content</td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-muted">cancel</span></td>
                                <td class="text-center"><span class="material-symbols-outlined text-success">check_circle</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FAQ Section -->
<div class="row mb-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="text-gradient-primary mb-0">
                    <span class="material-symbols-outlined me-2">help</span>
                    Frequently Asked Questions
                </h3>
            </div>
            <div class="card-body">
                <div class="accordion accordion-flush" id="faqAccordion">
                    <div class="accordion-item bg-transparent border-secondary">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-transparent text-white" data-bs-toggle="collapse" data-bs-target="#faq1">
                                Can I cancel my subscription anytime?
                            </button>
                        </h2>
                        <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body text-muted">
                                Yes! You can cancel your subscription at any time. You'll continue to have access to premium content until the end of your current billing period.
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item bg-transparent border-secondary">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-transparent text-white" data-bs-toggle="collapse" data-bs-target="#faq2">
                                What payment methods do you accept?
                            </button>
                        </h2>
                        <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body text-muted">
                                We accept all major credit cards (Visa, MasterCard, American Express) and PayPal through our secure Stripe payment processor.
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item bg-transparent border-secondary">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-transparent text-white" data-bs-toggle="collapse" data-bs-target="#faq3">
                                Is there a money-back guarantee?
                            </button>
                        </h2>
                        <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body text-muted">
                                We offer a 30-day money-back guarantee. If you're not satisfied with your premium subscription, contact us within 30 days for a full refund.
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item bg-transparent border-secondary">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-transparent text-white" data-bs-toggle="collapse" data-bs-target="#faq4">
                                Can I upgrade from monthly to annual?
                            </button>
                        </h2>
                        <div id="faq4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body text-muted">
                                Absolutely! You can upgrade to the annual plan at any time and we'll prorate the billing accordingly.
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item bg-transparent border-secondary">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed bg-transparent text-white" data-bs-toggle="collapse" data-bs-target="#faq5">
                                How often is new content added?
                            </button>
                        </h2>
                        <div id="faq5" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body text-muted">
                                We add new premium content weekly, including advanced trading strategies, market analysis, and exclusive interviews with professional traders.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Trust Indicators -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <span class="material-symbols-outlined text-success mb-2" style="font-size: 2rem;">security</span>
                        <h6 class="text-white">Secure Payments</h6>
                        <p class="text-muted small mb-0">SSL encrypted with Stripe</p>
                    </div>
                    <div class="col-md-3">
                        <span class="material-symbols-outlined text-success mb-2" style="font-size: 2rem;">verified</span>
                        <h6 class="text-white">Money Back Guarantee</h6>
                        <p class="text-muted small mb-0">30-day full refund policy</p>
                    </div>
                    <div class="col-md-3">
                        <span class="material-symbols-outlined text-success mb-2" style="font-size: 2rem;">support</span>
                        <h6 class="text-white">24/7 Support</h6>
                        <p class="text-muted small mb-0">We're here to help anytime</p>
                    </div>
                    <div class="col-md-3">
                        <span class="material-symbols-outlined text-success mb-2" style="font-size: 2rem;">cancel</span>
                        <h6 class="text-white">Cancel Anytime</h6>
                        <p class="text-muted small mb-0">No long-term commitment</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stripe Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark border-primary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-gradient-primary">
                    <span class="material-symbols-outlined me-2">credit_card</span>
                    Subscribe to Premium
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="payment-element">
                    <!-- Stripe Elements will be inserted here -->
                </div>
                <div class="text-center mt-3">
                    <p class="text-muted small mb-0">
                        <span class="material-symbols-outlined me-1" style="font-size: 16px;">lock</span>
                        Your payment information is secure and encrypted
                    </p>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submit-payment">
                    <span class="material-symbols-outlined me-2">payment</span>
                    Complete Payment
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe('{{ stripe_key }}');
let elements;
let selectedPlan = null;

function startSubscription(planType) {
    selectedPlan = planType;
    
    // Show payment modal
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
    
    // Initialize Stripe Elements
    initializeStripeElements();
}

function upgradeToAnnual() {
    // Handle upgrade logic
    showToast('Upgrade feature coming soon!', 'info');
}

async function initializeStripeElements() {
    // This would normally create a payment intent on your server
    // For demo purposes, we'll just show the form
    
    try {
        // Create elements instance
        elements = stripe.elements({
            appearance: {
                theme: 'night',
                variables: {
                    colorPrimary: '#10B981',
                    colorBackground: '#1a1a1a',
                    colorText: '#ffffff',
                    colorDanger: '#EF4444',
                    fontFamily: 'Inter, sans-serif',
                    borderRadius: '12px'
                }
            }
        });

        // Create and mount the payment element
        const paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');
        
    } catch (error) {
        console.error('Error initializing Stripe:', error);
        showToast('Error loading payment form', 'error');
    }
}

document.getElementById('submit-payment').addEventListener('click', async function() {
    if (!elements) {
        showToast('Payment form not loaded', 'error');
        return;
    }
    
    // Show loading state
    this.disabled = true;
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
    
    try {
        // In a real implementation, you would:
        // 1. Create a payment intent on your server
        // 2. Confirm the payment with Stripe
        // 3. Update the user's subscription status
        
        // For demo purposes, we'll simulate success
        setTimeout(() => {
            showToast('Subscription activated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
            
            // Reload page to show updated subscription status
            setTimeout(() => location.reload(), 2000);
        }, 2000);
        
    } catch (error) {
        console.error('Payment error:', error);
        showToast('Payment failed. Please try again.', 'error');
        
        // Reset button
        this.disabled = false;
        this.innerHTML = '<span class="material-symbols-outlined me-2">payment</span>Complete Payment';
    }
});

// Add smooth animations
document.addEventListener('DOMContentLoaded', function() {
    // Animate pricing cards
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        
        setTimeout(() => {
            card.style.transition = 'all 0.6s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});

// Handle accordion styling
document.querySelectorAll('.accordion-button').forEach(button => {
    button.addEventListener('click', function() {
        // Custom styling for dark theme
        setTimeout(() => {
            const isExpanded = !this.classList.contains('collapsed');
            if (isExpanded) {
                this.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
            } else {
                this.style.backgroundColor = 'transparent';
            }
        }, 150);
    });
});
</script>
{% endblock %}